{% extends "base.html" %}

{% block title %}–ú–µ–Ω–µ–¥–∂–µ—Ä—ã - OSAGAMING CRM{% endblock %}

{% block styles %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .managers-list {
        display: grid;
        gap: 1rem;
    }

    .manager-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .manager-info {
        flex: 1;
    }

    .manager-name {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .manager-email {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .manager-status {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .manager-status.active {
        background: #dcfce7;
        color: #166534;
    }

    .manager-status.inactive {
        background: #fef2f2;
        color: #991b1b;
    }

    .manager-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: calc(var(--radius));
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-hover, #2563eb);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text);
    }

    .btn-secondary:hover {
        background: var(--muted-hover, #e5e7eb);
    }

    .btn-danger {
        background: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
        transform: translateY(-1px);
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) + 4px);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        color: var(--text-muted);
    }

    .modal-close:hover {
        background: var(--bg-secondary);
        color: var(--text);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.375rem;
        color: var(--text);
    }

    .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: calc(var(--radius));
        background: var(--card);
        color: var(--text);
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-input.error {
        border-color: #dc2626;
    }

    .form-error {
        color: #dc2626;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    .permissions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .permission-group {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: calc(var(--radius));
    }

    .permission-group-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    .permission-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .permission-checkbox {
        width: 16px;
        height: 16px;
    }

    .permission-label {
        font-size: 0.8125rem;
        color: var(--text);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text);
    }

    .manager-role {
        margin-top: 0.5rem;
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .role-manager {
        background: #e0f2fe;
        color: #0277bd;
    }

    .role-admin {
        background: #fff3e0;
        color: #ef6c00;
    }

    .role-super_admin {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        color: #2e7d32;
    }

    .temp-password-info {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: calc(var(--radius));
        font-size: 0.875rem;
    }

    .temp-password-code {
        background: #374151;
        color: #f9fafb;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-weight: 600;
        margin: 0 0.25rem;
        user-select: all;
    }

    .password-warning {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fef2f2;
        border: 1px solid #f87171;
        border-radius: calc(var(--radius));
        color: #dc2626;
        font-size: 0.8125rem;
    }

    .btn-info {
        background: #0ea5e9;
        color: white;
    }

    .btn-info:hover {
        background: #0284c7;
        transform: translateY(-1px);
    }

    .logs-container {
        max-height: 60vh;
        overflow-y: auto;
        padding: 1rem 0;
    }

    .log-entry {
        display: flex;
        gap: 1rem;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: calc(var(--radius));
        margin-bottom: 0.5rem;
        background: var(--card);
    }

    .log-time {
        font-size: 0.8125rem;
        color: var(--text-muted);
        min-width: 140px;
    }

    .log-content {
        flex: 1;
    }

    .log-action {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .log-description {
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .log-empty {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeOut {
        to {
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
    <div style="display: flex; gap: 0.75rem;">
        <button class="btn btn-primary" onclick="openManagerModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>
        <button class="btn btn-secondary" onclick="loadManagers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
</div>

<div id="managers-container" class="managers-list">
    <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ -->
<div id="manager-modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modal-title" class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <button class="modal-close" onclick="closeManagerModal()">&times;</button>
        </div>

        <form id="manager-form" onsubmit="saveManager(event)">
            <input type="hidden" id="manager-id" name="id">

            <div class="form-group">
                <label for="manager-username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                <input type="text" id="manager-username" name="username" class="form-input" required>
                <div class="form-error" id="username-error"></div>
            </div>

            <div class="form-group">
                <label for="manager-email" class="form-label">Email *</label>
                <input type="email" id="manager-email" name="email" class="form-input" required>
                <div class="form-error" id="email-error"></div>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="manager-first-name" class="form-label">–ò–º—è</label>
                    <input type="text" id="manager-first-name" name="first_name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    <div class="form-help">–ò–º—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
                </div>
                <div class="form-group">
                    <label for="manager-last-name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="manager-last-name" name="last_name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                    <div class="form-help">–§–∞–º–∏–ª–∏—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –∏–º–µ–Ω–µ–º</div>
                </div>
            </div>

            <div class="form-group" id="password-group">
                <label for="manager-password" class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                <input type="password" id="manager-password" name="password" class="form-input" required>
                <div class="form-error" id="password-error"></div>
            </div>

            <div class="form-group">
                <label for="manager-salary" class="form-label">–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                <input type="number" id="manager-salary" name="salary" class="form-input" min="0" step="1000">
            </div>

            <div class="form-group" id="role-group">
                <label for="manager-role" class="form-label">–†–æ–ª—å</label>
                <select id="manager-role" name="role" class="form-input">
                    <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="manager-active" name="is_active" checked>
                    –ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω
                </label>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeManagerModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ -->
<div id="logs-modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 id="logs-modal-title" class="modal-title">–õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</h2>
            <button class="modal-close" onclick="closeLogsModal()">&times;</button>
        </div>

        <div id="logs-container" class="logs-container">
            <!-- –õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
        </div>

        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeLogsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
    let currentManagers = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    async function loadManagers() {
        try {
            const response = await fetch('/api/managers/list');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            currentManagers = await response.json();
            renderManagers();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤', 'error');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    function renderManagers() {
            const container = document.getElementById('managers-container');

        if (currentManagers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div class="empty-state-title">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</div>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                </div>
            `;
                return;
            }
            
        container.innerHTML = currentManagers.map(manager => `
                <div class="manager-card">
                    <div class="manager-info">
                    <div class="manager-name">${escapeHtml(manager.username)}</div>
                    <div class="manager-email">${escapeHtml(manager.email || 'Email –Ω–µ —É–∫–∞–∑–∞–Ω')}</div>
                    <div class="manager-status ${manager.is_active ? 'active' : 'inactive'}">
                        ${manager.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                    </div>
                    <div class="manager-role">
                        <span class="role-badge role-${manager.role}">
                            ${getRoleIcon(manager.role)} ${getRoleText(manager.role)}
                        </span>
                    </div>
                    ${manager.temp_password ? `
                        <div class="temp-password-info">
                            <strong>üîê –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</strong>
                            <code class="temp-password-code">${escapeHtml(manager.temp_password)}</code>
                            <small>(—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É)</small>
                        </div>
                    ` : ''}
                    ${!manager.password_changed && !manager.temp_password ? `
                        <div class="password-warning">
                            ‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ
                        </div>
                    ` : ''}
                    </div>
                    <div class="manager-actions">
                    <button class="btn btn-secondary" onclick="editManager(${manager.id})">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-info" onclick="resetUserPassword(${manager.id}, '${escapeHtml(manager.username)}')" title="–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                        üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                    <button class="btn btn-info" onclick="viewManagerLogs(${manager.id}, '${escapeHtml(manager.username)}')">
                        üìä –õ–æ–≥–∏
                    </button>
                    <button class="btn btn-danger" onclick="deleteManager(${manager.id}, '${escapeHtml(manager.username)}')" title="–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        `).join('');
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    function openManagerModal(managerId = null) {
        const modal = document.getElementById('manager-modal');
        const form = document.getElementById('manager-form');
        const title = document.getElementById('modal-title');
        const roleGroup = document.getElementById('role-group');

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        form.reset();
        clearFormErrors();

        if (managerId) {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            const manager = currentManagers.find(m => m.id === managerId);
            if (manager) {
                document.getElementById('manager-id').value = manager.id;
                document.getElementById('manager-username').value = manager.username;
                document.getElementById('manager-email').value = manager.email;
                document.getElementById('manager-first-name').value = manager.first_name || '';
                document.getElementById('manager-last-name').value = manager.last_name || '';
                document.getElementById('manager-salary').value = manager.salary || '';
                document.getElementById('manager-active').checked = manager.is_active;
                document.getElementById('manager-role').value = manager.role || 'manager';

                title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                roleGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ä–æ–ª–∏
                // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                document.getElementById('password-group').querySelector('input').required = false;
                document.getElementById('password-group').querySelector('label').textContent = '–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)';
            }
            } else {
                // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                document.getElementById('manager-id').value = '';
                document.getElementById('manager-first-name').value = '';
                document.getElementById('manager-last-name').value = '';
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                roleGroup.style.display = 'block';
                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                document.getElementById('password-group').querySelector('input').required = true;
                document.getElementById('password-group').querySelector('label').textContent = '–ü–∞—Ä–æ–ª—å *';
            }

        modal.style.display = 'flex';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeManagerModal() {
        const modal = document.getElementById('manager-modal');
        modal.style.display = 'none';
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function viewManagerLogs(managerId, managerName) {
        const modal = document.getElementById('logs-modal');
        const title = document.getElementById('logs-modal-title');
        const container = document.getElementById('logs-container');

        title.textContent = `–õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π: ${managerName}`;
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>';

        modal.style.display = 'flex';

        try {
            const response = await fetch(`/api/user-activity-logs?user_id=${managerId}&limit=50`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const logs = await response.json();
            renderLogs(logs);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
            container.innerHTML = '<div class="log-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</div>';
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–æ–≥–æ–≤
    function renderLogs(logs) {
        const container = document.getElementById('logs-container');

        if (!logs || logs.length === 0) {
            container.innerHTML = '<div class="log-empty">–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π</div>';
            return;
        }

        container.innerHTML = logs.map(log => {
            const time = new Date(log.created_at).toLocaleString('ru-RU');
            return `
                <div class="log-entry">
                    <div class="log-time">${time}</div>
                    <div class="log-content">
                        <div class="log-action">${escapeHtml(log.action_type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ')}</div>
                        <div class="log-description">${escapeHtml(log.action_description || '')}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤
    function closeLogsModal() {
        const modal = document.getElementById('logs-modal');
        modal.style.display = 'none';
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    async function saveManager(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const managerData = {
            username: formData.get('username').trim(),
            email: formData.get('email').trim(),
            first_name: formData.get('first_name')?.trim() || null,
            last_name: formData.get('last_name')?.trim() || null,
            salary: parseFloat(formData.get('salary')) || 0,
            role: formData.get('role') || 'manager',
            is_active: formData.get('is_active') === 'on'
        };

        const managerId = formData.get('id');
        const isEdit = !!managerId;

        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!managerData.username) {
            showFormError('username', '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
            return;
        }
        if (!managerData.email) {
            showFormError('email', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            return;
        }
        if (!isEdit) {
            const password = formData.get('password');
            if (!password || password.length < 6) {
                showFormError('password', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            managerData.password = password;
        } else {
            // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
            const password = formData.get('password');
            if (password && password.length >= 6) {
                managerData.password = password;
            }
        }

        const saveBtn = document.getElementById('save-btn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            const url = isEdit ? `/api/managers/${managerId}` : '/api/managers';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(managerData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }

            const result = await response.json();

            if (!isEdit && result.temp_password) {
                showNotification(
                    `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω! –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ${result.temp_password}`,
                    'success'
                );
                // –ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(result.temp_password).catch(() => {});
            } else {
                showNotification(
                    isEdit ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω',
                    'success'
                );
            }

            closeManagerModal();
            await loadManagers();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showNotification(error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    function editManager(managerId) {
        openManagerModal(managerId);
    }

    // –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function resetUserPassword(managerId, managerName) {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        const manager = currentManagers.find(m => m.id === managerId);
        const roleText = manager && manager.role === 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É' : '–º–µ–Ω–µ–¥–∂–µ—Ä—É';
        
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å ${roleText} "${managerName}"?\n\n–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/managers/${managerId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const passwordMessage = `–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${managerName}"!\n\n–ù–æ–≤—ã–π –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:\n${result.temp_password}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.`;
            
            // –ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            navigator.clipboard.writeText(result.temp_password).then(() => {
                showNotification('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(() => {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –≤ alert –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            alert(passwordMessage);
            
            showNotification(`–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω –¥–ª—è ${roleText} "${managerName}"`, 'success');
            await loadManagers();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:', error);
            showNotification(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è', 'error');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    async function deleteManager(managerId, managerName) {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        const manager = currentManagers.find(m => m.id === managerId);
        const roleText = manager && manager.role === 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–µ–Ω–µ–¥–∂–µ—Ä–∞';
        
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${roleText} "${managerName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/managers/${managerId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }

            showNotification(result.message || `${roleText.charAt(0).toUpperCase() + roleText.slice(1)} —É–¥–∞–ª–µ–Ω`, 'success');
            await loadManagers();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
            showNotification(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º
    function showFormError(fieldName, message) {
        const errorElement = document.getElementById(`${fieldName}-error`);
        const inputElement = document.getElementById(`manager-${fieldName}`);

        if (errorElement) {
            errorElement.textContent = message;
        }
        if (inputElement) {
            inputElement.classList.add('error');
        }
    }

    function clearFormErrors() {
        const errorElements = document.querySelectorAll('.form-error');
        const inputElements = document.querySelectorAll('.form-input');

        errorElements.forEach(el => el.textContent = '');
        inputElements.forEach(el => el.classList.remove('error'));
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getRoleIcon(role) {
        const icons = {
            'manager': 'üë§',
            'admin': 'üë®‚Äçüíº',
            'super_admin': 'üëë'
        };
        return icons[role] || '‚ùì';
    }

    function getRoleText(role) {
        const texts = {
            'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'super_admin': '–°—É–ø–µ—Ä –ê–¥–º–∏–Ω'
        };
        return texts[role] || role;
    }

    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
    loadManagers();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('manager-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeManagerModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('logs-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLogsModal();
            }
        });
    });
</script>
{% endblock %}

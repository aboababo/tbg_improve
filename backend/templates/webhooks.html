{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Webhooks - OSAGAMING CRM{% endblock %}

{% block styles %}
<style>
    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .webhook-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .webhook-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .webhook-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .webhook-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .webhook-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .webhook-status.active {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .webhook-status.inactive {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .webhook-info {
        margin-bottom: 1rem;
    }

    .webhook-info-item {
        display: flex;
        margin-bottom: 0.75rem;
        align-items: flex-start;
    }

    .webhook-info-label {
        font-weight: 600;
        color: var(--text-muted);
        min-width: 120px;
        font-size: 0.875rem;
    }

    .webhook-info-value {
        color: var(--text-primary);
        word-break: break-all;
        flex: 1;
    }

    .webhook-types {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .webhook-type-badge {
        padding: 0.25rem 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) - 2px);
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .webhook-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .btn-danger {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--bg-tertiary);
        border-color: var(--primary);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--bg);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .form-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .form-checkbox label {
        cursor: pointer;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .form-help {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .notification {
        padding: 1rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .notification.success {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .notification.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .notification.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="webhook-container">
    <h1 class="page-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Webhooks Avito</h1>

    <div id="notification-container"></div>

    <div class="webhook-card">
        <h2 class="webhook-title" style="margin-bottom: 1rem;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ Webhook</h2>
        
        <div class="notification info" style="margin-bottom: 1.5rem;">
            <span>‚ÑπÔ∏è</span>
            <div>
                <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
                1. –£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å HTTPS)<br>
                2. Avito –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —á–∞—Ç–∞—Ö<br>
                3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            </div>
        </div>
        
        <form id="webhook-form">
            <div class="form-group">
                <label class="form-label" for="webhook-url">URL Webhook *</label>
                <input 
                    type="url" 
                    id="webhook-url" 
                    class="form-input" 
                    placeholder="https://–≤–∞—à-–¥–æ–º–µ–Ω.com/webhook/avito"
                    required
                >
                <div class="form-help">
                    <strong>–ü—Ä–∏–º–µ—Ä:</strong> https://crm.example.com/webhook/avito<br>
                    ‚ö†Ô∏è URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å <strong>https://</strong> (–Ω–µ http://)<br>
                    ‚ö†Ô∏è URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–Ω–µ localhost)
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π *</label>
                <div class="form-checkbox-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="type-message" name="types" value="message" checked>
                        <label for="type-message">message - —Å–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è)</label>
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="type-chat" name="types" value="chat" checked>
                        <label for="type-chat">chat - —Å–æ–±—ã—Ç–∏—è —á–∞—Ç–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∞—Ä—Ö–∏–≤–∞—Ü–∏—è)</label>
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="type-user" name="types" value="user">
                        <label for="type-user">user - —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                    </div>
                </div>
                <div class="form-help">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è webhook</div>
            </div>

            <div class="webhook-actions">
                <button type="submit" class="btn btn-primary">
                    <span>üîó</span>
                    <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Webhook</span>
                </button>
            </div>
        </form>
    </div>

    <div id="webhook-info-container">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook...</div>
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook -->
    <div class="webhook-card">
        <h2 class="webhook-title" style="margin-bottom: 1rem;">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Webhook</h2>
        <div class="webhook-info">
            <div class="webhook-info-item">
                <span class="webhook-info-label">URL –¥–ª—è —Ç–µ—Å—Ç–∞:</span>
                <span class="webhook-info-value">https://osagaming.store/webhook/avito</span>
            </div>
        </div>
        <div class="webhook-actions">
            <button class="btn btn-secondary" onclick="testWebhook()">
                <span>üîç</span>
                <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</span>
            </button>
            <button class="btn btn-secondary" onclick="sendTestWebhook()">
                <span>üì§</span>
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π webhook</span>
            </button>
        </div>
        <div id="test-results" style="margin-top: 1rem;"></div>
    </div>
</div>

<script>
    let currentWebhook = null;
    let selectedShopId = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
    async function loadShops() {
        try {
            const response = await fetch('/api/shops', {
                credentials: 'include'
            });
            if (response.ok) {
                const shops = await response.json();
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (shops.length > 0) {
                    selectedShopId = shops[0].id;
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º webhook
    async function loadWebhookInfo() {
        const container = document.getElementById('webhook-info-container');
        container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook...</div>';

        try {
            const response = await fetch('/api/admin/webhooks', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                currentWebhook = data.webhook;

                if (currentWebhook && currentWebhook.url) {
                    renderWebhookInfo(currentWebhook);
                } else {
                    container.innerHTML = `
                        <div class="webhook-card">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîó</div>
                                <h3>Webhook –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</h3>
                                <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ webhook, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç Avito</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                const error = await response.json().catch(() => ({}));
                container.innerHTML = `
                    <div class="webhook-card">
                        <div class="notification error">
                            <span>‚ùå</span>
                            <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            container.innerHTML = `
                <div class="webhook-card">
                    <div class="notification error">
                        <span>‚ùå</span>
                        <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</span>
                    </div>
                </div>
            `;
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook
    function renderWebhookInfo(webhook) {
        const container = document.getElementById('webhook-info-container');
        const isActive = webhook.active !== false;
        const types = webhook.types || [];

        container.innerHTML = `
            <div class="webhook-card">
                <div class="webhook-header">
                    <h2 class="webhook-title">–¢–µ–∫—É—â–∏–π Webhook</h2>
                    <div class="webhook-status ${isActive ? 'active' : 'inactive'}">
                        <span>${isActive ? '‚óè' : '‚óã'}</span>
                        <span>${isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
                    </div>
                </div>

                <div class="webhook-info">
                    <div class="webhook-info-item">
                        <span class="webhook-info-label">URL:</span>
                        <span class="webhook-info-value">${escapeHtml(webhook.url)}</span>
                    </div>
                    ${webhook.id ? `
                    <div class="webhook-info-item">
                        <span class="webhook-info-label">ID:</span>
                        <span class="webhook-info-value">${escapeHtml(webhook.id)}</span>
                    </div>
                    ` : ''}
                    <div class="webhook-info-item">
                        <span class="webhook-info-label">–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:</span>
                        <div class="webhook-info-value">
                            <div class="webhook-types">
                                ${types.map(type => `<span class="webhook-type-badge">${escapeHtml(type)}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    ${webhook.created_at ? `
                    <div class="webhook-info-item">
                        <span class="webhook-info-label">–°–æ–∑–¥–∞–Ω:</span>
                        <span class="webhook-info-value">${formatDate(webhook.created_at)}</span>
                    </div>
                    ` : ''}
                    ${webhook.updated_at ? `
                    <div class="webhook-info-item">
                        <span class="webhook-info-label">–û–±–Ω–æ–≤–ª–µ–Ω:</span>
                        <span class="webhook-info-value">${formatDate(webhook.updated_at)}</span>
                    </div>
                    ` : ''}
                </div>

                <div class="webhook-actions">
                    <button class="btn btn-secondary" onclick="editWebhook()">
                        <span>‚úèÔ∏è</span>
                        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteWebhook()">
                        <span>üóëÔ∏è</span>
                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                    </button>
                </div>
            </div>
        `;
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ webhook
    document.getElementById('webhook-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const url = document.getElementById('webhook-url').value.trim();
        const checkboxes = document.querySelectorAll('input[name="types"]:checked');
        const types = Array.from(checkboxes).map(cb => cb.value);

        if (!url) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ URL webhook', 'error');
            return;
        }

        if (types.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è', 'error');
            return;
        }

        if (!url.startsWith('https://')) {
            showNotification('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://', 'error');
            return;
        }

        try {
            showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook...', 'info');

            const response = await fetch('/api/admin/webhooks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    url: url,
                    types: types
                })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
                document.getElementById('webhook-form').reset();
                document.getElementById('type-message').checked = true;
                document.getElementById('type-chat').checked = true;
                await loadWebhookInfo();
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        } catch (error) {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
    });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook
    async function editWebhook() {
        if (!currentWebhook) return;

        const url = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π URL:', currentWebhook.url);
        if (!url) return;

        if (!url.startsWith('https://')) {
            showNotification('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://', 'error');
            return;
        }

        const types = currentWebhook.types || ['message', 'chat'];
        const message = `–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é): message, chat, user\n–¢–µ–∫—É—â–∏–µ: ${types.join(', ')}`;
        const typesInput = prompt(message, types.join(', '));
        
        let newTypes = types;
        if (typesInput) {
            newTypes = typesInput.split(',').map(t => t.trim()).filter(t => t);
        }

        try {
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ webhook...', 'info');

            const response = await fetch('/api/admin/webhooks', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    url: url,
                    types: newTypes
                })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadWebhookInfo();
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        } catch (error) {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ webhook
    async function deleteWebhook() {
        if (!currentWebhook) return;

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å webhook?')) {
            return;
        }

        try {
            showNotification('–£–¥–∞–ª–µ–Ω–∏–µ webhook...', 'info');

            const response = await fetch('/api/admin/webhooks', {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                currentWebhook = null;
                await loadWebhookInfo();
            } else {
                showNotification(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        } catch (error) {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        }
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
        `;
        container.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        } catch {
            return dateString;
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL webhook
    function getWebhookUrl() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–µ–Ω osagaming.store
        const webhookUrl = 'https://osagaming.store/webhook/avito';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const urlInput = document.getElementById('webhook-url');
        if (urlInput && !urlInput.value) {
            urlInput.value = webhookUrl;
            urlInput.placeholder = webhookUrl;
        }
        
        return webhookUrl;
    }

    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ webhook
    async function testWebhook() {
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<div class="loading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...</div>';

        try {
            const response = await fetch('https://osagaming.store/webhook/avito', {
                method: 'GET',
                credentials: 'include'
            });

            const data = await response.json().catch(() => ({ message: response.statusText }));

            if (response.ok) {
                resultsDiv.innerHTML = `
                    <div class="notification success">
                        <span>‚úÖ</span>
                        <div>
                            <strong>Webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω!</strong><br>
                            –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}<br>
                            –û—Ç–≤–µ—Ç: ${JSON.stringify(data, null, 2)}
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="notification error">
                        <span>‚ùå</span>
                        <div>
                            <strong>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</strong><br>
                            –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}<br>
                            ${data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="notification error">
                    <span>‚ùå</span>
                    <div>
                        <strong>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</strong><br>
                        ${error.message}<br>
                        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω osagaming.store –¥–æ—Å—Ç—É–ø–µ–Ω
                    </div>
                </div>
            `;
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook
    async function sendTestWebhook() {
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<div class="loading">–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook...</div>';

        const testData = {
            id: 'test_webhook_' + Date.now(),
            version: '3',
            timestamp: new Date().toISOString(),
            payload: {
                type: 'message',
                value: {
                    id: 'test_message_123',
                    chat_id: 'test_chat_123',
                    user_id: '12345',
                    content: {
                        text: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook'
                    },
                    created_at: new Date().toISOString()
                }
            }
        };

        try {
            const response = await fetch('https://osagaming.store/webhook/avito', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(testData)
            });

            const data = await response.json().catch(() => ({ message: response.statusText }));

            if (response.ok) {
                resultsDiv.innerHTML = `
                    <div class="notification success">
                        <span>‚úÖ</span>
                        <div>
                            <strong>–¢–µ—Å—Ç–æ–≤—ã–π webhook —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!</strong><br>
                            –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}<br>
                            <details style="margin-top: 0.5rem;">
                                <summary style="cursor: pointer; font-weight: 600;">–î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞</summary>
                                <pre style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: var(--radius); overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="notification error">
                        <span>‚ùå</span>
                        <div>
                            <strong>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook</strong><br>
                            –°—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}<br>
                            ${data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="notification error">
                    <span>‚ùå</span>
                    <div>
                        <strong>–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</strong><br>
                        ${error.message}<br>
                        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
                    </div>
                </div>
            `;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    loadShops();
    getWebhookUrl(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º URL
    loadWebhookInfo();
</script>
{% endblock %}

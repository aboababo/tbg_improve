{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - OSAGAMING CRM{% endblock %}

{% block early_scripts %}
    <script>
        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ HEAD, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –î–û —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ body
        (function() {
            // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            window.escapeHtml = escapeHtml;
            window.showCreateShopModal = function() {
                console.log('[GLOBAL] showCreateShopModal –≤—ã–∑–≤–∞–Ω–∞');
                try {
                    const modal = document.getElementById('create-shop-modal');
                    console.log('[GLOBAL] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:', modal);
                    if (!modal) {
                        console.error('[ERROR] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).');
                        return;
                    }
                    console.log('[GLOBAL] –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
                    modal.style.display = 'flex';
                    modal.style.zIndex = '99999';
                    modal.classList.add('show');
                    
                    setTimeout(() => {
                        const nameInput = document.getElementById('new-shop-name');
                        if (nameInput) {
                            nameInput.focus();
                        }
                    }, 100);
                } catch (e) {
                    console.error('[ERROR] –û—à–∏–±–∫–∞ –≤ showCreateShopModal:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞: ' + e.message);
                }
            };
            
            window.closeCreateShopModal = function() {
                console.log('[GLOBAL] closeCreateShopModal –≤—ã–∑–≤–∞–Ω–∞');
                const modal = document.getElementById('create-shop-modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                }
                const fields = ['new-shop-name', 'new-shop-url', 'new-shop-api-key', 'new-shop-client-id', 'new-shop-client-secret', 'new-shop-user-id'];
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                const activeCheckbox = document.getElementById('new-shop-active');
                if (activeCheckbox) activeCheckbox.checked = true;
                const statusEl = document.getElementById('create-shop-status');
                if (statusEl) statusEl.textContent = '';
            };
            
            window.toggleSecret = function(inputId, buttonEl) {
                const input = document.getElementById(inputId);
                if (!input) return;
                if (input.type === 'password') {
                    input.type = 'text';
                    buttonEl.textContent = 'üôà';
                } else {
                    input.type = 'password';
                    buttonEl.textContent = 'üëÅ';
                }
            };
            
            window.showEditShopModal = function(shop) {
                console.log('[GLOBAL] showEditShopModal –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞:', shop);
                try {
                    const modal = document.getElementById('edit-shop-modal');
                    console.log('[GLOBAL] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', modal);
                    if (!modal) {
                        console.error('[ERROR] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).');
                        return;
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –º–∞–≥–∞–∑–∏–Ω–∞
                    if (shop) {
                        document.getElementById('edit-shop-id').value = shop.id || '';
                        document.getElementById('edit-shop-name').value = shop.name || '';
                        document.getElementById('edit-shop-url').value = shop.shop_url || '';
                        document.getElementById('edit-shop-api-key').value = shop.api_key || '';
                        document.getElementById('edit-shop-active').checked = shop.is_active !== false;
                        document.getElementById('edit-shop-client-id').value = shop.client_id || '';
                        document.getElementById('edit-shop-client-secret').value = shop.client_secret || '';
                        document.getElementById('edit-shop-user-id').value = shop.user_id || '';
                    }
                    
                    console.log('[GLOBAL] –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                    modal.style.display = 'flex';
                    modal.style.zIndex = '99999';
                    modal.classList.add('show');
                    
                    setTimeout(() => {
                        const nameInput = document.getElementById('edit-shop-name');
                        if (nameInput) {
                            nameInput.focus();
                        }
                    }, 100);
                } catch (e) {
                    console.error('[ERROR] –û—à–∏–±–∫–∞ –≤ showEditShopModal:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + e.message);
                }
            };
            
            window.closeEditShopModal = function() {
                console.log('[GLOBAL] closeEditShopModal –≤—ã–∑–≤–∞–Ω–∞');
                const modal = document.getElementById('edit-shop-modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                }
                const statusEl = document.getElementById('edit-shop-status');
                if (statusEl) statusEl.textContent = '';
            };
            
            window.createShop = async function() {
                console.log('[CREATE SHOP] –§—É–Ω–∫—Ü–∏—è createShop –≤—ã–∑–≤–∞–Ω–∞');
                console.log('[CREATE SHOP] –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã...');
                
                const nameEl = document.getElementById('new-shop-name');
                const shopUrlEl = document.getElementById('new-shop-url');
                const apiKeyEl = document.getElementById('new-shop-api-key');
                const isActiveEl = document.getElementById('new-shop-active');
                const clientIdEl = document.getElementById('new-shop-client-id');
                const clientSecretEl = document.getElementById('new-shop-client-secret');
                const userIdEl = document.getElementById('new-shop-user-id');
                const statusEl = document.getElementById('create-shop-status');
                
                if (!nameEl || !shopUrlEl || !statusEl) {
                    console.error('[CREATE SHOP] –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã');
                    console.error('[CREATE SHOP] nameEl:', nameEl);
                    console.error('[CREATE SHOP] shopUrlEl:', shopUrlEl);
                    console.error('[CREATE SHOP] statusEl:', statusEl);
                    alert('–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
                    return;
                }
                
                const name = nameEl.value.trim();
                const shopUrl = shopUrlEl.value.trim();
                const apiKey = apiKeyEl ? apiKeyEl.value.trim() : '';
                const isActive = isActiveEl ? isActiveEl.checked : true;
                const clientId = clientIdEl ? clientIdEl.value.trim() : '';
                const clientSecret = clientSecretEl ? clientSecretEl.value.trim() : '';
                const userId = userIdEl ? userIdEl.value.trim() : '';

                console.log('[CREATE SHOP] –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:');
                console.log('[CREATE SHOP]   name:', name);
                console.log('[CREATE SHOP]   shopUrl:', shopUrl);
                console.log('[CREATE SHOP]   apiKey:', apiKey ? '***' : '(–ø—É—Å—Ç–æ)');
                console.log('[CREATE SHOP]   isActive:', isActive);
                console.log('[CREATE SHOP]   clientId:', clientId ? '***' : '(–ø—É—Å—Ç–æ)');
                console.log('[CREATE SHOP]   clientSecret:', clientSecret ? '***' : '(–ø—É—Å—Ç–æ)');
                console.log('[CREATE SHOP]   userId:', userId ? '***' : '(–ø—É—Å—Ç–æ)');

                if (!name || !shopUrl) {
                    console.warn('[CREATE SHOP] –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞: –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                    statusEl.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ URL –º–∞–≥–∞–∑–∏–Ω–∞';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                if (!shopUrl.startsWith('http://') && !shopUrl.startsWith('https://')) {
                    statusEl.textContent = '‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∫–ª—é—á–∏, —Ç–æ –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                const hasKeys = clientId || clientSecret || userId;
                if (hasKeys && (!clientId || !clientSecret || !userId)) {
                    statusEl.textContent = '‚ùå –ï—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –∫–ª—é—á–∏, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è (Client ID, Client Secret, User ID)';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                statusEl.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞...';
                statusEl.style.color = 'var(--text-muted)';

                try {
                    console.log('[CREATE SHOP] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞...');
                    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –º–∞–≥–∞–∑–∏–Ω
                    const resp = await fetch('/api/shops', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            name: name,
                            shop_url: shopUrl,
                            api_key: apiKey || null,
                            is_active: isActive
                        })
                    });

                    const contentType = resp.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await resp.text();
                        console.error('[CREATE SHOP] –ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', text.substring(0, 200));
                        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç';
                        statusEl.style.color = 'var(--error, #ef4444)';
                        return;
                    }

                    const result = await resp.json();
                    console.log('[CREATE SHOP] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                    console.log('[CREATE SHOP] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', resp.status, resp.ok);
                    
                    if (resp.ok && result.success) {
                        const shopId = result.id;
                        console.log('[CREATE SHOP] –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ, ID:', shopId);
                        
                        // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∫–ª—é—á–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö —Å—Ä–∞–∑—É
                        if (hasKeys && clientId && clientSecret && userId) {
                            statusEl.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π...';
                            
                            const credResp = await fetch(`/api/shops/${shopId}/credentials`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    client_id: clientId,
                                    client_secret: clientSecret,
                                    user_id: userId
                                })
                            });
                            
                            if (!credResp.ok) {
                                const credResult = await credResp.json().catch(() => ({}));
                                statusEl.textContent = `‚úÖ –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏: ${credResult.error || '–û—à–∏–±–∫–∞'}`;
                                statusEl.style.color = 'var(--warning, #f59e0b)';
                            } else {
                                statusEl.textContent = '‚úÖ –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞–Ω –∏ –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                                statusEl.style.color = 'var(--success, #10b981)';
                            }
                        } else {
                            statusEl.textContent = '‚úÖ –ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!';
                            statusEl.style.color = 'var(--success, #10b981)';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
                        console.log('[CREATE SHOP] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤...');
                        if (typeof window.loadAvitoShops === 'function') {
                            console.log('[CREATE SHOP] –í—ã–∑—ã–≤–∞–µ–º loadAvitoShops()...');
                            try {
                                await window.loadAvitoShops();
                                console.log('[CREATE SHOP] loadAvitoShops() –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                            } catch (err) {
                                console.error('[CREATE SHOP] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤:', err);
                            }
                        } else {
                            console.warn('[CREATE SHOP] –§—É–Ω–∫—Ü–∏—è loadAvitoShops –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                        }
                        
                        // –í—ã–±–∏—Ä–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω
                        setTimeout(() => {
                            console.log('[CREATE SHOP] –í—ã–±–æ—Ä —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ...');
                            const select = document.getElementById('avito-shop-select');
                            if (select && shopId) {
                                select.value = shopId;
                                if (typeof window.populateAvitoFields === 'function') {
                                    window.populateAvitoFields(shopId);
                                }
                            }
                            console.log('[CREATE SHOP] –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
                            if (typeof window.closeCreateShopModal === 'function') {
                                window.closeCreateShopModal();
                            } else {
                                console.warn('[CREATE SHOP] –§—É–Ω–∫—Ü–∏—è closeCreateShopModal –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            }
                        }, 1500);
                    } else {
                        const errorMsg = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω';
                        console.error('[CREATE SHOP] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞:', errorMsg, result);
                        statusEl.textContent = `‚ùå ${errorMsg}`;
                        statusEl.style.color = 'var(--error, #ef4444)';
                    }
                } catch (e) {
                    console.error('[CREATE SHOP] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', e);
                    console.error('[CREATE SHOP] Stack trace:', e.stack);
                    statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (e.message || String(e));
                    statusEl.style.color = 'var(--error, #ef4444)';
                }
            };
            
            window.saveAvitoCredentials = async function() {
                console.log('[SAVE CREDENTIALS] –§—É–Ω–∫—Ü–∏—è saveAvitoCredentials –≤—ã–∑–≤–∞–Ω–∞');
                const shopId = document.getElementById('avito-shop-select')?.value;
                if (!shopId) {
                    const statusEl = document.getElementById('avito-shop-status');
                    if (statusEl) {
                        statusEl.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω';
                        statusEl.style.color = 'var(--error, #ef4444)';
                    } else {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω');
                    }
                    return;
                }
                const payload = {
                    client_id: document.getElementById('avito-client-id').value.trim(),
                    client_secret: document.getElementById('avito-client-secret').value.trim(),
                    user_id: document.getElementById('avito-user-id').value.trim()
                };
                if (!payload.client_id || !payload.client_secret || !payload.user_id) {
                    const statusEl = document.getElementById('avito-shop-status');
                    if (statusEl) {
                        statusEl.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–ª—é—á–µ–π';
                        statusEl.style.color = 'var(--error, #ef4444)';
                    } else {
                        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–ª—é—á–µ–π');
                    }
                    return;
                }
                try {
                    const statusEl = document.getElementById('avito-shop-status');
                    if (statusEl) {
                        statusEl.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                        statusEl.style.color = 'var(--text-muted)';
                    }
                    
                    const resp = await fetch(`/api/shops/${shopId}/credentials`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(payload)
                    });
                    
                    const contentType = resp.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await resp.text();
                        console.error('[SAVE CREDENTIALS] –ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç:', text.substring(0, 200));
                        if (statusEl) {
                            statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç';
                            statusEl.style.color = 'var(--error, #ef4444)';
                        }
                        return;
                    }
                    
                    const result = await resp.json();
                    if (resp.ok) {
                        if (statusEl) {
                            statusEl.textContent = result.message || '‚úÖ –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                            statusEl.style.color = 'var(--success, #10b981)';
                        }
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ë–î —É—Å–ø–µ–ª–∞ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                        setTimeout(async () => {
                            if (typeof window.loadAvitoShops === 'function') {
                                await window.loadAvitoShops();
                            }
                            if (typeof populateAvitoFields === 'function') {
                                if (typeof window.populateAvitoFields === 'function') {
                                window.populateAvitoFields(shopId);
                            }
                            }
                        }, 300);
                    } else {
                        const errorMsg = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        console.error('[SAVE CREDENTIALS] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π:', errorMsg, result);
                        if (statusEl) {
                            statusEl.textContent = `‚ùå ${errorMsg}`;
                            statusEl.style.color = 'var(--error, #ef4444)';
                        }
                    }
                } catch (e) {
                    console.error('[SAVE CREDENTIALS] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–ª—é—á–µ–π:', e);
                    const statusEl = document.getElementById('avito-shop-status');
                    if (statusEl) {
                        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π: ' + (e.message || String(e));
                        statusEl.style.color = 'var(--error, #ef4444)';
                    }
                }
            };
            
            window.updateShop = async function() {
                console.log('[UPDATE SHOP] –§—É–Ω–∫—Ü–∏—è updateShop –≤—ã–∑–≤–∞–Ω–∞');
                const shopId = document.getElementById('edit-shop-id').value;
                const nameEl = document.getElementById('edit-shop-name');
                const shopUrlEl = document.getElementById('edit-shop-url');
                const apiKeyEl = document.getElementById('edit-shop-api-key');
                const isActiveEl = document.getElementById('edit-shop-active');
                const clientIdEl = document.getElementById('edit-shop-client-id');
                const clientSecretEl = document.getElementById('edit-shop-client-secret');
                const userIdEl = document.getElementById('edit-shop-user-id');
                const statusEl = document.getElementById('edit-shop-status');
                
                if (!shopId || !nameEl || !shopUrlEl || !statusEl) {
                    console.error('[UPDATE SHOP] –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã');
                    alert('–û—à–∏–±–∫–∞: —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
                    return;
                }
                
                const name = nameEl.value.trim();
                const shopUrl = shopUrlEl.value.trim();
                const apiKey = apiKeyEl ? apiKeyEl.value.trim() : '';
                const isActive = isActiveEl ? isActiveEl.checked : true;
                const clientId = clientIdEl ? clientIdEl.value.trim() : '';
                const clientSecret = clientSecretEl ? clientSecretEl.value.trim() : '';
                const userId = userIdEl ? userIdEl.value.trim() : '';

                if (!name || !shopUrl) {
                    statusEl.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ URL –º–∞–≥–∞–∑–∏–Ω–∞';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                if (!shopUrl.startsWith('http://') && !shopUrl.startsWith('https://')) {
                    statusEl.textContent = '‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                const hasKeys = clientId || clientSecret || userId;
                if (hasKeys && (!clientId || !clientSecret || !userId)) {
                    statusEl.textContent = '‚ùå –ï—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –∫–ª—é—á–∏, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —Ç—Ä–∏ –ø–æ–ª—è (Client ID, Client Secret, User ID)';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                statusEl.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...';
                statusEl.style.color = 'var(--text-muted)';

                try {
                    console.log('[UPDATE SHOP] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞...');
                    const resp = await fetch(`/api/shops/${shopId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            name: name,
                            shop_url: shopUrl,
                            api_key: apiKey || null,
                            is_active: isActive
                        })
                    });

                    const contentType = resp.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await resp.text();
                        console.error('[UPDATE SHOP] –ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç:', text.substring(0, 200));
                        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç';
                        statusEl.style.color = 'var(--error, #ef4444)';
                        return;
                    }

                    const result = await resp.json();
                    console.log('[UPDATE SHOP] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                    
                    if (resp.ok && result.success) {
                        // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –∫–ª—é—á–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
                        if (hasKeys && clientId && clientSecret && userId) {
                            statusEl.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π...';
                            
                            const credResp = await fetch(`/api/shops/${shopId}/credentials`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    client_id: clientId,
                                    client_secret: clientSecret,
                                    user_id: userId
                                })
                            });
                            
                            if (!credResp.ok) {
                                const credResult = await credResp.json().catch(() => ({}));
                                statusEl.textContent = `‚úÖ –ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏: ${credResult.error || '–û—à–∏–±–∫–∞'}`;
                                statusEl.style.color = 'var(--warning, #f59e0b)';
                            } else {
                                statusEl.textContent = '‚úÖ –ú–∞–≥–∞–∑–∏–Ω –∏ –∫–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!';
                                statusEl.style.color = 'var(--success, #10b981)';
                            }
                        } else {
                            statusEl.textContent = '‚úÖ –ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!';
                            statusEl.style.color = 'var(--success, #10b981)';
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
                        if (typeof window.loadAvitoShops === 'function') {
                            await window.loadAvitoShops();
                        }
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            if (typeof window.closeEditShopModal === 'function') {
                                window.closeEditShopModal();
                            }
                        }, 1500);
                    } else {
                        const errorMsg = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω';
                        console.error('[UPDATE SHOP] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞:', errorMsg, result);
                        statusEl.textContent = `‚ùå ${errorMsg}`;
                        statusEl.style.color = 'var(--error, #ef4444)';
                    }
                } catch (e) {
                    console.error('[UPDATE SHOP] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', e);
                    statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (e.message || String(e));
                    statusEl.style.color = 'var(--error, #ef4444)';
                }
            };
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º loadAvitoShops –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ HEAD
            // –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
            window.avitoShops = [];
            
            window.loadAvitoShops = async function() {
                console.log('[LOAD SHOPS] –§—É–Ω–∫—Ü–∏—è loadAvitoShops –≤—ã–∑–≤–∞–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ HEAD)');
                console.log('[LOAD SHOPS] –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ avito-shop-select...');
                const select = document.getElementById('avito-shop-select');
                if (!select) {
                    console.error('[LOAD SHOPS] ‚ùå –≠–ª–µ–º–µ–Ω—Ç avito-shop-select –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    console.error('[LOAD SHOPS] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã –∫–∞–∫ admin –∏–ª–∏ super_admin');
                    console.error('[LOAD SHOPS] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ–∫—Ü–∏—è Avito API –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (–Ω–∞ —Å–ª—É—á–∞–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
                    setTimeout(async () => {
                        const delayedSelect = document.getElementById('avito-shop-select');
                        if (delayedSelect) {
                            console.log('[LOAD SHOPS] –≠–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏...');
                            await window.loadAvitoShops();
                        } else {
                            console.error('[LOAD SHOPS] –≠–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏');
                        }
                    }, 500);
                    return;
                }
                console.log('[LOAD SHOPS] ‚úÖ –≠–ª–µ–º–µ–Ω—Ç select –Ω–∞–π–¥–µ–Ω:', select);
                select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
                try {
                    console.log('[LOAD SHOPS] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/shops...');
                    const resp = await fetch('/api/shops', {
                        headers: {
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    console.log('[LOAD SHOPS] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', resp.status, resp.ok);
                    if (!resp.ok) {
                        const errorText = await resp.text();
                        console.error('[LOAD SHOPS] –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', errorText);
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã: ' + resp.status);
                    }
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    window.avitoShops = await resp.json();
                    console.log('[LOAD SHOPS] –ú–∞–≥–∞–∑–∏–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã:', window.avitoShops);
                    console.log('[LOAD SHOPS] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤:', window.avitoShops.length);
                    if (!Array.isArray(window.avitoShops) || window.avitoShops.length === 0) {
                        console.warn('[LOAD SHOPS] –ú–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤');
                        select.innerHTML = '<option value="">–ú–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                        return;
                    }
                    const currentValue = select.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    console.log('[LOAD SHOPS] –°–æ–∑–¥–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è', window.avitoShops.length, '–º–∞–≥–∞–∑–∏–Ω–æ–≤');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>' + 
                        window.avitoShops.map(shop => {
                            const status = shop.avito_status === 'ok' ? ' ‚úÖ' : ' ‚ö†Ô∏è';
                            const name = shop.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                            console.log('[LOAD SHOPS] –î–æ–±–∞–≤–ª—è–µ–º –º–∞–≥–∞–∑–∏–Ω:', shop.id, name);
                            return `<option value="${shop.id}">${name}${status}</option>`;
                        }).join('');
                    console.log('[LOAD SHOPS] –û–ø—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã, HTML –¥–ª–∏–Ω–∞:', select.innerHTML.length);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    if (currentValue) {
                        select.value = currentValue;
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                    const newSelect = select.cloneNode(true);
                    select.parentNode.replaceChild(newSelect, select);
                    const updatedSelect = document.getElementById('avito-shop-select');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    updatedSelect.addEventListener('change', (e) => {
                        if (typeof populateAvitoFields === 'function') {
                            if (typeof window.populateAvitoFields === 'function') {
                                window.populateAvitoFields(e.target.value);
                            }
                        }
                        // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                        const deleteBtn = document.getElementById('delete-shop-btn');
                        if (deleteBtn) {
                            deleteBtn.disabled = !e.target.value;
                        }
                    });
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
                    if (updatedSelect.value) {
                        if (typeof populateAvitoFields === 'function') {
                            populateAvitoFields(updatedSelect.value);
                        }
                        const deleteBtn = document.getElementById('delete-shop-btn');
                        if (deleteBtn) deleteBtn.disabled = false;
                    } else if (window.avitoShops.length > 0) {
                        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –Ω–æ –µ—Å—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
                        updatedSelect.value = window.avitoShops[0].id;
                        if (typeof populateAvitoFields === 'function') {
                            if (typeof window.populateAvitoFields === 'function') {
                                window.populateAvitoFields(window.avitoShops[0].id);
                            }
                        }
                        const deleteBtn = document.getElementById('delete-shop-btn');
                        if (deleteBtn) deleteBtn.disabled = false;
                    }
                } catch (e) {
                    console.error('[LOAD SHOPS] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤:', e);
                    console.error('[LOAD SHOPS] Stack trace:', e.stack);
                    const select = document.getElementById('avito-shop-select');
                    if (select) {
                        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤: ' + (e.message || String(e)) + '</option>';
                    }
                }
            };
            
            // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
            window.createUser = async function createUser() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                {% if user.get('role') == 'admin' or user.get('role') == 'super_admin' %}
                const roleEl = document.getElementById('new-user-role');
                const usernameEl = document.getElementById('new-user-username');
                const emailEl = document.getElementById('new-user-email');
                const firstNameEl = document.getElementById('new-user-first-name');
                const lastNameEl = document.getElementById('new-user-last-name');
                const salaryEl = document.getElementById('new-user-salary');
                const statusEl = document.getElementById('create-user-status');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç (—Ñ–æ—Ä–º–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
                if (!roleEl || !usernameEl || !emailEl || !statusEl) {
                    console.error('[CREATE USER] –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.');
                    return;
                }
                
                const role = roleEl.value;
                const username = usernameEl.value.trim();
                const email = emailEl.value.trim();
                const firstName = firstNameEl ? firstNameEl.value.trim() : '';
                const lastName = lastNameEl ? lastNameEl.value.trim() : '';
                const salary = parseFloat(salaryEl.value) || 0;

                if (!username || !email) {
                    statusEl.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ email';
                    statusEl.style.color = 'var(--error, #ef4444)';
                    return;
                }

                statusEl.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...';
                statusEl.style.color = 'var(--text-muted)';

                try {
                    console.log('[CREATE USER] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', { username, email, firstName, lastName, role, salary });
                    
                    const resp = await fetch('/api/managers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            username: username,
                            email: email,
                            first_name: firstName || null,
                            last_name: lastName || null,
                            role: role,
                            salary: salary
                        })
                    });

                    console.log('[CREATE USER] –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', resp.status, resp.statusText);

                    const contentType = resp.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await resp.text();
                        console.error('[CREATE USER] –ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç:', text.substring(0, 200));
                        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç';
                        statusEl.style.color = 'var(--error, #ef4444)';
                        return;
                    }

                    const result = await resp.json();
                    console.log('[CREATE USER] –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (201 Created –∏–ª–∏ 200 OK)
                    if ((resp.status === 201 || resp.status === 200) && result.success) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –±–ª–æ–∫–µ
                        if (result.temp_password) {
                            const tempPassword = result.temp_password;
                            statusEl.innerHTML = `
                                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: var(--radius); margin-top: 1rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>‚úÖ</span>
                                        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</span>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: calc(var(--radius) - 2px); margin-bottom: 1rem;">
                                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">üîê –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: 0.1em; text-align: center; background: rgba(255, 255, 255, 0.15); padding: 0.75rem; border-radius: calc(var(--radius) - 2px); border: 2px dashed rgba(255, 255, 255, 0.4);" id="temp-password-display">${tempPassword}</div>
                                    </div>
                                    <button onclick="copyTempPassword('${tempPassword.replace(/'/g, "\\'").replace(/"/g, '\\"')}', this)" style="width: 100%; padding: 0.75rem; background: white; color: #059669; border: none; border-radius: calc(var(--radius) - 2px); font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å
                                    </button>
                                    <div style="font-size: 0.75rem; margin-top: 0.75rem; opacity: 0.9; text-align: center;">
                                        ‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å! –û–Ω –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω.
                                    </div>
                                </div>
                            `;
                            statusEl.style.color = 'transparent';
                        } else {
                            statusEl.textContent = `‚úÖ ${result.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'}`;
                            statusEl.style.color = 'var(--success, #10b981)';
                        }
                        
                        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                        document.getElementById('new-user-username').value = '';
                        document.getElementById('new-user-email').value = '';
                        if (document.getElementById('new-user-first-name')) {
                            document.getElementById('new-user-first-name').value = '';
                        }
                        if (document.getElementById('new-user-last-name')) {
                            document.getElementById('new-user-last-name').value = '';
                        }
                        document.getElementById('new-user-salary').value = '';
                        document.getElementById('new-user-role').value = 'manager';
                        
                        // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                        {% if user and user.get('role') == 'super_admin' %}
                        if (typeof loadUsersForTabVisibility === 'function') {
                            await loadUsersForTabVisibility();
                        }
                        {% endif %}
                    } else {
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                        const errorMsg = result.error || result.message || `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—Ç–∞—Ç—É—Å: ${resp.status})`;
                        console.error('[CREATE USER] –û—à–∏–±–∫–∞:', errorMsg);
                        statusEl.textContent = `‚ùå ${errorMsg}`;
                        statusEl.style.color = 'var(--error, #ef4444)';
                    }
                } catch (e) {
                    console.error('[CREATE USER] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                    statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (e.message || String(e));
                    statusEl.style.color = 'var(--error, #ef4444)';
                }
                {% else %}
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω, —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                console.error('[CREATE USER] –ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                const statusEl = document.getElementById('create-user-status');
                if (statusEl) {
                    statusEl.textContent = '‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    statusEl.style.color = 'var(--error, #ef4444)';
                }
                {% endif %}
            };
            
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. showCreateShopModal:', typeof window.showCreateShopModal);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. showEditShopModal:', typeof window.showEditShopModal);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. createShop:', typeof window.createShop);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. updateShop:', typeof window.updateShop);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. toggleSecret:', typeof window.toggleSecret);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. loadAvitoShops:', typeof window.loadAvitoShops);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. saveAvitoCredentials:', typeof window.saveAvitoCredentials);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. updateShop:', typeof window.updateShop);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. populateAvitoFields:', typeof window.populateAvitoFields);
            console.log('[EARLY INIT] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HEAD. createUser:', typeof window.createUser);
            
            // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
            window.copyTempPassword = function(password, buttonElement) {
                navigator.clipboard.writeText(password).then(() => {
                    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë —Ç–µ–∫—Å—Ç
                    if (buttonElement) {
                        const originalText = buttonElement.textContent;
                        buttonElement.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                        buttonElement.style.background = '#10b981';
                        buttonElement.style.color = 'white';
                        setTimeout(() => {
                            buttonElement.textContent = originalText;
                            buttonElement.style.background = 'white';
                            buttonElement.style.color = '#059669';
                        }, 2000);
                    } else {
                        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        alert('‚úÖ –ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    }
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + password);
                });
            };
        })();
    </script>
{% endblock %}

{% block styles %}
    <style>
        .settings-page {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .settings-block {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .block-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .form-item {
            margin-bottom: 1rem;
        }

        .form-item:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            background: var(--card);
            color: var(--text);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .color-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-picker {
            width: 50px;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            cursor: pointer;
        }

        .color-text {
            flex: 1;
        }

        .switch-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: color-mix(in srgb, var(--bg-secondary) 30%, transparent);
            border-radius: calc(var(--radius));
        }

        .switch-label-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }

        .switch-label-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: var(--primary);
        }

        input:checked + .switch-slider:before {
            transform: translateX(24px);
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .theme-btn {
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            border-radius: calc(var(--radius));
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .theme-btn:hover {
            border-color: var(--primary);
        }

        .theme-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .save-button {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: calc(var(--radius));
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: opacity 0.2s;
        }

        .save-button:hover {
            opacity: 0.9;
        }

        .save-button:active {
            opacity: 0.8;
        }

        .modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 99999 !important;
            padding: 1rem !important;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay[style*="flex"],
        .modal-overlay.show {
            display: flex !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) * 1.5);
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
            z-index: 10000;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: calc(var(--radius));
            text-align: center;
            font-size: 0.875rem;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .inline-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block content %}
            <div class="settings-page">
                <h1 class="page-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

                {% if user and (user.get('role') == 'admin' or user.get('role') == 'super_admin') %}
                <!-- –¢–∞–π–º–µ—Ä—ã -->
                <div class="settings-block">
                    <h2 class="block-title">‚è±Ô∏è –¢–∞–π–º–µ—Ä—ã</h2>
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">–í—Ä–µ–º—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ (—á–∞—Å—ã)</label>
                            <input type="number" class="form-input" id="timer-new-chat" min="1" max="24" value="1">
                            <div class="form-help">–ß–∞—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–í—Ä–µ–º—è –¥–ª—è —Å—Ä–æ—á–Ω–æ–≥–æ —á–∞—Ç–∞ (–º–∏–Ω—É—Ç—ã)</label>
                            <input type="number" class="form-input" id="timer-urgent" min="5" max="60" value="20">
                            <div class="form-help">–ß–∞—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å—Ä–æ—á–Ω—ã–º –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–º–∏–Ω—É—Ç—ã)</label>
                            <input type="number" class="form-input" id="timer-critical" min="10" max="120" value="60">
                            <div class="form-help">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —á–∞—Ç</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–∏–≥–∞–Ω–∏—è (–º—Å)</label>
                            <input type="number" class="form-input" id="notification-blink" min="500" max="5000" step="100" value="1000">
                            <div class="form-help">–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–∏–≥–∞–Ω–∏—è –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                        </div>
                    </div>
                </div>

                <!-- –¶–≤–µ—Ç–∞ -->
                <div class="settings-block">
                    <h2 class="block-title">üé® –¶–≤–µ—Ç–∞</h2>
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">–¶–≤–µ—Ç —Å—Ä–æ—á–Ω—ã—Ö —á–∞—Ç–æ–≤</label>
                            <div class="color-group">
                                <input type="color" class="color-picker" id="color-urgent" value="#ef4444">
                                <input type="text" class="form-input color-text" id="color-urgent-text" value="#ef4444">
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–¶–≤–µ—Ç –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤</label>
                            <div class="color-group">
                                <input type="color" class="color-picker" id="color-new" value="#f59e0b">
                                <input type="text" class="form-input color-text" id="color-new-text" value="#f59e0b">
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–¶–≤–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</label>
                            <div class="color-group">
                                <input type="color" class="color-picker" id="color-active" value="#10b981">
                                <input type="text" class="form-input color-text" id="color-active-text" value="#10b981">
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–¶–≤–µ—Ç –¥–æ—Å—Ç–∞–≤–æ–∫</label>
                            <div class="color-group">
                                <input type="color" class="color-picker" id="color-delivery" value="#8b5cf6">
                                <input type="text" class="form-input color-text" id="color-delivery-text" value="#8b5cf6">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI -->
                <div class="settings-block">
                    <h2 class="block-title">üìä KPI</h2>
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">–í–µ—Å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (0.0 - 1.0)</label>
                            <input type="number" class="form-input" id="kpi-response-weight" min="0" max="1" step="0.1" value="0.3">
                            <div class="form-help">–í–ª–∏—è–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ–±—â–∏–π KPI</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–í–µ—Å –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (0.0 - 1.0)</label>
                            <input type="number" class="form-input" id="kpi-conversion-weight" min="0" max="1" step="0.1" value="0.4">
                            <div class="form-help">–í–ª–∏—è–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –≤ –∑–∞–∫–∞–∑—ã –Ω–∞ –æ–±—â–∏–π KPI</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–í–µ—Å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (0.0 - 1.0)</label>
                            <input type="number" class="form-input" id="kpi-satisfaction-weight" min="0" max="1" step="0.1" value="0.2">
                            <div class="form-help">–í–ª–∏—è–Ω–∏–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –æ–±—â–∏–π KPI</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–í–µ—Å —Å–æ–æ–±—â–µ–Ω–∏–π (0.0 - 1.0)</label>
                            <input type="number" class="form-input" id="kpi-messages-weight" min="0" max="1" step="0.1" value="0.1">
                            <div class="form-help">–í–ª–∏—è–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ–±—â–∏–π KPI</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π KPI –¥–ª—è –±–æ–Ω—É—Å–∞ (%)</label>
                            <input type="number" class="form-input" id="kpi-min-bonus" min="0" max="100" value="80">
                            <div class="form-help">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π KPI –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞</div>
                        </div>
                    </div>
                </div>

                <!-- Avito API -->
                <div class="settings-block">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="block-title" style="margin: 0;">üîë Avito API –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤</h2>
                        <button class="theme-btn" id="create-shop-btn" style="padding: 0.5rem 1rem;" onclick="console.log('[ONCLICK] –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!'); console.log('[ONCLICK] window.showCreateShopModal:', typeof window.showCreateShopModal); if(typeof window.showCreateShopModal === 'function') { window.showCreateShopModal(); } else { alert('–§—É–Ω–∫—Ü–∏—è showCreateShopModal –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)'); }">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
                        </button>
                    </div>
                    
                    <div class="form-item">
                        <label class="form-label">–ú–∞–≥–∞–∑–∏–Ω</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select class="form-input" id="avito-shop-select" style="flex: 1;"></select>
                            <button class="theme-btn" onclick="console.log('[BUTTON CLICK] –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞'); if(typeof window.loadAvitoShops === 'function') { window.loadAvitoShops(); } else { console.error('[BUTTON CLICK] –§—É–Ω–∫—Ü–∏—è loadAvitoShops –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!'); alert('–§—É–Ω–∫—Ü–∏—è loadAvitoShops –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)'); }" style="padding: 0.5rem 0.75rem;" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">
                                üîÑ
                            </button>
                            <button class="theme-btn" onclick="deleteSelectedShop()" style="padding: 0.5rem 0.75rem; background: var(--danger, #ef4444); color: white;" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω" id="delete-shop-btn" disabled>
                                üóëÔ∏è
                            </button>
                        </div>
                        <div class="form-help" id="avito-shop-status"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-input" id="avito-client-id" autocomplete="off" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Client ID">
                        </div>
                        <div class="form-item">
                            <label class="form-label">Client Secret</label>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="password" class="form-input" id="avito-client-secret" autocomplete="off" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Client Secret" style="flex:1;">
                                <button type="button" class="theme-btn" style="padding:0.5rem 0.75rem;" onclick="toggleSecret('avito-client-secret', this)">üëÅ</button>
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">User ID (Avito)</label>
                            <input type="text" class="form-input" id="avito-user-id" autocomplete="off" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ User ID">
                        </div>
                    </div>
                    <button class="save-button" style="margin-top: 1rem;" onclick="if(typeof window.saveAvitoCredentials === 'function') { window.saveAvitoCredentials(); } else { alert('–§—É–Ω–∫—Ü–∏—è saveAvitoCredentials –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)'); }">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏</button>
                    <div class="form-help" style="margin-top: 0.5rem;">–ö–ª—é—á–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–∞—Ç–æ–≤.</div>
                </div>
                {% endif %}

                {% if user and user.get('role') == 'super_admin' %}
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤–∫–ª–∞–¥–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è super_admin) -->
                <div class="settings-block">
                    <h2 class="block-title">üëÅÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤–∫–ª–∞–¥–æ–∫</h2>
                    <div class="form-help" style="margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–∫–ª–∞–¥–æ–∫ –¥–ª—è –Ω–µ–≥–æ</div>
                    
                    <div class="form-item" style="margin-bottom: 1.5rem;">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <select class="form-input" id="tab-visibility-user-select" onchange="loadUserTabVisibility()">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>
                        </select>
                        <div class="form-help">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫</div>
                    </div>
                    
                    <div id="tab-visibility-settings" style="display: none;">
                        <div style="margin-top: 1rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text);" id="selected-user-name">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                            <div class="tab-visibility-list">
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üìä –î–∞—à–±–æ—Ä–¥</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-dashboard" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üí¨ –ß–∞—Ç—ã</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-chats" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üõí –í—ã–∫—É–ø</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-buyout" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üöö –î–æ—Å—Ç–∞–≤–∫–∏</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-deliveries" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-quick-replies" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-shops">
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-analytics">
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                                <label class="switch-group" style="padding: 0.75rem; margin-bottom: 0.5rem;">
                                    <div>
                                        <div class="switch-label-text">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="tab-user-settings">
                                        <span class="switch-slider"></span>
                                    </label>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button class="save-button" style="margin-top: 1rem;" onclick="saveTabVisibility()" id="save-tab-visibility-btn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏</button>
                    <div class="form-help" style="margin-top: 0.5rem;">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</div>
                </div>
                {% endif %}

                {% if user and (user.get('role') == 'admin' or user.get('role') == 'super_admin') %}
                <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–¥–º–∏–Ω –∏ super_admin) -->
                <div class="settings-block">
                    <h2 class="block-title">üë• –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                    <div class="form-help" style="margin-bottom: 1rem;">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞ –∏–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</div>
                    
                    <div class="form-item">
                        <label class="form-label">–†–æ–ª—å *</label>
                        <select class="form-input" id="new-user-role">
                            <option value="manager">üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                            {% if user and user.get('role') == 'super_admin' %}
                            <option value="admin">üëë –ê–¥–º–∏–Ω</option>
                            {% endif %}
                        </select>
                        <div class="form-help">{% if user and user.get('role') == 'super_admin' %}–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–¥–º–∏–Ω–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤{% else %}–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤{% endif %}</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                            <input type="text" class="form-input" id="new-user-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
                        </div>
                        <div class="form-item">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="new-user-email" placeholder="user@example.com" autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">–ò–º—è</label>
                            <input type="text" class="form-input" id="new-user-first-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" autocomplete="off">
                            <div class="form-help">–ò–º—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                            <input type="text" class="form-input" id="new-user-last-name" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" autocomplete="off">
                            <div class="form-help">–§–∞–º–∏–ª–∏—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –∏–º–µ–Ω–µ–º</div>
                        </div>
                    </div>
                    
                    <div class="form-item">
                        <label class="form-label">–ó–∞—Ä–ø–ª–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="number" class="form-input" id="new-user-salary" placeholder="0" min="0" step="0.01" autocomplete="off">
                        <div class="form-help">–ó–∞—Ä–ø–ª–∞—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ KPI –∏ –±–æ–Ω—É—Å–æ–≤</div>
                    </div>
                    
                    <button class="save-button" style="margin-top: 1rem;" onclick="createUser()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                    <div id="create-user-status" class="form-help" style="margin-top: 0.5rem; color: var(--text-muted);"></div>
                </div>
                {% endif %}

                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                <div class="settings-block">
                    <h2 class="block-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                    <div class="form-item">
                        <div class="switch-group">
                            <div>
                                <div class="switch-label-text">Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                                <div class="switch-label-desc">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="push-enabled" checked>
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-item">
                        <div class="switch-group">
                            <div>
                                <div class="switch-label-text">–ó–≤—É–∫–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="switch-label-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∑–≤—É–∫ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="sound-enabled" checked>
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- –¢–µ–º–∞ -->
                <div class="settings-block">
                    <h2 class="block-title">üåô –¢–µ–º–∞</h2>
                    <div class="theme-buttons">
                        <button class="theme-btn active" data-theme="dark" onclick="switchTheme('dark')">üåô –¢–µ–º–Ω–∞—è</button>
                        <button class="theme-btn" data-theme="light" onclick="switchTheme('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
                    </div>
                </div>

                <button class="save-button" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <div id="status-message" class="status-message" style="display: none;"></div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div id="create-shop-modal" class="modal-overlay" style="display: none !important;">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-size: 1.25rem; color: var(--text);">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω</h2>
                    <button class="theme-btn" id="create-shop-close-btn" style="padding: 0.5rem; font-size: 1.25rem;">‚úï</button>
                </div>
                <div class="form-item">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                    <input type="text" class="form-input" id="new-shop-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –º–∞–≥–∞–∑–∏–Ω Avito" autocomplete="off">
                </div>
                <div class="form-item">
                    <label class="form-label">URL –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                    <input type="url" class="form-input" id="new-shop-url" placeholder="https://www.avito.ru/users/..." autocomplete="off">
                    <div class="form-help">–ü–æ–ª–Ω—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–∞ Avito</div>
                </div>
                <div class="form-item">
                    <label class="form-label">API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="new-shop-api-key" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω" autocomplete="off">
                </div>
                <div class="form-item">
                    <label class="switch-group" style="padding: 0;">
                        <div>
                            <div class="switch-label-text">–ê–∫—Ç–∏–≤–µ–Ω</div>
                            <div class="switch-label-desc">–ú–∞–≥–∞–∑–∏–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="new-shop-active" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                </div>
                <div style="margin: 1.5rem 0; padding: 1rem; background: color-mix(in srgb, var(--bg-secondary) 30%, transparent); border-radius: calc(var(--radius));">
                    <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text);">üîë –ö–ª—é—á–∏ Avito API (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –ø–æ–∑–∂–µ)</div>
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-input" id="new-shop-client-id" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off">
                        </div>
                        <div class="form-item">
                            <label class="form-label">Client Secret</label>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="password" class="form-input" id="new-shop-client-secret" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off" style="flex:1;">
                                <button type="button" class="theme-btn" style="padding:0.5rem 0.75rem;" onclick="toggleSecret('new-shop-client-secret', this)">üëÅ</button>
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-input" id="new-shop-user-id" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="save-button" id="create-shop-submit-btn" style="flex: 1;" onclick="console.log('[ONCLICK SUBMIT] –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!'); console.log('[ONCLICK SUBMIT] window.createShop:', typeof window.createShop); if(typeof window.createShop === 'function') { window.createShop(); } else { alert('–§—É–Ω–∫—Ü–∏—è createShop –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)'); } return false;">üíæ –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                    <button class="theme-btn" id="create-shop-cancel-btn" style="padding: 0.875rem 1.5rem;">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div id="create-shop-status" class="form-help" style="margin-top: 0.5rem; color: var(--text-muted);"></div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div id="edit-shop-modal" class="modal-overlay" style="display: none !important;">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-size: 1.25rem; color: var(--text);">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</h2>
                    <button class="theme-btn" id="edit-shop-close-btn" style="padding: 0.5rem; font-size: 1.25rem;">‚úï</button>
                </div>
                <input type="hidden" id="edit-shop-id" value="">
                <div class="form-item">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                    <input type="text" class="form-input" id="edit-shop-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –º–∞–≥–∞–∑–∏–Ω Avito" autocomplete="off">
                </div>
                <div class="form-item">
                    <label class="form-label">URL –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                    <input type="url" class="form-input" id="edit-shop-url" placeholder="https://www.avito.ru/users/..." autocomplete="off">
                    <div class="form-help">–ü–æ–ª–Ω—ã–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–∞ Avito</div>
                </div>
                <div class="form-item">
                    <label class="form-label">API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="edit-shop-api-key" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω" autocomplete="off">
                </div>
                <div class="form-item">
                    <label class="switch-group" style="padding: 0;">
                        <div>
                            <div class="switch-label-text">–ê–∫—Ç–∏–≤–µ–Ω</div>
                            <div class="switch-label-desc">–ú–∞–≥–∞–∑–∏–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="edit-shop-active" checked>
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                </div>
                <div style="margin: 1.5rem 0; padding: 1rem; background: color-mix(in srgb, var(--bg-secondary) 30%, transparent); border-radius: calc(var(--radius));">
                    <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text);">üîë –ö–ª—é—á–∏ Avito API (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)</div>
                    <div class="form-row">
                        <div class="form-item">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-input" id="edit-shop-client-id" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off">
                        </div>
                        <div class="form-item">
                            <label class="form-label">Client Secret</label>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <input type="password" class="form-input" id="edit-shop-client-secret" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off" style="flex:1;">
                                <button type="button" class="theme-btn" style="padding:0.5rem 0.75rem;" onclick="if(typeof window.toggleSecret === 'function') { window.toggleSecret('edit-shop-client-secret', this); } else { alert('–§—É–Ω–∫—Ü–∏—è toggleSecret –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); }">üëÅ</button>
                            </div>
                        </div>
                        <div class="form-item">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-input" id="edit-shop-user-id" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" autocomplete="off">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="save-button" id="edit-shop-submit-btn" style="flex: 1;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <button class="theme-btn" id="edit-shop-cancel-btn" style="padding: 0.875rem 1.5rem;">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div id="edit-shop-status" class="form-help" style="margin-top: 0.5rem; color: var(--text-muted);"></div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <script>
        // –§—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –±–ª–æ–∫–µ styles (—Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ), –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º
        console.log('[SCRIPTS BLOCK] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. showCreateShopModal:', typeof window.showCreateShopModal);
        console.log('[SCRIPTS BLOCK] –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. closeCreateShopModal:', typeof window.closeCreateShopModal);
        
        // –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É
        setTimeout(() => {
            console.log('[SCRIPTS TEST] –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 100ms:');
            console.log('  - showCreateShopModal:', typeof window.showCreateShopModal);
            console.log('  - closeCreateShopModal:', typeof window.closeCreateShopModal);
            console.log('  - –ö–Ω–æ–ø–∫–∞ create-shop-btn:', document.getElementById('create-shop-btn'));
        }, 100);
        
        let systemSettings = {};
        let userSettings = {};
        // avitoShops —Ç–µ–ø–µ—Ä—å –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è window.avitoShops, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –≤ early_scripts
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.avitoShops –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é
        if (typeof window.avitoShops === 'undefined') {
            window.avitoShops = [];
        }
        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
        let avitoShops = window.avitoShops;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function loadSettings() {
            try {
                {% if user and (user.get('role') == 'admin' or user.get('role') == 'super_admin') %}
                const systemResponse = await fetch('/api/settings');
                if (systemResponse.ok) {
                    systemSettings = await systemResponse.json();
                    
                    if (systemSettings.timer_new_chat_hours) {
                        document.getElementById('timer-new-chat').value = systemSettings.timer_new_chat_hours;
                    }
                    if (systemSettings.timer_urgent_minutes) {
                        document.getElementById('timer-urgent').value = systemSettings.timer_urgent_minutes;
                    }
                    if (systemSettings.timer_critical_minutes) {
                        document.getElementById('timer-critical').value = systemSettings.timer_critical_minutes;
                    }
                    if (systemSettings.notification_blink_interval) {
                        document.getElementById('notification-blink').value = systemSettings.notification_blink_interval;
                    }
                    if (systemSettings.color_urgent) {
                        document.getElementById('color-urgent').value = systemSettings.color_urgent;
                        document.getElementById('color-urgent-text').value = systemSettings.color_urgent;
                    }
                    if (systemSettings.color_new) {
                        document.getElementById('color-new').value = systemSettings.color_new;
                        document.getElementById('color-new-text').value = systemSettings.color_new;
                    }
                    if (systemSettings.color_active) {
                        document.getElementById('color-active').value = systemSettings.color_active;
                        document.getElementById('color-active-text').value = systemSettings.color_active;
                    }
                    if (systemSettings.color_delivery) {
                        document.getElementById('color-delivery').value = systemSettings.color_delivery;
                        document.getElementById('color-delivery-text').value = systemSettings.color_delivery;
                    }
                    if (systemSettings.push_enabled !== undefined) {
                        document.getElementById('push-enabled').checked = systemSettings.push_enabled;
                    }
                    if (systemSettings.sound_enabled !== undefined) {
                        document.getElementById('sound-enabled').checked = systemSettings.sound_enabled;
                    }
                    
                    {% if user and user.get('role') == 'super_admin' %}
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é –≤–∫–ª–∞–¥–æ–∫
                    await loadUsersForTabVisibility();
                    {% endif %}
                }
                {% endif %}

                {% if user and (user.get('role') == 'admin' or user.get('role') == 'super_admin') %}
                console.log('[INIT] –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤...');
                console.log('[INIT] –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ avito-shop-select –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π...');
                const selectBefore = document.getElementById('avito-shop-select');
                console.log('[INIT] –≠–ª–µ–º–µ–Ω—Ç avito-shop-select –Ω–∞–π–¥–µ–Ω:', selectBefore !== null);
                
                if (typeof window.loadAvitoShops === 'function') {
                    console.log('[INIT] –§—É–Ω–∫—Ü–∏—è loadAvitoShops –Ω–∞–π–¥–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º...');
                    try {
                        await window.loadAvitoShops();
                        console.log('[INIT] –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    } catch (err) {
                        console.error('[INIT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤:', err);
                    }
                } else {
                    console.error('[INIT] –§—É–Ω–∫—Ü–∏—è loadAvitoShops –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–∏–∑ shops.html)
                const selectedShopId = localStorage.getItem('selectedShopId');
                if (selectedShopId) {
                    console.log('[INIT] –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –º–∞–≥–∞–∑–∏–Ω–∞:', selectedShopId);
                    setTimeout(() => {
                        const select = document.getElementById('avito-shop-select');
                        if (select) {
                            select.value = selectedShopId;
                            select.dispatchEvent(new Event('change'));
                            // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            localStorage.removeItem('selectedShopId');
                            console.log('[INIT] –ú–∞–≥–∞–∑–∏–Ω –≤—ã–±—Ä–∞–Ω:', selectedShopId);
                        }
                    }, 1000);
                }
                {% endif %}

                const userResponse = await fetch('/api/user/settings');
                if (userResponse.ok) {
                    userSettings = await userResponse.json();
                    if (userSettings.theme) {
                        switchTheme(userSettings.theme, false);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        // loadAvitoShops —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –±–ª–æ–∫–µ early_scripts, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ

        function populateAvitoFields(shopId) {
            const statusEl = document.getElementById('avito-shop-status');
            const cid = document.getElementById('avito-client-id');
            const csec = document.getElementById('avito-client-secret');
            const uid = document.getElementById('avito-user-id');
            
            if (!shopId) {
                if (cid) cid.value = '';
                if (csec) csec.value = '';
                if (uid) uid.value = '';
                if (statusEl) statusEl.textContent = '';
                return;
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é window.avitoShops
            const shopsList = window.avitoShops || avitoShops || [];
            const shop = shopsList.find(s => String(s.id) === String(shopId));
            if (!shop) {
                console.warn('[POPULATE] –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω:', shopId, '–≤ —Å–ø–∏—Å–∫–µ –∏–∑', shopsList.length, '–º–∞–≥–∞–∑–∏–Ω–æ–≤');
                if (cid) cid.value = '';
                if (csec) csec.value = '';
                if (uid) uid.value = '';
                if (statusEl) statusEl.textContent = '‚ö†Ô∏è –ú–∞–≥–∞–∑–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                return;
            }
            
            console.log('–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞:', shop.name, {
                has_client_id: !!shop.client_id,
                has_client_secret: !!shop.client_secret,
                has_user_id: !!shop.user_id,
                avito_status: shop.avito_status
            });
            
            if (cid) cid.value = shop.client_id || '';
            if (csec) csec.value = shop.client_secret || '';
            if (uid) uid.value = shop.user_id || '';
            if (statusEl) {
                const status = shop.avito_status === 'ok' ? '‚úÖ –ö–ª—é—á–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã' : '‚ö†Ô∏è –ö–ª—é—á–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
                statusEl.textContent = status;
            }
        };

        // saveAvitoCredentials —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –±–ª–æ–∫–µ early_scripts, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ

        // –§—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
        (function() {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initModalHandlers);
            } else {
                initModalHandlers();
            }
            
            function initModalHandlers() {
                const modal = document.getElementById('create-shop-modal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            if (typeof window.closeCreateShopModal === 'function') {
                                window.closeCreateShopModal();
                            }
                        }
                    });
                    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
                } else {
                    console.warn('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤');
                }
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('create-shop-modal');
                        if (modal && modal.style.display === 'flex') {
                            if (typeof window.closeCreateShopModal === 'function') {
                                window.closeCreateShopModal();
                            }
                        }
                    }
                });
            }
        })();

        // closeCreateShopModal –∏ createShop —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –±–ª–æ–∫–µ early_scripts, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ

        let allUsers = [];
        
        async function loadUsersForTabVisibility() {
            {% if user and user.get('role') == 'super_admin' %}
            try {
                const resp = await fetch('/api/users');
                if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                allUsers = await resp.json();
                const select = document.getElementById('tab-visibility-user-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --</option>' + 
                    allUsers.filter(u => u.is_active).map(user => {
                        const roleIcon = user.role === 'super_admin' ? 'üëë' : user.role === 'admin' ? 'üëë' : 'üë®‚Äçüíº';
                        return `<option value="${user.id}">${roleIcon} ${user.username} (${user.email}) - ${user.role}</option>`;
                    }).join('');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
            }
            {% endif %}
        }
        
        async function loadUserTabVisibility() {
            {% if user and user.get('role') == 'super_admin' %}
            const userId = document.getElementById('tab-visibility-user-select')?.value;
            const settingsDiv = document.getElementById('tab-visibility-settings');
            const saveBtn = document.getElementById('save-tab-visibility-btn');
            const userNameEl = document.getElementById('selected-user-name');
            
            if (!userId) {
                if (settingsDiv) settingsDiv.style.display = 'none';
                if (saveBtn) saveBtn.disabled = true;
                return;
            }
            
            const selectedUser = allUsers.find(u => String(u.id) === String(userId));
            if (selectedUser && userNameEl) {
                const roleIcon = selectedUser.role === 'super_admin' ? 'üëë' : selectedUser.role === 'admin' ? 'üëë' : 'üë®‚Äçüíº';
                userNameEl.textContent = `${roleIcon} ${selectedUser.username} (${selectedUser.role})`;
            }
            
            try {
                const resp = await fetch(`/api/users/${userId}/tab-visibility`);
                if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
                const data = await resp.json();
                
                const tabs = data.tab_visibility || {};
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏
                const defaultTabs = selectedUser?.role === 'manager' ? {
                    dashboard: true, chats: true, buyout: true, deliveries: true, quick_replies: true,
                    shops: false, analytics: false, settings: false
                } : {
                    dashboard: true, chats: true, buyout: true, deliveries: true, quick_replies: true,
                    shops: true, analytics: true, settings: true
                };
                
                document.getElementById('tab-user-dashboard').checked = tabs.dashboard !== false && (tabs.dashboard !== undefined ? tabs.dashboard : defaultTabs.dashboard);
                document.getElementById('tab-user-chats').checked = tabs.chats !== false && (tabs.chats !== undefined ? tabs.chats : defaultTabs.chats);
                document.getElementById('tab-user-buyout').checked = tabs.buyout !== false && (tabs.buyout !== undefined ? tabs.buyout : defaultTabs.buyout);
                document.getElementById('tab-user-deliveries').checked = tabs.deliveries !== false && (tabs.deliveries !== undefined ? tabs.deliveries : defaultTabs.deliveries);
                document.getElementById('tab-user-quick-replies').checked = tabs.quick_replies !== false && (tabs.quick_replies !== undefined ? tabs.quick_replies : defaultTabs.quick_replies);
                document.getElementById('tab-user-shops').checked = tabs.shops === true || (tabs.shops === undefined && defaultTabs.shops);
                document.getElementById('tab-user-analytics').checked = tabs.analytics === true || (tabs.analytics === undefined && defaultTabs.analytics);
                document.getElementById('tab-user-settings').checked = tabs.settings === true || (tabs.settings === undefined && defaultTabs.settings);
                
                if (settingsDiv) settingsDiv.style.display = 'block';
                if (saveBtn) saveBtn.disabled = false;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const defaultTabs = selectedUser?.role === 'manager' ? {
                    dashboard: true, chats: true, buyout: true, deliveries: true, quick_replies: true,
                    shops: false, analytics: false, settings: false
                } : {
                    dashboard: true, chats: true, buyout: true, deliveries: true, quick_replies: true,
                    shops: true, analytics: true, settings: true
                };
                
                document.getElementById('tab-user-dashboard').checked = defaultTabs.dashboard;
                document.getElementById('tab-user-chats').checked = defaultTabs.chats;
                document.getElementById('tab-user-buyout').checked = defaultTabs.buyout;
                document.getElementById('tab-user-deliveries').checked = defaultTabs.deliveries;
                document.getElementById('tab-user-quick-replies').checked = defaultTabs.quick_replies;
                document.getElementById('tab-user-shops').checked = defaultTabs.shops;
                document.getElementById('tab-user-analytics').checked = defaultTabs.analytics;
                document.getElementById('tab-user-settings').checked = defaultTabs.settings;
                
                if (settingsDiv) settingsDiv.style.display = 'block';
                if (saveBtn) saveBtn.disabled = false;
            }
            {% endif %}
        }
        
        async function saveTabVisibility() {
            {% if user and user.get('role') == 'super_admin' %}
            const userId = document.getElementById('tab-visibility-user-select')?.value;
            if (!userId) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            const tabs = {
                dashboard: document.getElementById('tab-user-dashboard').checked,
                chats: document.getElementById('tab-user-chats').checked,
                buyout: document.getElementById('tab-user-buyout').checked,
                deliveries: document.getElementById('tab-user-deliveries').checked,
                quick_replies: document.getElementById('tab-user-quick-replies').checked,
                shops: document.getElementById('tab-user-shops').checked,
                analytics: document.getElementById('tab-user-analytics').checked,
                settings: document.getElementById('tab-user-settings').checked
            };
            
            try {
                const resp = await fetch(`/api/users/${userId}/tab-visibility`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ tab_visibility: tabs })
                });
                
                const contentType = resp.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await resp.text();
                    console.error('–ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫:', text.substring(0, 200));
                    showStatus('‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç', 'error');
                    return;
                }
                
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showStatus('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                } else {
                    const errorMsg = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    showStatus(`‚ùå ${errorMsg}`, 'error');
                }
            } catch (e) {
                console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫:', e);
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (e.message || String(e)), 'error');
            }
            {% endif %}
        }

        async function deleteSelectedShop() {
            const shopId = document.getElementById('avito-shop-select')?.value;
            if (!shopId) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            const shopsList = window.avitoShops || [];
            const shop = shopsList.find(s => String(s.id) === String(shopId));
            const shopName = shop ? shop.name : '–º–∞–≥–∞–∑–∏–Ω';
            
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω "${shopName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
                return;
            }
            
            try {
                const resp = await fetch(`/api/shops/${shopId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                const contentType = resp.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await resp.text();
                    console.error('–ü–æ–ª—É—á–µ–Ω –Ω–µ-JSON –æ—Ç–≤–µ—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', text.substring(0, 200));
                    showStatus('‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON –æ—Ç–≤–µ—Ç', 'error');
                    return;
                }
                
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showStatus('‚úÖ –ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤
                    await window.loadAvitoShops();
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                    populateAvitoFields('');
                    const deleteBtn = document.getElementById('delete-shop-btn');
                    if (deleteBtn) deleteBtn.disabled = true;
                } else {
                    const errorMsg = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω';
                    showStatus(`‚ùå ${errorMsg}`, 'error');
                }
            } catch (e) {
                console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', e);
                showStatus('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞: ' + (e.message || String(e)), 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è createUser —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –±–ª–æ–∫–µ early_scripts

        // toggleSecret —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –±–ª–æ–∫–µ early_scripts –∫–∞–∫ window.toggleSecret, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ø—Ä–∏–º–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞)
        const modal = {
            backdrop: null,
            resolve: null,
        };

        function ensureModal() {
            if (modal.backdrop) return;
            const html = `
                <div class="modal-backdrop" id="confirm-backdrop">
                    <div class="modal">
                        <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
                        <p id="confirm-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
                        <div class="modal-actions">
                            <button class="btn-outline" id="confirm-cancel">–û—Ç–º–µ–Ω–∞</button>
                            <button class="btn-danger" id="confirm-ok">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            modal.backdrop = document.getElementById('confirm-backdrop');
            modal.backdrop.querySelector('#confirm-cancel').addEventListener('click', () => closeConfirm(false));
            modal.backdrop.querySelector('#confirm-ok').addEventListener('click', () => closeConfirm(true));
        }

        function confirmAction(title, text) {
            ensureModal();
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            modal.backdrop.style.display = 'flex';
            return new Promise((resolve) => {
                modal.resolve = resolve;
            });
        }

        function closeConfirm(result) {
            if (modal.backdrop) modal.backdrop.style.display = 'none';
            if (modal.resolve) modal.resolve(result);
            modal.resolve = null;
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
        document.querySelectorAll('.color-picker').forEach(input => {
            input.addEventListener('input', function() {
                const textInput = document.getElementById(this.id + '-text');
                if (textInput) {
                    textInput.value = this.value;
                }
            });
        });

        document.querySelectorAll('.color-text').forEach(input => {
            input.addEventListener('input', function() {
                const colorInput = document.getElementById(this.id.replace('-text', ''));
                if (colorInput && /^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorInput.value = this.value;
                }
            });
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function switchTheme(theme, save = true) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });

            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            }

            if (save) {
                saveUserSettings();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function saveUserSettings() {
            const theme = document.querySelector('.theme-btn.active')?.dataset.theme || 'dark';
            
            try {
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        theme: theme,
                        sound_alerts: document.getElementById('sound-enabled').checked,
                        push_notifications: document.getElementById('push-enabled').checked
                    })
                });

                if (response.ok) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function saveSettings() {
            try {
                {% if user and (user.get('role') == 'admin' or user.get('role') == 'super_admin') %}
                const systemData = {
                    timer_new_chat_hours: parseInt(document.getElementById('timer-new-chat').value),
                    timer_urgent_minutes: parseInt(document.getElementById('timer-urgent').value),
                    timer_critical_minutes: parseInt(document.getElementById('timer-critical').value),
                    notification_blink_interval: parseInt(document.getElementById('notification-blink').value),
                    color_urgent: document.getElementById('color-urgent').value,
                    color_new: document.getElementById('color-new').value,
                    color_active: document.getElementById('color-active').value,
                    color_delivery: document.getElementById('color-delivery').value,
                    push_enabled: document.getElementById('push-enabled').checked,
                    sound_enabled: document.getElementById('sound-enabled').checked
                };

                const systemResponse = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(systemData)
                });

                if (systemResponse.ok) {
                    console.log('–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
                {% endif %}

                await saveUserSettings();

                showStatus('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'status-message ' + type;
                statusEl.style.display = 'block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initShopModalHandlers() {
            console.log('[INIT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞...');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
            const createShopBtn = document.getElementById('create-shop-btn');
            console.log('[INIT] –ö–Ω–æ–ø–∫–∞ create-shop-btn:', createShopBtn);
            if (createShopBtn) {
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                const newBtn = createShopBtn.cloneNode(true);
                createShopBtn.parentNode.replaceChild(newBtn, createShopBtn);
                const btn = document.getElementById('create-shop-btn');
                
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[CLICK] –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
                    if (typeof window.showCreateShopModal === 'function') {
                        window.showCreateShopModal();
                    } else {
                        console.error('[ERROR] –§—É–Ω–∫—Ü–∏—è window.showCreateShopModal –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
                        alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).');
                    }
                    return false;
                });
                console.log('[INIT] ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω –∫ –∫–Ω–æ–ø–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞');
                console.log('[TEST] –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ showCreateShopModal:', typeof window.showCreateShopModal);
            } else {
                console.warn('[WARN] ‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ create-shop-btn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã –∫–∞–∫ admin –∏–ª–∏ super_admin.');
            }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
                const createShopSubmitBtn = document.getElementById('create-shop-submit-btn');
                console.log('–ö–Ω–æ–ø–∫–∞ create-shop-submit-btn:', createShopSubmitBtn);
                if (createShopSubmitBtn) {
                    createShopSubmitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[EVENT LISTENER] –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ addEventListener');
                        console.log('[EVENT LISTENER] window.createShop:', typeof window.createShop);
                        if (typeof window.createShop === 'function') {
                            console.log('[EVENT LISTENER] –í—ã–∑—ã–≤–∞–µ–º window.createShop()...');
                            window.createShop().catch(err => {
                                console.error('[EVENT LISTENER] –û—à–∏–±–∫–∞ –≤ createShop:', err);
                            });
                        } else {
                            console.error('[ERROR] –§—É–Ω–∫—Ü–∏—è window.createShop –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
                            alert('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è createShop –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12).');
                        }
                        return false;
                    });
                    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω –∫ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã');
                } else {
                    console.warn('–ö–Ω–æ–ø–∫–∞ create-shop-submit-btn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
                const createShopCancelBtn = document.getElementById('create-shop-cancel-btn');
                if (createShopCancelBtn) {
                    createShopCancelBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.closeCreateShopModal === 'function') {
                            window.closeCreateShopModal();
                        }
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–∫—Ä–µ—Å—Ç–∏–∫)
                const createShopCloseBtn = document.getElementById('create-shop-close-btn');
                if (createShopCloseBtn) {
                    createShopCloseBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.closeCreateShopModal === 'function') {
                            window.closeCreateShopModal();
                        }
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const modal = document.getElementById('create-shop-modal');
                console.log('[INIT] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ create-shop-modal:', modal);
                if (modal) {
                    console.log('[INIT] ‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–π–¥–µ–Ω–æ');
                } else {
                    console.error('[ERROR] ‚ùå –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
                }
            }, 100);
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É (–Ω–∞ —Å–ª—É—á–∞–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
        setTimeout(function() {
            console.log('[DELAYED CHECK] –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É...');
            const btn = document.getElementById('create-shop-btn');
            console.log('[DELAYED CHECK] –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', btn);
            console.log('[DELAYED CHECK] –§—É–Ω–∫—Ü–∏—è showCreateShopModal:', typeof window.showCreateShopModal);
            if (btn && !btn.hasAttribute('data-listener-added')) {
                console.log('[DELAYED INIT] –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π...');
                btn.setAttribute('data-listener-added', 'true');
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[DELAYED CLICK] –ö–ª–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
                    if (typeof window.showCreateShopModal === 'function') {
                        window.showCreateShopModal();
                    } else {
                        console.error('[ERROR] window.showCreateShopModal –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
                    }
                    return false;
                });
            }
        }, 1000);
        
        // –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        (function testFunctions() {
            console.log('[GLOBAL TEST] showCreateShopModal –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:', typeof window.showCreateShopModal);
            console.log('[GLOBAL TEST] closeCreateShopModal –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:', typeof window.closeCreateShopModal);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                const btn = document.getElementById('create-shop-btn');
                console.log('[GLOBAL TEST] –ö–Ω–æ–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', btn !== null);
                if (btn) {
                    console.log('[GLOBAL TEST] –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫...');
                    btn.onclick = function() {
                        console.log('[TEST CLICK] –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ —á–µ—Ä–µ–∑ onclick!');
                        if (typeof window.showCreateShopModal === 'function') {
                            window.showCreateShopModal();
                        } else {
                            alert('–§—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                        }
                    };
                }
            }, 500);
        })();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
        (function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initEditShopModalHandlers);
            } else {
                initEditShopModalHandlers();
            }
            
            function initEditShopModalHandlers() {
                const modal = document.getElementById('edit-shop-modal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            if (typeof window.closeEditShopModal === 'function') {
                                window.closeEditShopModal();
                            }
                        }
                    });
                }
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('edit-shop-modal');
                        if (modal && modal.style.display === 'flex') {
                            if (typeof window.closeEditShopModal === 'function') {
                                window.closeEditShopModal();
                            }
                        }
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const editShopSubmitBtn = document.getElementById('edit-shop-submit-btn');
                if (editShopSubmitBtn) {
                    editShopSubmitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.updateShop === 'function') {
                            window.updateShop().catch(err => {
                                console.error('[EVENT LISTENER] –û—à–∏–±–∫–∞ –≤ updateShop:', err);
                            });
                        }
                        return false;
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const editShopCancelBtn = document.getElementById('edit-shop-cancel-btn');
                if (editShopCancelBtn) {
                    editShopCancelBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.closeEditShopModal === 'function') {
                            window.closeEditShopModal();
                        }
                        return false;
                    });
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–∫—Ä–µ—Å—Ç–∏–∫)
                const editShopCloseBtn = document.getElementById('edit-shop-close-btn');
                if (editShopCloseBtn) {
                    editShopCloseBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.closeEditShopModal === 'function') {
                            window.closeEditShopModal();
                        }
                        return false;
                    });
                }
            }
        })();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadSettings);
        } else {
            loadSettings();
        }
{% endblock %}


{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - OSAGAMING CRM{% endblock %}

{% block styles %}
<style>
    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .analytics-section {
        margin-bottom: 2.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        text-align: center;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.2s;
    }

    .stat-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .stat-label {
        color: var(--text-muted);
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .stat-sublabel {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
        opacity: 0.8;
    }

    .stat-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: calc(var(--radius) / 2);
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .badge-avito {
        background: color-mix(in srgb, var(--primary) 20%, transparent);
        color: var(--primary);
    }

    .badge-db {
        background: color-mix(in srgb, #10b981 20%, transparent);
        color: #10b981;
    }

    .analytics-table-container {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    thead {
        background: var(--bg-secondary);
    }

    th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--text);
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }

    td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid var(--border);
        color: var(--text);
        font-size: 0.875rem;
    }

    tbody tr {
        transition: background 0.2s;
    }

    tbody tr:hover {
        background: color-mix(in srgb, var(--bg-secondary) 50%, transparent);
    }

    tbody tr:last-child td {
        border-bottom: none;
    }

    .status-ok {
        color: #10b981;
        font-weight: 600;
    }

    .status-warning {
        color: #f59e0b;
        font-weight: 600;
    }

    .status-error {
        color: #ef4444;
        font-weight: 600;
    }

    .refresh-btn {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1.5rem;
    }

    .refresh-btn:hover {
        background: var(--gradient-primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    .metric-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .metric-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .metric-info {
        flex: 1;
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
    }

    .metric-icon {
        font-size: 2rem;
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>

<button class="refresh-btn" onclick="loadAnalytics()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="analytics-section">
    <h2 class="section-title">üìà –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_chats }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤ (–ë–î)</div>
            {% if stats.avito_stats %}
            <div class="stat-sublabel">–í Avito: {{ stats.avito_stats.total_chats_avito }}</div>
            {% endif %}
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.active_chats }}</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
            {% if stats.avito_stats %}
            <div class="stat-sublabel">–í Avito: {{ stats.avito_stats.active_chats_avito }}</div>
            {% endif %}
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.urgent_chats }}</div>
            <div class="stat-label">–°—Ä–æ—á–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.unread_chats if stats.unread_chats else 0 }}</div>
            <div class="stat-label">–° –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏</div>
            {% if stats.avito_stats %}
            <div class="stat-sublabel">–°–æ–æ–±—â–µ–Ω–∏–π: {{ stats.avito_stats.unread_messages_avito }}</div>
            {% endif %}
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.pool_chats if stats.pool_chats else 0 }}</div>
            <div class="stat-label">–í –ø—É–ª–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.avg_response_time if stats.avg_response_time else 0 }}</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–º–∏–Ω)</div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ Avito API -->
{% if stats.avito_stats %}
<div class="analytics-section">
    <h2 class="section-title">üîó –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ Avito API</h2>
    
    <div class="stats-grid">
        {% if stats.avito_stats.blocked_chats_avito %}
        <div class="stat-card">
            <div class="stat-value">{{ stats.avito_stats.blocked_chats_avito }}</div>
            <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
            <span class="stat-badge badge-avito">Avito API</span>
        </div>
        {% endif %}
        {% if stats.avito_stats.archived_chats_avito %}
        <div class="stat-card">
            <div class="stat-value">{{ stats.avito_stats.archived_chats_avito }}</div>
            <div class="stat-label">–ê—Ä—Ö–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
            <span class="stat-badge badge-avito">Avito API</span>
        </div>
        {% endif %}
        {% if stats.avito_stats.shops_synced %}
        <div class="stat-card">
            <div class="stat-value">{{ stats.avito_stats.shops_synced }}</div>
            <div class="stat-label">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤</div>
            {% if stats.avito_stats.last_sync_time %}
            <div class="stat-sublabel">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ stats.avito_stats.last_sync_time[:19] }}</div>
            {% endif %}
            <span class="stat-badge badge-avito">Avito API</span>
        </div>
        {% endif %}
    </div>

    {% if stats.avito_stats.account_stats %}
    <div class="analytics-section" style="margin-top: 2rem;">
        <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ Avito (30 –¥–Ω–µ–π)</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ stats.avito_stats.account_stats.total_views_30d }}</div>
                <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                <div class="stat-sublabel">–ü–µ—Ä–∏–æ–¥: {{ stats.avito_stats.account_stats.period }}</div>
                <span class="stat-badge badge-avito">Avito API</span>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.avito_stats.account_stats.total_contacts_30d }}</div>
                <div class="stat-label">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ (–∑–≤–æ–Ω–∫–∏/—Å–æ–æ–±—â–µ–Ω–∏—è)</div>
                <div class="stat-sublabel">–ü–µ—Ä–∏–æ–¥: {{ stats.avito_stats.account_stats.period }}</div>
                <span class="stat-badge badge-avito">Avito API</span>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.avito_stats.account_stats.total_favorites_30d }}</div>
                <div class="stat-label">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
                <div class="stat-sublabel">–ü–µ—Ä–∏–æ–¥: {{ stats.avito_stats.account_stats.period }}</div>
                <span class="stat-badge badge-avito">Avito API</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –º–∞–≥–∞–∑–∏–Ω–∞–º -->
<div class="analytics-section">
    <h2 class="section-title">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –º–∞–≥–∞–∑–∏–Ω—ã</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_users }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_managers }}</div>
            <div class="stat-label">–ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_shops }}</div>
            <div class="stat-label">–ú–∞–≥–∞–∑–∏–Ω–æ–≤</div>
            {% if stats.shops_with_keys %}
            <div class="stat-sublabel">–° –∫–ª—é—á–∞–º–∏: {{ stats.shops_with_keys }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º -->
<div class="analytics-section">
    <h2 class="section-title">üè™ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º</h2>
    <div class="analytics-table-container">
        <table>
            <thead>
                <tr>
                    <th>–ú–∞–≥–∞–∑–∏–Ω</th>
                    <th>–ß–∞—Ç–æ–≤</th>
                    <th>–ê–∫—Ç–∏–≤–Ω—ã–µ</th>
                    <th>–°—Ä–æ—á–Ω—ã–µ</th>
                    <th>–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</th>
                    <th>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–º–∏–Ω)</th>
                    <th>Webhook</th>
                    <th>–ö–ª—é—á–∏</th>
                </tr>
            </thead>
            <tbody id="shops-analytics-body">
                <tr><td colspan="8" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function loadAnalytics() {
        try {
            const btn = event?.target;
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
            await loadShopsAnalytics();
            
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
            if (event?.target) {
                event.target.disabled = false;
                event.target.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            }
        }
    }

    async function loadShopsAnalytics() {
        const body = document.getElementById('shops-analytics-body');
        if (!body) return;
        
        try {
            const resp = await fetch('/api/shops/analytics', {
                headers: {
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            if (!resp.ok) {
                throw new Error('Failed to load shops analytics');
            }
            
            const data = await resp.json();
            
            if (!Array.isArray(data) || data.length === 0) {
                body.innerHTML = '<tr><td colspan="8" class="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞–≥–∞–∑–∏–Ω–∞—Ö</td></tr>';
                return;
            }
            
            body.innerHTML = data.map(item => {
                const webhook = item.webhook_registered ? '<span class="status-ok">‚úÖ</span>' : '<span class="status-warning">‚ö†Ô∏è</span>';
                const creds = item.token_status || item.avito_status || 'unknown';
                const credsClass = creds === 'ok' ? 'status-ok' : 'status-error';
                const credsLabel = creds === 'ok' ? '‚úÖ OK' : (creds || '‚Äî');
                const avg = item.avg_response_timer ? Number(item.avg_response_timer).toFixed(1) : '‚Äî';
                
                return `
                    <tr>
                        <td><strong>${item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong></td>
                        <td>${item.total_chats || 0}</td>
                        <td>${item.active_chats || 0}</td>
                        <td>${item.urgent_chats || 0}</td>
                        <td>${item.chats_with_unread || 0}</td>
                        <td>${avg}</td>
                        <td>${webhook}</td>
                        <td class="${credsClass}">${credsLabel}</td>
                    </tr>
                `;
            }).join('');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º:', e);
            body.innerHTML = '<tr><td colspan="8" class="loading" style="color: var(--error, #ef4444);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadShopsAnalytics();
</script>
{% endblock %}

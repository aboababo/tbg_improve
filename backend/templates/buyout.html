{% extends "base.html" %}

{% block title %}–í—ã–∫—É–ø - OSAGAMING CRM{% endblock %}

{% block styles %}
<style>
    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }
    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        box-shadow: var(--shadow);
    }
    .btn {
        padding: 0.65rem 1rem;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: var(--primary);
        color: #fff;
        cursor: pointer;
    }
    .btn.secondary {
        background: var(--bg-secondary);
        color: var(--text);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    th, td {
        border: 1px solid var(--border);
        padding: 0.65rem;
        text-align: left;
        vertical-align: top;
    }
    th {
        background: var(--bg-secondary);
        font-weight: 700;
    }
    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }
    .muted { color: var(--text-muted); font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">üõí –í—ã–∫—É–ø –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>

<div class="card">
    <div class="filters">
        <div>
            <label class="muted">–ü–æ–∏—Å–∫</label>
            <input id="filter-query" class="form-input" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞">
        </div>
        <div>
            <label class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è ID</label>
            <input id="filter-category" class="form-input" type="number" min="0" placeholder="–Ω–∞–ø—Ä. 10">
        </div>
        <div>
            <label class="muted">–õ–æ–∫–∞—Ü–∏—è ID</label>
            <input id="filter-location" class="form-input" type="number" min="0" placeholder="–Ω–∞–ø—Ä. 650000">
        </div>
        <div>
            <label class="muted">–¶–µ–Ω–∞ –æ—Ç</label>
            <input id="filter-price-min" class="form-input" type="number" min="0">
        </div>
        <div>
            <label class="muted">–¶–µ–Ω–∞ –¥–æ</label>
            <input id="filter-price-max" class="form-input" type="number" min="0">
        </div>
        <div>
            <label class="muted">–õ–∏–º–∏—Ç</label>
            <input id="filter-limit" class="form-input" type="number" min="1" max="200" value="50">
        </div>
    </div>
    <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
        <button class="btn" onclick="searchBuyout(true)">üîé –ò—Å–∫–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn secondary" onclick="searchBuyout(false)">–ò—Å–∫–∞—Ç—å –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</button>
        <button class="btn secondary" onclick="toggleAutoRefresh()">üîÅ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="auto-refresh-label">–≤—ã–∫–ª</span></button>
    </div>
    <div id="buyout-status" class="muted" style="margin-top:0.5rem;"></div>
</div>

<div class="card" style="margin-top:1rem; overflow:auto;">
    <table>
        <thead>
            <tr>
                <th>–û–±—ä—è–≤–ª–µ–Ω–∏–µ</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–õ–æ–∫–∞—Ü–∏—è</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="buyout-table">
            <tr><td colspan="4" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
        </tbody>
    </table>
</div>

<script>
    let autoRefresh = false;
    let autoTimer = null;
    let lastPayload = null;

    function setStatus(text) {
        document.getElementById('buyout-status').textContent = text || '';
    }

    function toggleAutoRefresh() {
        autoRefresh = !autoRefresh;
        document.getElementById('auto-refresh-label').textContent = autoRefresh ? '–≤–∫–ª' : '–≤—ã–∫–ª';
        if (autoRefresh && lastPayload) {
            scheduleAuto();
        } else if (!autoRefresh && autoTimer) {
            clearInterval(autoTimer);
        }
    }

    function scheduleAuto() {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(() => {
            if (lastPayload) {
                searchBuyout(lastPayload.save_results, false);
            }
        }, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    }

    async function searchBuyout(save_results = true, updatePayload = true) {
        const payload = {
            query: document.getElementById('filter-query').value.trim(),
            category_id: parseInt(document.getElementById('filter-category').value) || null,
            location_id: parseInt(document.getElementById('filter-location').value) || null,
            price_min: parseFloat(document.getElementById('filter-price-min').value) || null,
            price_max: parseFloat(document.getElementById('filter-price-max').value) || null,
            limit: Math.min(Math.max(parseInt(document.getElementById('filter-limit').value) || 50, 1), 200),
            save_results
        };
        if (updatePayload) {
            lastPayload = payload;
            if (autoRefresh) scheduleAuto();
        }
        setStatus('–ó–∞–≥—Ä—É–∑–∫–∞...');
        try {
            const resp = await fetch('/api/listings/search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                setStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                return;
            }
            const data = await resp.json();
            renderListings(data.listings || []);
            setStatus(`–ù–∞–π–¥–µ–Ω–æ: ${data.total || data.listings?.length || 0}${save_results ? ', —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + (data.saved || 0) : ''}`);
        } catch (e) {
            console.error(e);
            setStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
        }
    }

    function renderListings(list) {
        const tbody = document.getElementById('buyout-table');
        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        tbody.innerHTML = list.map(item => {
            const price = item.price ? item.price + ' ‚ÇΩ' : '-';
            const statusDot = item.status === 'new' ? '#22c55e' : '#f59e0b';
            return `
                <tr>
                    <td>
                        <div><a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</a></div>
                        <div class="muted">${item.description ? item.description.slice(0, 120) + '...' : ''}</div>
                    </td>
                    <td>${price}</td>
                    <td>${item.location || ''}</td>
                    <td><span class="status-dot" style="background:${statusDot};"></span> ${item.status || 'new'}</td>
                </tr>
            `;
        }).join('');
    }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}–ß–∞—Ç—ã - OSAGAMING CRM{% endblock %}

{% block styles %}
    <style>
        * {
            box-sizing: border-box;
        }

        /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        html {
            height: 100%;
            overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ html */
        }
        
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ body */
        }
        
        /* –£–±–∏—Ä–∞–µ–º padding –∏ margin —É main-content –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–∞—Ç–æ–≤ */
        body .main-content {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
            /* –í—ã—Å–æ—Ç–∞: 100vh –º–∏–Ω—É—Å –≤—ã—Å–æ—Ç–∞ header (padding 0.85rem*2 + –∫–æ–Ω—Ç–µ–Ω—Ç ~50px = ~70px) */
            height: calc(100vh - 70px) !important;
            max-height: calc(100vh - 70px) !important;
            min-height: calc(100vh - 70px) !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–∏–º–∞—Ç—å –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ header */
        .chats-page {
            /* –ó–∞–Ω–∏–º–∞–µ—Ç 100% –≤—ã—Å–æ—Ç—ã —Ä–æ–¥–∏—Ç–µ–ª—è (main-content) */
            height: 100%;
            max-height: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
            margin: 0;
            padding: 0;
            position: relative;
            box-sizing: border-box;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π layout - 3 –∫–æ–ª–æ–Ω–∫–∏: —á–∞—Ç—ã | —Å–æ–æ–±—â–µ–Ω–∏—è | –æ–±—ä—è–≤–ª–µ–Ω–∏–µ */
        .chats-container {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr 400px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
            gap: 0;
            overflow: hidden;
            min-height: 0;
            position: relative;
            width: 100%;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å */
        @media (max-width: 1200px) {
            .chats-container {
                grid-template-columns: 320px 1fr;
            }
            .listing-sidebar {
                display: none;
            }
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: —É–±—Ä–∞–Ω—ã blur –∏ —Å–ª–æ–∂–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .sidebar {
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è grid */
            max-width: 320px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        }

        .sidebar-top {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--card);
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 900;
            margin: 0 0 0.75rem 0;
            color: var(--primary);
        }

        .search-box {
            position: relative;
            margin-bottom: 0.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 2px);
            color: var(--text);
            font-size: 0.8125rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--card);
        }

        .search-icon {
            position: absolute;
            left: 0.625rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filters-row {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters-row-main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.375rem;
        }

        .filters-row-secondary {
            display: flex;
            gap: 0.375rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 0.375rem 0.75rem;
            border: 1.5px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.6875rem;
            font-weight: 600;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            position: relative;
            min-height: 28px;
            flex: 1;
            min-width: 0;
        }

        .filter-chip:hover {
            background: var(--bg);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);
            font-weight: 700;
        }

        .filter-chip.active:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .filter-chip span {
            font-weight: 700;
            opacity: 0.9;
        }

        .filter-chip.active span {
            opacity: 1;
        }

        .sort-buttons-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sort-chip {
            padding: 0.375rem 0.625rem;
            border: 1.5px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.6875rem;
            font-weight: 600;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
            min-height: 26px;
        }

        .sort-chip:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .sort-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .return-all-btn {
            padding: 0.375rem 0.75rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: 1.5px solid #dc2626;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.6875rem;
            font-weight: 700;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            min-height: 26px;
        }

        .return-all-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }

        .return-all-btn:active {
            transform: translateY(0);
        }

        .return-all-btn.hidden {
            display: none;
        }

        .extract-product-urls-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: 2px solid #7c3aed;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            min-height: 34px;
        }

        .extract-product-urls-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            border-color: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .extract-product-urls-btn:active {
            transform: translateY(0);
        }

        .extract-product-urls-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .filter-chip.pool.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.375rem;
            min-height: 0;
        }

        .chats-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .chats-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .chats-scroll::-webkit-scrollbar-thumb {
            background: color-mix(in srgb, var(--text-muted) 30%, transparent);
            border-radius: 3px;
        }

        .chats-scroll::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--text-muted) 50%, transparent);
        }

        .load-more-btn {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: calc(var(--radius));
            cursor: pointer;
            font-weight: 700;
            color: var(--text);
        }

        .load-more-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 4px);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: none !important; /* –£–±—Ä–∞–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–æ—Ä–≥–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ */
            cursor: pointer;
        }
        
        .chat-card * {
            transition: none !important; /* –£–±–∏—Ä–∞–µ–º transitions –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞ */
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ transition: none */
        .chat-card.blink-red {
            animation: blinkRed 1s infinite !important;
        }

        .chat-card:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .chat-card.selected {
            background: var(--bg);
            border-color: var(--primary);
        }

        .chat-card.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chat-card.pool {
            border-left: 4px solid #10b981;
        }

        /* –ú–∏–≥–∞–Ω–∏–µ –¥–ª—è —á–∞—Ç–æ–≤ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –±–æ–ª–µ–µ 20 –º–∏–Ω—É—Ç */
        .chat-card.blink-red {
            animation: blinkRed 1s infinite;
            border-left: 4px solid #ef4444;
        }

        @keyframes blinkRed {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 0 10px 3px rgba(239, 68, 68, 0.6);
            }
        }

        .chat-card.delivery {
            border-left: 4px solid #8b5cf6;
        }


        .chat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.375rem;
        }

        .chat-card-title {
            flex: 1;
            min-width: 0;
        }

        .chat-client-name {
            font-weight: 700;
            font-size: 0.8125rem;
            margin-bottom: 0.1875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-shop-name {
            font-size: 0.625rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 0.125rem 0.375rem;
            border-radius: 8px;
            display: inline-block;
            font-weight: 500;
        }

        .chat-card.active .chat-shop-name {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .chat-badges {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }

        .pool-badge {
            background: #10b981;
            color: white;
            padding: 0.1875rem 0.5rem;
            border-radius: 10px;
            font-size: 0.625rem;
            font-weight: 700;
        }

        .unread-count {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 700;
        }

        .chat-preview {
            font-size: 0.6875rem;
            color: var(--text-muted);
            line-height: 1.3;
            margin-bottom: 0.375rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .chat-card.active .chat-preview {
            color: rgba(255, 255, 255, 0.85);
        }

        .chat-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .chat-card.active .chat-footer {
            border-top-color: rgba(255, 255, 255, 0.2);
        }

        .priority-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .priority-urgent {
            background: #ef4444;
            color: white;
        }

        .priority-new {
            background: #f59e0b;
            color: white;
        }

        .priority-active {
            background: #10b981;
            color: white;
        }

        .priority-delivery {
            background: #8b5cf6;
            color: white;
        }

        .response-time {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.1875rem 0.375rem;
            border-radius: calc(var(--radius));
            display: inline-flex;
            align-items: center;
            gap: 0.1875rem;
        }

        .response-time.urgent {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .response-time.warning {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .response-time.normal {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        /* –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: —É–±—Ä–∞–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è */
        .response-time.blink {
            color: #ef4444;
            font-weight: 700;
        }

        .chat-card.active .response-time {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-card.active .response-time.urgent {
            background: rgba(239, 68, 68, 0.3);
        }

        .pool-action-btn {
            width: 100%;
            padding: 0.75rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .pool-action-btn:hover {
            background: #059669;
        }

        /* –ë—ã—Å—Ç—Ä–∞—è –∫–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å" –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .quick-take-btn {
            padding: 0.375rem 0.75rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: calc(var(--radius));
            cursor: pointer;
            font-weight: 700;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .quick-take-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: scale(1.05);
        }

        .quick-take-btn:active {
            transform: scale(0.98);
        }

        .quick-take-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        .chat-card-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 0.375rem 0.625rem;
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .quick-action-btn.return {
            background: #f59e0b;
            color: white;
            border-color: transparent;
        }

        .quick-action-btn.return:hover {
            background: #d97706;
        }

        .return-action-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .return-action-btn:hover {
            background: #d97706;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º */
        .listing-sidebar {
            background: var(--card);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è grid */
            width: 400px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
            max-width: 500px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            flex: 0 0 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≤ grid */
        }

        .listing-sidebar-header {
            padding: 0.75rem 1rem; /* –£–º–µ–Ω—å—à–∏–ª–∏ padding */
            border-bottom: 1px solid var(--border);
            background: var(--card);
            flex-shrink: 0;
        }

        .listing-sidebar-title {
            font-size: 1rem; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            font-weight: 700;
            margin: 0;
            color: var(--text);
        }

        .listing-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem; /* –£–≤–µ–ª–∏—á–µ–Ω padding –¥–ª—è –ª—É—á—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
        }

        .listing-sidebar-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }

        .listing-sidebar-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .listing-sidebar-empty p {
            margin: 0;
            font-size: 0.875rem;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è */
        .listing-card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 1rem; /* –£–≤–µ–ª–∏—á–µ–Ω padding –¥–ª—è –ª—É—á—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
            margin-bottom: 0.75rem;
            width: 100%;
            box-sizing: border-box;
        }

        .listing-card-image {
            width: 100%;
            border-radius: var(--radius);
            max-height: 350px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
            object-fit: cover;
            margin-bottom: 0.75rem;
            display: block;
        }

        .listing-card-title {
            font-size: 1.125rem; /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
            font-weight: 600;
            margin: 0 0 0.75rem 0;
            color: var(--text);
            line-height: 1.4;
        }

        .listing-card-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 1rem 0;
        }

        .listing-card-actions {
            margin-top: 1rem;
        }

        .listing-card-link {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: var(--radius);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .listing-card-link:hover {
            background: var(--primary-dark);
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--bg);
            overflow: hidden;
            position: relative;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è grid */
            max-width: 100%; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
        }

        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .chat-header-bar {
            padding: 1rem 1.25rem;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
            flex-grow: 0; /* –ù–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
            align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–Ω–æ–ø–æ–∫ */
            flex-shrink: 0;
            gap: 1rem; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è grid */
            width: 100%;
            box-sizing: border-box;
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
            max-width: 50%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
            overflow: hidden;
        }

        .chat-header-name {
            font-size: 1.125rem;
            font-weight: 800;
            margin: 0 0 0.25rem 0;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-details {
            display: flex;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 1;
            flex-wrap: wrap; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∞–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
            max-width: 50%; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é */
            min-width: 0;
        }

        .header-action-btn {
            padding: 0.5rem 0.875rem;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: calc(var(--radius));
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
            max-width: 200px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–Ω–æ–ø–æ–∫ */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-action-btn:hover {
            background: var(--bg-secondary);
        }

        .header-action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .header-action-btn.primary:hover {
            background: var(--primary);
            opacity: 0.9;
        }

        .messages-view {
            flex: 1 1 auto; /* –ú–æ–∂–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è, –Ω–æ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.75rem 1rem;
            background: var(--bg);
            min-height: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex - –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è */
            scroll-behavior: smooth;
            position: relative;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }

        .messages-view::-webkit-scrollbar {
            width: 8px;
        }

        .messages-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-view::-webkit-scrollbar-thumb {
            background: color-mix(in srgb, var(--text-muted) 30%, transparent);
            border-radius: 4px;
        }

        .messages-view::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--text-muted) 50%, transparent);
        }

        .message-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.25rem;
            width: 100%;
            box-sizing: border-box;
        }

        .message-row.incoming {
            align-items: flex-start;
        }

        .message-row.outgoing {
            align-items: flex-end;
        }

        .message-author {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            padding: 0 0.75rem;
            font-weight: 600;
            opacity: 0.85;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-style: italic;
        }
        
        .message-row.outgoing .message-author {
            justify-content: flex-end;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .message-row.incoming .message-author {
            justify-content: flex-start;
        }
        
        /* –ü–æ–¥–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É */
        .message-author::before {
            content: "üë§ ";
            opacity: 0.7;
        }

        .message-wrapper {
            max-width: 70%;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex */
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            padding: 1rem 1.375rem;
            border-radius: calc(var(--radius) + 8px);
            font-size: 0.9375rem;
            line-height: 1.65;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex */
        }

        .message-row.incoming .message-bubble {
            background: var(--bg-secondary);
            color: var(--text);
            border-bottom-left-radius: 8px;
        }

        .message-row.outgoing .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 8px;
        }

        .message-time {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0 0.75rem;
            opacity: 0.7;
        }

        .input-section {
            padding: 1.25rem 2rem 1.25rem 2rem; /* –£–º–µ–Ω—å—à–µ–Ω padding –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–±—Ä–µ–∑–∞–Ω–∏—è */
            background: var(--card);
            border-top: 2px solid var(--border);
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
            flex-grow: 0; /* –ù–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            overflow: visible; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –Ω–µ –æ–±—Ä–µ–∑–∞—é—Ç—Å—è */
            margin-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            position: relative; /* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
            z-index: 10; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–µ–∫—Ü–∏—è –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        }

        .quick-actions-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem; /* –£–º–µ–Ω—å—à–µ–Ω –æ—Ç—Å—Ç—É–ø */
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 0.5rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .quick-action:hover {
            background: var(--bg);
        }

        .quick-action.is-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .send-button:disabled,
        .message-field:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-row {
            display: flex;
            gap: 0.875rem;
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            width: 100%;
            box-sizing: border-box;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex */
            flex-wrap: nowrap; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            overflow: visible; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –Ω–µ –æ–±—Ä–µ–∑–∞—é—Ç—Å—è */
            position: relative; /* –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
            margin-top: 0; /* –£–±—Ä–∞–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            margin-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
            padding-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –Ω–∏–∂–Ω–∏–π padding */
        }

        .message-field {
            flex: 1;
            padding: 1.125rem 1.5rem;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: calc(var(--radius) + 6px);
            color: var(--text);
            font-size: 0.9375rem;
            resize: none;
            min-height: 56px;
            height: 56px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
            max-height: 140px;
            font-family: inherit;
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex - –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è */
            box-sizing: border-box;
            vertical-align: middle; /* –ü—Ä—è–º–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
            line-height: 1.5; /* –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ */
        }

        .message-field:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg);
        }

        .send-button {
            padding: 1.125rem 2.25rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: calc(var(--radius) + 6px);
            cursor: pointer;
            font-weight: 800;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            height: 56px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
            flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ */
            box-sizing: border-box;
            vertical-align: middle; /* –ü—Ä—è–º–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
        }

        .send-button:hover {
            opacity: 0.9;
        }

        .send-button:active {
            opacity: 0.8;
        }

        .media-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
            margin-right: 0.5rem; /* –û—Ç—Å—Ç—É–ø –æ—Ç –ø–æ–ª—è –≤–≤–æ–¥–∞ */
        }

        .media-button {
            padding: 1.125rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 6px);
            flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
            min-width: 48px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
            height: 56px; /* –í—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.125rem;
            transition: background 0.2s, border-color 0.2s; /* –¢–æ–ª—å–∫–æ —Ü–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã, –±–µ–∑ transform */
            position: relative;
            box-sizing: border-box;
            vertical-align: middle; /* –ü—Ä—è–º–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
        }

        .media-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .media-button:active {
            opacity: 0.8;
            transform: translateY(0);
        }

        .media-button.recording {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .image-button {
            padding: 1.125rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 6px);
            cursor: pointer;
            font-weight: 600;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
            transition: all 0.2s;
        }

        .image-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .image-button:active {
            opacity: 0.8;
        }

        /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –≤–∏–¥–∏–º –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω */
        #chat-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }
        
        #chat-content[style*="display: none"] {
            display: none !important;
        }
        
        #messages-container {
            position: relative;
            width: 100%;
            box-sizing: border-box;
            flex: 1;
            min-height: 0;
            display: block;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        }
        
        /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–∫—Ä—ã—Ç—ã */
        .message-row {
            display: flex;
            visibility: visible;
            opacity: 1;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #messages-container .empty-chat {
            position: relative;
            height: auto;
            min-height: 200px;
            z-index: 1;
        }
        
        /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–Ω—ã –∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è */
        #messages-container .message-row {
            position: relative;
            z-index: 1;
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 4rem;
            text-align: center;
            color: var(--text-muted);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 1;
        }

        .empty-chat-icon {
            font-size: 6rem;
            margin-bottom: 2rem;
            opacity: 0.4;
        }

        .empty-chat h3 {
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0 0 0.75rem 0;
            color: var(--primary);
        }

        .empty-chat p {
            font-size: 1.125rem;
            opacity: 0.7;
            margin: 0;
            font-weight: 500;
        }

        .empty-list {
            padding: 4rem 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-list-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .quick-replies-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: calc(var(--radius) + 8px);
            z-index: 1000;
            display: none;
            margin-bottom: 0.875rem;
            max-height: 450px;
            overflow: hidden;
        }

        .quick-replies-menu.active {
            display: flex;
            flex-direction: column;
        }

        .quick-replies-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 2px solid var(--border);
            background: var(--bg-secondary);
        }

        .quick-replies-title {
            font-weight: 800;
            font-size: 1.125rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-replies-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 350px;
            padding: 0.5rem;
        }

        .quick-replies-body::-webkit-scrollbar {
            width: 6px;
        }

        .quick-replies-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .quick-replies-body::-webkit-scrollbar-thumb {
            background: color-mix(in srgb, var(--text-muted) 30%, transparent);
            border-radius: 3px;
        }

        .quick-replies-body::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--text-muted) 50%, transparent);
        }

        .quick-reply-item {
            padding: 1rem 1.25rem;
            margin: 0.5rem;
            border: 2px solid var(--border);
            border-radius: calc(var(--radius) + 4px);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--card);
        }

        .quick-reply-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }

        .quick-reply-shortcut {
            background: var(--primary);
            color: white;
            padding: 0.625rem 1rem;
            border-radius: calc(var(--radius) + 2px);
            font-weight: 800;
            font-size: 0.8125rem;
            font-family: 'Courier New', monospace;
            flex-shrink: 0;
        }

        .quick-reply-content {
            flex: 1;
            min-width: 0;
        }

        .quick-reply-text {
            font-size: 0.9375rem;
            color: var(--text);
            line-height: 1.6;
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .quick-reply-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-reply-send {
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .quick-reply-send:hover {
            opacity: 0.9;
        }

        .quick-reply-send:active {
            opacity: 0.8;
        }

        .quick-replies-footer {
            padding: 1rem 1.5rem;
            border-top: 2px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8125rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .quick-replies-empty {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .quick-replies-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .quick-replies-empty-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .quick-replies-empty-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border-radius: calc(var(--radius));
            text-decoration: none;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .quick-replies-empty-link:hover {
            opacity: 0.9;
        }

        .sticky-sidebar-top {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--card);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è header-actions (–µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤ –±—É–¥—É—â–µ–º) */
        .header-actions {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ —É–±—Ä–∞–Ω–∞ */
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.75rem;
        }

        .sync-btn {
            padding: 0.625rem 1.25rem;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sync-btn:hover {
            background: var(--bg);
        }

        .sync-btn.syncing {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .retry-button {
            padding: 0.6rem 1rem;
            border-radius: calc(var(--radius));
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.75rem;
        }

        .retry-button:hover {
            background: var(--bg-secondary);
        }

        .scroll-bottom-btn {
            position: fixed;
            bottom: 90px;
            right: 380px; /* –°–º–µ—â–∞–µ–º –≤–ª–µ–≤–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å (350px + 30px –æ—Ç—Å—Ç—É–ø) */
            z-index: 9000;
            padding: 0.75rem 1rem;
            border-radius: calc(var(--radius) + 4px);
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            display: none;
        }
        
        /* –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–ø—Ä–∞–≤–æ */
        @media (max-width: 1200px) {
            .scroll-bottom-btn {
                right: 24px;
            }
        }

        .scroll-bottom-btn.show {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .unread-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
        }

        .modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) + 4px);
            padding: 1.25rem;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
        }

        .modal h3 { margin-top: 0; margin-bottom: 0.75rem; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã—Å—Ç—Ä—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ */
        #quick-replies-management-modal .modal {
            max-width: 800px;
            width: 90%;
        }
        
        #quick-reply-edit-modal .modal {
            max-width: 600px;
            width: 90%;
        }

        .listing-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: calc(var(--radius));
            margin-bottom: 1rem;
            background: var(--bg-secondary);
        }

        .listing-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text);
            line-height: 1.4;
        }

        .listing-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .listing-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .listing-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .listing-description {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            color: var(--text);
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .listing-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .listing-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-outline {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: calc(var(--radius));
            background: var(--bg-secondary);
            cursor: pointer;
        }

        .btn-danger {
            padding: 0.6rem 1rem;
            border: 1px solid #ef4444;
            background: #ef4444;
            color: #fff;
            border-radius: calc(var(--radius));
            cursor: pointer;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 11000;
            width: min(360px, 90vw);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: calc(var(--radius) + 2px);
            color: white;
        }

        .toast-info { background: var(--primary); }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-close {
            margin-left: auto;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.8;
        }

        .toast-close:hover { opacity: 1; }
    </style>
{% endblock %}

{% block content %}
<div id="toast-container" class="toast-container"></div>
<div style="padding: 0 !important; margin: 0 !important; height: 100% !important; overflow: hidden !important; box-sizing: border-box !important; width: 100% !important;">
        <div class="chats-page">
            <div class="chats-container">
                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
                <div class="sidebar">
                    <div class="sidebar-top sticky-sidebar-top">
                        <h2 class="sidebar-title">üí¨ –ß–∞—Ç—ã</h2>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —É–±—Ä–∞–Ω—ã - —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
                        
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input 
                                type="search" 
                                id="chat-search" 
                                class="search-input" 
                                placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º..."
                                oninput="handleSearchInput(this.value)"
                            >
                        </div>

                        <div class="filters-container">
                            <div class="filters-row-main">
                                <button class="filter-chip active" data-sort="all">
                                    <span>üìÅ</span>
                                    <span>–û–±—â–∏–π –ø—É–ª</span>
                                </button>
                                <button class="filter-chip" data-sort="my">
                                    <span>üë§</span>
                                    <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                                    <span id="my-chats-count">(0)</span>
                                </button>
                                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" —É–±—Ä–∞–Ω–∞ - —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
                                <button class="filter-chip" data-sort="completed">
                                    <span>‚úÖ</span>
                                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</span>
                                    <span id="archive-count">(0)</span>
                                </button>
                                <button class="filter-chip" data-sort="blocked">
                                    <span>üö´</span>
                                    <span>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</span>
                                    <span id="blocked-count">(0)</span>
                                </button>
                            </div>
                            <div class="filters-row-secondary" style="display: flex; gap: 0.375rem; flex-wrap: wrap; align-items: center;">
                                <!-- –£–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                                <select id="filter-shop" class="filter-select" style="padding: 0.375rem 0.75rem; border: 1.5px solid var(--border); background: var(--bg-secondary); border-radius: 8px; font-size: 0.6875rem; color: var(--text); cursor: pointer; min-width: 120px;" onchange="applySmartFilters()">
                                    <option value="">üè™ –í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã</option>
                                </select>
                                <select id="filter-manager" class="filter-select" style="padding: 0.375rem 0.75rem; border: 1.5px solid var(--border); background: var(--bg-secondary); border-radius: 8px; font-size: 0.6875rem; color: var(--text); cursor: pointer; min-width: 120px;" onchange="applySmartFilters()">
                                    <option value="">üë§ –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
                                </select>
                                <select id="filter-time" class="filter-select" style="padding: 0.375rem 0.75rem; border: 1.5px solid var(--border); background: var(--bg-secondary); border-radius: 8px; font-size: 0.6875rem; color: var(--text); cursor: pointer; min-width: 140px;" onchange="applySmartFilters()">
                                    <option value="">‚è±Ô∏è –í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</option>
                                    <option value="5">‚è±Ô∏è –ë–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç</option>
                                    <option value="10">‚è±Ô∏è –ë–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç</option>
                                    <option value="20">‚è±Ô∏è –ë–æ–ª–µ–µ 20 –º–∏–Ω—É—Ç</option>
                                    <option value="60">‚è±Ô∏è –ë–æ–ª–µ–µ 1 —á–∞—Å–∞</option>
                                </select>
                                <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                                <button id="bulk-actions-btn" class="filter-chip" style="display: none; background: var(--primary); color: white;" onclick="showBulkActionsMenu()">
                                    <span>‚ö°</span>
                                    <span>–ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</span>
                                    <span id="selected-count" style="background: rgba(255,255,255,0.3); padding: 0.125rem 0.375rem; border-radius: 10px; font-size: 0.625rem; margin-left: 0.25rem;">0</span>
                                </button>
                                <div class="sort-buttons-group">
                                    <button class="sort-chip active" data-sort-order="newest" id="sort-newest">
                                        <span>‚¨áÔ∏è</span>
                                        <span>–ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É</span>
                                    </button>
                                    <button class="sort-chip" data-sort-order="oldest" id="sort-oldest">
                                        <span>‚¨ÜÔ∏è</span>
                                        <span>–°—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É</span>
                                    </button>
                                </div>
                                <button class="return-all-btn hidden" id="return-all-btn" onclick="returnAllChatsToPool()" title="–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –º–æ–∏ —á–∞—Ç—ã –≤ –ø—É–ª">
                                    <span>üì§</span>
                                    <span>–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –≤ –ø—É–ª</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chats-scroll" id="chats-list">
                        <!-- –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
                <div class="chat-main">
                    <div class="chat-window" id="chat-window">
                        <div class="empty-chat" id="empty-chat">
                            <div class="empty-chat-icon">üí¨</div>
                            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                        </div>

                        <div id="chat-content" style="display: none; flex-direction: column; height: 100%; width: 100%; position: relative; overflow: hidden; box-sizing: border-box; min-height: 0;">
                            <div class="chat-header-bar">
                                <div class="chat-header-info">
                                    <div class="chat-header-name" id="chat-client-name">–ö–ª–∏–µ–Ω—Ç</div>
                                    <div class="chat-header-details" id="chat-header-details">
                                        <span>üìû –¢–µ–ª–µ—Ñ–æ–Ω</span>
                                        <span>‚Ä¢</span>
                                        <span>üè™ –ú–∞–≥–∞–∑–∏–Ω</span>
                                    </div>
                                </div>
                                <div class="chat-header-actions" id="chat-header-actions">
                                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                                </div>
                            </div>

                            <div class="messages-view" id="messages-container">
                                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                            </div>

                            <div class="input-section">
                                <div class="quick-actions-row">
                                    <button class="quick-action" onclick="showQuickRepliesMenu()">
                                        ‚ö° –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
                                        <span id="quick-replies-count"></span>
                                    </button>
                                    <button class="quick-action" onclick="showQuickRepliesManagementModal()">‚ûï –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                                </div>
                                <div id="avito-warning" style="display:none; margin-bottom:0.75rem; padding:0.75rem 1rem; border-radius: var(--radius); background: rgba(239,68,68,0.1); color:#b91c1c; border:1px solid rgba(239,68,68,0.3); font-weight:600;">
                                    –î–ª—è —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã OAuth –∫–ª—é—á–∏ Avito. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞.
                                </div>
                                <div class="input-row">
                                    <div class="media-buttons">
                                        <input type="file" id="image-upload" accept="image/jpeg,image/jpg,image/png,image/gif,image/bmp,image/heic" style="display: none;" onchange="handleImageUpload(event)">
                                        <button class="media-button" onclick="document.getElementById('image-upload').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                            <span>üì∑</span>
                                        </button>
                                        <input type="file" id="voice-upload" accept="audio/*,video/mp4" style="display: none;" onchange="handleVoiceUpload(event)">
                                        <button class="media-button" onclick="document.getElementById('voice-upload').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∞—É–¥–∏–æ">
                                            <span>üé§</span>
                                        </button>
                                        <input type="file" id="media-upload" accept="*/*" style="display: none;" onchange="handleMediaUpload(event)">
                                        <button class="media-button" onclick="document.getElementById('media-upload').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
                                            <span>üìé</span>
                                        </button>
                                    </div>
                                    <textarea 
                                        id="message-text" 
                                        class="message-field" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                        rows="1"
                                    ></textarea>
                                    <button class="send-button" onclick="sendMessage()">
                                        <span>üì®</span>
                                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                                    </button>
                                </div>
                                <div class="quick-replies-menu" id="quick-replies-menu">
                                    <div class="quick-replies-header">
                                        <div class="quick-replies-title">
                                            <span>‚ö°</span>
                                            <span>–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã</span>
                                        </div>
                                    </div>
                                    <div class="quick-replies-body" id="quick-replies-list">
                                        <!-- –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                                    </div>
                                    <div class="quick-replies-footer">
                                        <span>–í—Å–µ–≥–æ: <strong style="color: var(--primary);"><span id="quick-replies-total">0</span></strong></span>
                                        <span>üí° –ö–ª–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ ‚Ä¢ üì§ –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã—Å—Ç—Ä—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ -->
                <div id="quick-replies-management-modal" class="modal-backdrop" style="display: none;">
                    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
                            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700;">‚ö° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ã—Å—Ç—Ä—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏</h3>
                            <button onclick="closeQuickRepliesManagementModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem 0.5rem;">‚úï</button>
                        </div>
                        <div style="flex: 1; overflow-y: auto; margin-bottom: 1rem;">
                            <div id="quick-replies-management-list" style="display: grid; gap: 1rem;">
                                <!-- –°–ø–∏—Å–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <button onclick="closeQuickRepliesManagementModal()" style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-weight: 600;">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button onclick="showQuickReplyEditModal()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π</button>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ -->
                <div id="quick-reply-edit-modal" class="modal-backdrop" style="display: none;">
                    <div class="modal" style="max-width: 600px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
                            <h3 id="quick-reply-edit-title" style="margin: 0; font-size: 1.25rem; font-weight: 700;">–î–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç</h3>
                            <button onclick="closeQuickReplyEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.25rem 0.5rem;">‚úï</button>
                        </div>
                        <form id="quick-reply-edit-form" onsubmit="saveQuickReply(event)" style="display: flex; flex-direction: column; gap: 1rem;">
                            <input type="hidden" id="quick-reply-edit-id" value="">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ (shortcut):</label>
                                <input type="text" id="quick-reply-edit-shortcut" placeholder="/–ø—Ä–∏–≤–µ—Ç" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 0.9375rem; box-sizing: border-box;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">–ù–∞—á–Ω–∏—Ç–µ —Å / –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ</div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                                <textarea id="quick-reply-edit-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞..." required rows="6" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 0.9375rem; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 0.5rem;">
                                <button type="button" onclick="closeQuickReplyEditModal()" style="padding: 0.75rem 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-weight: 600;">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º -->
                <div class="listing-sidebar">
                    <div class="listing-sidebar-header">
                        <h3 class="listing-sidebar-title">üì¶ –û–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
                    </div>
                    <div class="listing-sidebar-content" id="listing-sidebar-content">
                        <div class="listing-sidebar-empty">
                            <div class="listing-sidebar-empty-icon">üì¶</div>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

<button id="scroll-bottom-btn" class="scroll-bottom-btn" onclick="scrollMessagesBottom()">
    ‚¨áÔ∏è –í–Ω–∏–∑
</button>

{% endblock %}

{% block early_scripts %}
<script>
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    window.syncChats = async function syncChats() {
        const btn = document.getElementById('sync-btn');
        if (!btn) {
            console.error('–ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        const originalText = btn.innerHTML;

        try {
            btn.classList.add('syncing');
            btn.innerHTML = '‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            btn.disabled = true;

            const response = await fetch('/api/chats/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({})
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
            }

            const result = await response.json();
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º showNotification –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞, –∏–Ω–∞—á–µ alert
            if (typeof window.showNotification === 'function') {
                window.showNotification('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
            } else {
                alert('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç—ã –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
            if (typeof window.loadChats === 'function') {
                await window.loadChats(false);
            } else {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                window.location.reload();
            }
        } catch (error) {
            debugError('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            if (typeof window.showNotification === 'function') {
                window.showNotification(`‚ùå ${error.message}`, 'error');
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        } finally {
            if (btn) {
                btn.classList.remove('syncing');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    };
    
</script>
{% endblock %}

{% block scripts %}
    <script>
        
        let currentChatId = null;
        let allChats = [];
        let filteredChats = [];
        let currentSort = 'all';
        let currentSortOrder = 'newest'; // 'newest' –∏–ª–∏ 'oldest'
        let searchQuery = '';
        let autoRefreshInterval = null;
        let messagesAutoRefreshInterval = null;
        let quickRepliesCache = null;
        let quickRepliesCacheTime = 0;
        const CACHE_DURATION = 60000;
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –§–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (false –≤ production)
        const DEBUG_MODE = false; // –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–∏—á–µ–≥–æ –µ—Å–ª–∏ DEBUG_MODE = false
        function debugLog(...args) {
            if (!DEBUG_MODE) return; // –ë—ã—Å—Ç—Ä—ã–π –≤—ã—Ö–æ–¥ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫
            console.log(...args);
        }
        
        function debugError(...args) {
            if (!DEBUG_MODE) return;
            console.error(...args);
        }
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ö—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        const domCache = {
            chatsList: null,
            myChatsCount: null,
            poolChatsCount: null,
            archiveCount: null,
            blockedCount: null
        };
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–æ–≤
        let isRendering = false;
        let renderScheduled = false;
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Throttle –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        let lastAutoRefreshTime = 0;
        const AUTO_REFRESH_THROTTLE = 2000; // –ú–∏–Ω–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
        
        // –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —á–∞—Ç–æ–≤ (—É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        function memoize(fn, keyFn) {
            const cache = new Map();
            return function(...args) {
                const key = keyFn ? keyFn(...args) : JSON.stringify(args);
                if (cache.has(key)) {
                    return cache.get(key);
                }
                const result = fn(...args);
                cache.set(key, result);
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞ (LRU - —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏)
                if (cache.size > 100) {
                    const firstKey = cache.keys().next().value;
                    cache.delete(firstKey);
                }
                return result;
            };
        }
        
        // –ù–û–í–´–ô –ü–û–î–•–û–î: Set –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤–∑—è—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ (–¥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º)
        const locallyTakenChats = new Set();
        // Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è timestamp –∫–∞–∂–¥–æ–≥–æ –≤–∑—è—Ç–æ–≥–æ —á–∞—Ç–∞ (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏)
        const locallyTakenChatsTimestamps = new Map();
        
        // –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤ –≤ localStorage –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        const CHATS_CACHE_KEY = 'chats_cache';
        const CHATS_CACHE_TIMESTAMP_KEY = 'chats_cache_timestamp';
        const CHATS_CACHE_MAX_AGE = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
        
        function saveChatsToCache(chats) {
            try {
                localStorage.setItem(CHATS_CACHE_KEY, JSON.stringify(chats));
                localStorage.setItem(CHATS_CACHE_TIMESTAMP_KEY, Date.now().toString());
            } catch (e) {
                console.warn('[CACHE] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            }
        }
        
        function loadChatsFromCache() {
            try {
                const cached = localStorage.getItem(CHATS_CACHE_KEY);
                const timestamp = localStorage.getItem(CHATS_CACHE_TIMESTAMP_KEY);
                
                if (!cached || !timestamp) {
                    return null;
                }
                
                const age = Date.now() - parseInt(timestamp, 10);
                if (age > CHATS_CACHE_MAX_AGE) {
                    localStorage.removeItem(CHATS_CACHE_KEY);
                    localStorage.removeItem(CHATS_CACHE_TIMESTAMP_KEY);
                    return null;
                }
                
                const chats = JSON.parse(cached);
                return chats;
            } catch (e) {
                console.warn('[CACHE] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                return null;
            }
        }
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
        const DELAYS = {
            BATCH_TAKE_CLEANUP: 2000,        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π locallyTakenChats
            PRODUCT_URL_EXTRACT: 3000,       // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º product_url
            AUTO_EXTRACT: 5000,              // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º
            SYNC_RETRY: 1000,                // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            SEARCH_DEBOUNCE: 300             // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ (—É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        };
        
        const SEARCH_DEBOUNCE = DELAYS.SEARCH_DEBOUNCE; // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞
        const currentUsername = '{{ user.username if user else "" }}';
        // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ None, —Ç–∞–∫ –∫–∞–∫ user.id –º–æ–∂–µ—Ç –±—ã—Ç—å 0 (–≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
        const currentUserId = {% if user and user.id is not none %}{{ user.id }}{% else %}null{% endif %};
        const currentUserRole = '{{ user.role if user else "" }}';
        const isAdmin = currentUserRole === 'admin' || currentUserRole === 'super_admin';
        const MESSAGE_PAGE = 50;
        let messagesState = {};
        let currentChatHasAvito = true;
        let chatsLoading = false;
        let chatsLoadError = null;
        let searchDebounceTimer = null;
        let initialChatIdFromUrl = null;
        let chatIdFromUrlHandled = false;
        let messagesLoading = false;
        let unreadFromRefresh = 0;

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightText(text, query) {
            const safe = escapeHtml(text || '');
            const q = (query || '').trim();
            if (!q) return safe;
            const pattern = new RegExp(escapeRegExp(q), 'gi');
            return safe.replace(pattern, (m) => `<mark>${m}</mark>`);
        }

        function getChatsSkeletonMarkup() {
            const skeletonCard = `
                <div class="chat-skeleton-card">
                    <div class="chat-skeleton-header">
                        <div style="flex:1;">
                            <div class="skeleton skeleton-line large" style="width: 60%; margin-bottom: 0.4rem;"></div>
                            <div class="skeleton skeleton-line" style="width: 40%;"></div>
                        </div>
                        <div class="skeleton skeleton-line" style="width: 48px; height: 24px;"></div>
                    </div>
                    <div class="skeleton skeleton-line" style="width: 90%; margin-bottom: 0.35rem;"></div>
                    <div class="skeleton skeleton-line" style="width: 80%; margin-bottom: 0.35rem;"></div>
                    <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                        <div class="skeleton skeleton-line" style="width: 80px; height: 24px;"></div>
                        <div class="skeleton skeleton-line" style="width: 60px; height: 24px;"></div>
                    </div>
                </div>
            `;
            return Array.from({length: 5}).map(() => skeletonCard).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.loadChats = async function loadChats(doSync = false, silent = false) {
            debugLog('========================================');
            debugLog('[LOAD CHATS] –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–æ–≤');
            debugLog('[LOAD CHATS] doSync:', doSync, 'silent:', silent);
            debugLog('[LOAD CHATS] –í—Ä–µ–º—è:', new Date().toISOString());
            
            try {
            debugLog('========================================');
            
            const isFirstLoad = allChats.length === 0;
            
            // –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–µ—à —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–¥–∞–∂–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
            const cachedChats = loadChatsFromCache();
            if (cachedChats && cachedChats.length > 0) {
                allChats = cachedChats;
                resetTimerBaseTimes();
                applySort(currentSort);
                renderChatsList();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
                updateResponseTimers();
                debugLog('[LOAD CHATS] ‚úÖ –ü–æ–∫–∞–∑–∞–Ω—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–µ...');
            } else if (isFirstLoad && !silent) {
                // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–µ—à–∞ –∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω
            chatsLoading = true;
            chatsLoadError = null;
            renderChatsList();
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¢–û–õ–¨–ö–û –≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –∂–¥–µ–º –µ—ë –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (doSync || isFirstLoad) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–æ–≤
                fetch('/api/chats/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                    credentials: 'include',
                        body: JSON.stringify({})
                }).then(syncResponse => {
                    if (syncResponse.ok) {
                        debugLog('[LOAD CHATS] ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ');
                        // –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç—ã —Ç–∏—Ö–æ
                        loadChats(false, true).then(() => {
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ–º product_url –¥–ª—è —á–∞—Ç–æ–≤ –±–µ–∑ –Ω–µ–≥–æ
                            setTimeout(() => {
                                autoExtractProductUrls();
                            }, DELAYS.PRODUCT_URL_EXTRACT);
                        }).catch(() => {});
                    } else {
                        syncResponse.json().then(errorData => {
                            debugLog('[LOAD CHATS] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É:', errorData);
                        }).catch(() => {});
                    }
                }).catch(syncError => {
                    debugLog('[LOAD CHATS] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É:', syncError);
                });
            }

                // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è fetch —Å retry –ª–æ–≥–∏–∫–æ–π
                async function fetchWithRetry(url, options, maxRetries) {
                    maxRetries = maxRetries || 3;
                    let lastError = null;
                    let response = null;
                    
                    for (let attempt = 0; attempt < maxRetries; attempt++) {
                        try {
                            response = await fetch(url, {
                                ...options,
                                signal: AbortSignal.timeout(30000) // –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
                            });
                            
                            if (response.ok) {
                                return response;
                            }
                            
                            const errorText = await response.text();
                            lastError = new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                            
                            // –î–ª—è 4xx –æ—à–∏–±–æ–∫ –Ω–µ –¥–µ–ª–∞–µ–º retry (–∫—Ä–æ–º–µ 408, 429)
                            if (response.status >= 400 && response.status < 500 && 
                                response.status !== 408 && response.status !== 429) {
                                if (attempt === maxRetries - 1) throw lastError;
                                break;
                            }
                            
                            // –î–ª—è 5xx –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–µ–ª–∞–µ–º retry
                            if (attempt < maxRetries - 1) {
                                const delay = DELAYS.SYNC_RETRY * Math.pow(2, attempt); // Exponential backoff
                                debugLog(`[FETCH RETRY] –û—à–∏–±–∫–∞ ${response.status}, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${delay}–º—Å (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries})`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            }
                            
                            throw lastError;
                        } catch (error) {
                            lastError = error;
                            
                            // –ï—Å–ª–∏ —ç—Ç–æ AbortError (—Ç–∞–π–º–∞—É—Ç), –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
                            if (error.name === 'AbortError' && attempt < maxRetries - 1) {
                                const delay = DELAYS.SYNC_RETRY * Math.pow(2, attempt);
                                debugLog(`[FETCH RETRY] –¢–∞–π–º–∞—É—Ç, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${delay}–º—Å (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries})`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            }
                            
                            // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º
                            if (attempt === maxRetries - 1) {
                                throw error;
                            }
                            
                            // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –¥–µ–ª–∞–µ–º retry
                            const delay = DELAYS.SYNC_RETRY * Math.pow(2, attempt);
                            debugLog(`[FETCH RETRY] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${delay}–º—Å (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                    
                    return response;
                }
                
                // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry –ª–æ–≥–∏–∫–æ–π
                const MAX_RETRIES = 3;
                let lastError = null;
                let response = null;
                
                try {
                    response = await fetchWithRetry('/api/chats', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        mode: 'cors'
                    }, MAX_RETRIES);
                } catch (error) {
                    lastError = error;
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–µ—à, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à
                    if (allChats.length > 0) {
                        chatsLoading = false;
                        return;
                    }
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    const errorMessage = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã';
                    let userMessage = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        userMessage = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                    } else if (error.message && error.message.includes('timeout')) {
                        userMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.';
                    } else if (error.message && error.message.includes('HTTP 5')) {
                        userMessage = '–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                    }
                    showNotification(`‚ùå ${userMessage}`, 'error');
                    throw error;
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (!response || !response.ok) {
                    if (allChats.length > 0) {
                        chatsLoading = false;
                        return;
                    }
                    throw lastError || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã');
                }
                
                const data = await response.json();
                
                const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
            function validateChatData(chat) {
                if (!chat || typeof chat !== 'object') return false;
                if (typeof chat.id !== 'number' || chat.id <= 0) return false;
                if (typeof chat.status !== 'string') return false;
                if (chat.assigned_manager_id !== null && chat.assigned_manager_id !== undefined && 
                    typeof chat.assigned_manager_id !== 'number') return false;
                return true;
            }
            
            const validChats = items.filter(validateChatData);
            if (validChats.length !== items.length) {
                debugLog(`[LOAD CHATS] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${items.length - validChats.length} –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —á–∞—Ç–æ–≤ –∏–∑ ${items.length}`);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            const existingChatsCount = allChats.length;
            
                // –ù–û–í–´–ô –ü–û–î–•–û–î: –û–±–Ω–æ–≤–ª—è–µ–º allChats –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                // –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤–∑—è—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ
                allChats = validChats;
                
                debugLog('[LOAD CHATS] –ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–∞—Ç–æ–≤:', items.length, '–±—ã–ª–æ:', existingChatsCount);
                
                // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤–∑—è—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ
                // –Ω–æ —Å–µ—Ä–≤–µ—Ä –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª (–∏–ª–∏ –æ–±–Ω–æ–≤–∏–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
                if (DEBUG_MODE) {
                    debugLog('[LOAD CHATS] –õ–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–µ —á–∞—Ç—ã –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:', Array.from(locallyTakenChats));
                    debugLog('[LOAD CHATS] currentUserId:', currentUserId, 'currentUsername:', currentUsername);
                }
                
                locallyTakenChats.forEach(chatId => {
                    const chatIndex = allChats.findIndex(c => c.id === chatId);
                    if (chatIndex !== -1) {
                        const chat = allChats[chatIndex];
                        if (DEBUG_MODE) {
                            debugLog('[LOAD CHATS] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–π —á–∞—Ç', chatId, {
                                assigned_manager_id: chat.assigned_manager_id,
                                assigned_manager_name: chat.assigned_manager_name,
                                currentUserId: currentUserId
                            });
                        }
                        
                        // –ï—Å–ª–∏ —á–∞—Ç –±—ã–ª –≤–∑—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ —Å–µ—Ä–≤–µ—Ä –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª assigned_manager_id,
                        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        if (!chat.assigned_manager_id || chat.assigned_manager_id === null || chat.assigned_manager_id === undefined) {
                            chat.assigned_manager_id = currentUserId;
                            chat.assigned_manager_name = currentUsername;
                            debugLog('[LOAD CHATS] ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞', chatId, 'assigned_manager_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤', currentUserId);
                        } else if (chat.assigned_manager_id === currentUserId) {
                            // –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ —á–∞—Ç –≤–∑—è—Ç - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ Set
                            debugLog('[LOAD CHATS] ‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Ç–∞', chatId, '—É–¥–∞–ª—è–µ–º –∏–∑ locallyTakenChats');
                            locallyTakenChats.delete(chatId);
                            locallyTakenChatsTimestamps.delete(chatId);
                        } else {
                            // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥–æ–π ID - —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            if (DEBUG_MODE) {
                                console.warn('[LOAD CHATS] ‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥–æ–π assigned_manager_id –¥–ª—è —á–∞—Ç–∞', chatId, 
                                           '–æ–∂–∏–¥–∞–ª–∏:', currentUserId, '–ø–æ–ª—É—á–∏–ª–∏:', chat.assigned_manager_id);
                            }
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã –≤–∑—è–ª–∏ —á–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ
                            chat.assigned_manager_id = currentUserId;
                            chat.assigned_manager_name = currentUsername;
                        }
                    } else {
                        if (DEBUG_MODE) {
                            console.warn('[LOAD CHATS] ‚ö†Ô∏è –õ–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–π —á–∞—Ç', chatId, '–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ allChats –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞');
                        }
                    }
                });
                
                if (DEBUG_MODE) {
                    debugLog('[LOAD CHATS] –õ–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–µ —á–∞—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', Array.from(locallyTakenChats));
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
                resetTimerBaseTimes();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑
                saveChatsToCache(allChats);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å
                updateResponseTimers();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ–º product_url –¥–ª—è –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –±–µ–∑ –Ω–µ–≥–æ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
                if (isFirstLoad) {
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    setTimeout(() => {
                        autoExtractProductUrls();
                    }, DELAYS.PRODUCT_URL_EXTRACT);
                }
                
                const completedCount = allChats.filter(chat => chat.status === 'completed').length;
                const blockedCount = allChats.filter(chat => chat.status === 'blocked').length;
                const poolCount = allChats.filter(chat => 
                    chat.status !== 'completed' && 
                    chat.status !== 'blocked' && 
                    !chat.assigned_manager_id
                ).length;
                const myChatsCount = allChats.filter(chat => {
                    if (chat.status === 'completed' || chat.status === 'blocked') return false;
                    if (!chat.assigned_manager_id) return false;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ) –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏
                    return chat.assigned_manager_id === currentUserId || 
                           chat.assigned_manager_name === currentUsername ||
                           (chat.assigned_manager_name && currentUsername && 
                            chat.assigned_manager_name.includes(currentUsername));
                }).length;
                
                document.getElementById('archive-count').textContent = `(${completedCount})`;
                document.getElementById('blocked-count').textContent = `(${blockedCount})`;
                document.getElementById('my-chats-count').textContent = `(${myChatsCount})`;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
                // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –±—ã–ª –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
                // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
                const wasEmpty = existingChatsCount === 0;
                const shouldUseSmartUpdate = !isFirstLoad && !wasEmpty && existingChatsCount > 0;
                
                debugLog('[LOAD CHATS] –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É. isFirstLoad:', isFirstLoad, 'wasEmpty:', wasEmpty, 'shouldUseSmartUpdate:', shouldUseSmartUpdate);
                
                applySort(currentSort, shouldUseSmartUpdate);
                // –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ —á–∞—Ç—ã –ø–æ—è–≤–ª—è–ª–∏—Å—å
                // –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ applySort, –Ω–æ renderChatsList –Ω—É–∂–µ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                renderChatsList();
                attemptOpenChatFromUrl();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ product_url –¥–ª—è —á–∞—Ç–æ–≤ –±–µ–∑ –Ω–µ–≥–æ (–≤ —Ñ–æ–Ω–µ)
                // –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é autoExtractProductUrls, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–∞—Ç—á–∞–º–∏
                if (isFirstLoad) {
                    setTimeout(() => {
                        autoExtractProductUrls();
                    }, DELAYS.AUTO_EXTRACT);
                }
            } catch (error) {
            console.error('[LOAD CHATS] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã: ' + error.message, 'error');
            chatsLoadError = error;
        } finally {
            chatsLoading = false;
            debugLog('[LOAD CHATS] finally –±–ª–æ–∫: –≤—ã–∑—ã–≤–∞–µ–º renderChatsList()...');
            try {
                renderChatsList();
                debugLog('[LOAD CHATS] finally: renderChatsList() –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                debugError('[LOAD CHATS] finally: –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–∑–æ–≤–µ renderChatsList():', error);
            }
        }
    }

        function attemptOpenChatFromUrl() {
            if (chatIdFromUrlHandled || !initialChatIdFromUrl) return;
            const chatIdNum = Number(initialChatIdFromUrl);
            if (Number.isNaN(chatIdNum)) {
                chatIdFromUrlHandled = true;
                return;
            }
            const chat = allChats.find(c => c.id === chatIdNum);
            if (chat) {
                chatIdFromUrlHandled = true;
                selectChat(chatIdNum);
            } else if (allChats.length > 0) {
                showNotification('–ß–∞—Ç –∏–∑ URL –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                chatIdFromUrlHandled = true;
            }
        }

        // –ü–æ–∏—Å–∫
        function searchChats(query) {
            searchQuery = query.toLowerCase().trim();
            try {
            applySort(currentSort);
            } catch (error) {
                console.error('Error in chat search:', error);
            }
        }

        function handleSearchInput(value) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º debounce –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                searchChats(value);
            }, DELAYS.SEARCH_DEBOUNCE);
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–∞—Ç–æ–≤ (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)
        window.syncChats = async function syncChats() {
            const btn = document.getElementById('sync-btn');
            if (!btn) {
                console.error('–ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            const originalText = btn.innerHTML;

            try {
                btn.classList.add('syncing');
                btn.innerHTML = '‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
                btn.disabled = true;

                const response = await fetch('/api/chats/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });


                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[SYNC] –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', errorData);
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${result.synced_count || 0} —á–∞—Ç–æ–≤`, 'success');
                } else {
                    showNotification(`‚ö†Ô∏è ${result.error || '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏'}`, 'error');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç—ã –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                await loadChats(false); // –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            } catch (error) {
                console.error('[SYNC] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                showNotification(`‚ùå ${error.message}`, 'error');
            } finally {
                btn.classList.remove('syncing');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const memoizedFilterChats = memoize(
            (chats, sort, userId, username, locallyTakenSet) => {
                let baseChats = [];
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ —Ç–∏–ø—É
                if (sort === 'completed') {
                    baseChats = chats.filter(chat => chat.status === 'completed');
                } else if (sort === 'blocked') {
                    baseChats = chats.filter(chat => chat.status === 'blocked');
                } else if (sort === 'all') {
                    baseChats = chats.filter(chat => {
                        if (locallyTakenSet.has(chat.id)) return false;
                        const isNotAssigned = chat.assigned_manager_id === null || 
                                            chat.assigned_manager_id === undefined || 
                                            chat.assigned_manager_id === false;
                        const isValidStatus = chat.status !== 'completed' && chat.status !== 'blocked';
                        return isNotAssigned && isValidStatus;
                    });
                } else if (sort === 'my') {
                    baseChats = chats.filter(chat => {
                        if (chat.status === 'completed' || chat.status === 'blocked') return false;
                        if (!chat.assigned_manager_id) return false;
                        const isAssignedToMe = chat.assigned_manager_id === userId;
                        const isAssignedByName = !isAssignedToMe && (
                            chat.assigned_manager_name === username ||
                            (chat.assigned_manager_name && username && 
                             chat.assigned_manager_name.includes(username))
                        );
                        const isLocallyTaken = locallyTakenSet.has(chat.id);
                        if (isLocallyTaken && (!chat.assigned_manager_id || chat.assigned_manager_id === null)) {
                            chat.assigned_manager_id = userId;
                            chat.assigned_manager_name = username;
                        }
                        return isAssignedToMe || isAssignedByName || isLocallyTaken;
                    });
                } else {
                    baseChats = chats.filter(chat => chat.status === 'active');
                }
                
                return baseChats;
            },
            (chats, sort, userId, username, locallyTakenSet) => 
                `${chats.length}-${sort}-${userId}-${username}-${locallyTakenSet.size}`
        );
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ - –ú–ì–ù–û–í–ï–ù–ù–û, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
        function applySort(sort, useSmartUpdate = false) {
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –≤ UI
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            const activeChip = document.querySelector(`.filter-chip[data-sort="${sort}"]`);
            if (activeChip) activeChip.classList.add('active');
            
            currentSort = sort;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            let baseChats = memoizedFilterChats(allChats, sort, currentUserId, currentUsername, locallyTakenChats);
            
            if (DEBUG_MODE && sort === 'my') {
                debugLog('[APPLY SORT] –§–∏–ª—å—Ç—Ä "–ú–æ–∏ —á–∞—Ç—ã": currentUserId=', currentUserId, 'currentUsername=', currentUsername);
                debugLog('[APPLY SORT] –í—Å–µ–≥–æ —á–∞—Ç–æ–≤ –≤ allChats:', allChats.length);
                debugLog('[APPLY SORT] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —á–∞—Ç–æ–≤ –¥–ª—è "–ú–æ–∏ —á–∞—Ç—ã":', baseChats.length);
                debugLog('[APPLY SORT] –õ–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–µ —á–∞—Ç—ã:', Array.from(locallyTakenChats));
            }

            debugLog('[APPLY SORT] –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É:', baseChats.length, '–∏–∑', allChats.length);

            // –£–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            const filterShop = document.getElementById('filter-shop')?.value || '';
            const filterManager = document.getElementById('filter-manager')?.value || '';
            const filterTime = document.getElementById('filter-time')?.value || '';
            
            if (filterShop) {
                baseChats = baseChats.filter(chat => chat.shop_id && String(chat.shop_id) === filterShop);
            }
            if (filterManager) {
                baseChats = baseChats.filter(chat => chat.assigned_manager_id && String(chat.assigned_manager_id) === filterManager);
            }
            if (filterTime) {
                const minTime = parseInt(filterTime);
                baseChats = baseChats.filter(chat => {
                    const timer = typeof chat.response_timer === 'number' ? chat.response_timer : (parseInt(chat.response_timer) || 0);
                    return timer >= minTime;
                });
            }

            // –ü–æ–∏—Å–∫
            if (searchQuery) {
                const beforeSearch = baseChats.length;
                baseChats = baseChats.filter(chat => {
                    const name = (chat.client_name || '').toLowerCase();
                    const phone = (chat.client_phone || '').toLowerCase();
                    const message = (chat.last_message || '').toLowerCase();
                    const shop = (chat.shop_name || '').toLowerCase();
                    return name.includes(searchQuery) || 
                           phone.includes(searchQuery) || 
                           message.includes(searchQuery) ||
                           shop.includes(searchQuery);
                });
                debugLog('[APPLY SORT] –ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞:', beforeSearch, '->', baseChats.length);
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ (response_timer)
            debugLog('[APPLY SORT] –ü–µ—Ä–µ–¥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π:', baseChats.length, '—á–∞—Ç–æ–≤');
            filteredChats = baseChats.sort((a, b) => {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è response_timer (–≤—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö)
                const getResponseTimer = (chat) => {
                    const timer = chat.response_timer;
                    if (timer === null || timer === undefined) return 0;
                    return typeof timer === 'number' ? timer : (parseInt(timer) || 0);
                };
                
                const timerA = getResponseTimer(a);
                const timerB = getResponseTimer(b);
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —É–±—Ä–∞–Ω—ã)
                
                // –ó–∞—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ (response_timer)
                // –°–Ω–∞—á–∞–ª–∞ —á–∞—Ç—ã —Å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (timer > 0), –∑–∞—Ç–µ–º –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ (timer = 0)
                if (timerA > 0 && timerB === 0) return -1; // a –≤—ã—à–µ (–µ—Å—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ)
                if (timerA === 0 && timerB > 0) return 1;  // b –≤—ã—à–µ (–µ—Å—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ)
                
                // –ï—Å–ª–∏ –æ–±–∞ –∏–º–µ—é—Ç timer > 0 –∏–ª–∏ –æ–±–∞ –∏–º–µ—é—Ç timer = 0, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timer
                if (currentSortOrder === 'oldest') {
                    // –°—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É: –±–æ–ª—å—à–∏–π timer —Å–≤–µ—Ä—Ö—É (–±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ = —Å—Ç–∞—Ä–µ–µ)
                    return timerB - timerA;
                } else {
                    // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É: –º–µ–Ω—å—à–∏–π timer —Å–≤–µ—Ä—Ö—É (–º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ = –Ω–æ–≤–µ–µ, —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏—à–ª–∏)
                    return timerA - timerB;
                }
            });
            
            debugLog('[APPLY SORT] –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤:', filteredChats.length);
            try {
                if (useSmartUpdate) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
                    updateChatsListSmart();
                } else {
                    // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞, –ø–æ–∏—Å–∫ –∏ —Ç.–¥.)
                    renderChatsList();
                }
            } catch (error) {
                console.error('[APPLY SORT] –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
                // Fallback –Ω–∞ –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (!useSmartUpdate) {
                    renderChatsList();
                }
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            document.querySelectorAll('.filter-chip[data-sort]').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.sort === sort);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            document.querySelectorAll('.sort-chip[data-sort-order]').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.sortOrder === currentSortOrder);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –≤ –ø—É–ª" —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ "–ú–æ–∏ —á–∞—Ç—ã"
            const returnAllBtn = document.getElementById('return-all-btn');
            if (returnAllBtn) {
                if (sort === 'my') {
                    returnAllBtn.classList.remove('hidden');
                } else {
                    returnAllBtn.classList.add('hidden');
                }
            }
        }

        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function initDOMCache() {
            if (!domCache.chatsList) {
                domCache.chatsList = document.getElementById('chats-list');
                domCache.myChatsCount = document.getElementById('my-chats-count');
                domCache.poolChatsCount = document.getElementById('pool-chats-count');
                domCache.archiveCount = document.getElementById('archive-count');
                domCache.blockedCount = document.getElementById('blocked-count');
            }
        }
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º requestAnimationFrame –∏ DocumentFragment
        function renderChatsList() {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ–Ω–¥–µ—Ä—ã
            if (isRendering) {
                renderScheduled = true;
                return;
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            if (renderScheduled) {
                return;
            }
            
            renderScheduled = true;
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–∞–∑–±–∏–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
            const CHUNK_SIZE = 50; // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ 50 —á–∞—Ç–æ–≤ –∑–∞ —Ä–∞–∑
            const totalChats = filteredChats.length;
            
            requestAnimationFrame(() => {
                renderScheduled = false;
                isRendering = true;
                
                try {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    initDOMCache();
                    const container = domCache.chatsList;
                    
                    if (!container) {
                        debugError('[RENDER] ‚ùå –ö–û–ù–¢–ï–ô–ù–ï–† –ù–ï –ù–ê–ô–î–ï–ù!');
                        isRendering = false;
                        return;
                    }

                    if (chatsLoading) {
                        isRendering = false;
                        return;
                    }

                    if (chatsLoadError) {
                        container.innerHTML = `
                            <div class="empty-list">
                                <div class="empty-list-icon">‚ö†Ô∏è</div>
                                <h3>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã</h3>
                                <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                                <button class="retry-button" onclick="loadChats()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                            </div>
                        `;
                        isRendering = false;
                        return;
                    }

                    if (filteredChats.length === 0) {
                        debugLog('[RENDER] –ù–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤. allChats:', allChats.length, 'currentSort:', currentSort, 'searchQuery:', searchQuery);
                        if (allChats.length > 0 && DEBUG_MODE) {
                            debugLog('[RENDER] –ü—Ä–∏–º–µ—Ä—ã —á–∞—Ç–æ–≤ –∏–∑ allChats:', allChats.slice(0, 3).map(c => ({
                                id: c.id,
                                client_name: c.client_name,
                                status: c.status,
                                assigned_manager_id: c.assigned_manager_id,
                                priority: c.priority
                            })));
                        }
                        const emptyMessage = currentSort === 'completed' 
                            ? '<h3>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</h3><p>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>'
                            : currentSort === 'blocked'
                            ? '<h3>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –Ω–µ—Ç</h3><p>–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</p>'
                            : currentSort === 'my'
                            ? '<h3>–ù–µ—Ç –≤–∞—à–∏—Ö —á–∞—Ç–æ–≤</h3><p>–í–æ–∑—å–º–∏—Ç–µ —á–∞—Ç—ã –∏–∑ –ø—É–ª–∞</p>'
                            : currentSort === 'all'
                            ? '<h3>–û–±—â–∏–π –ø—É–ª –ø—É—Å—Ç</h3><p>–ù–µ—Ç —á–∞—Ç–æ–≤ –≤ –æ–±—â–µ–º –ø—É–ª–µ</p>'
                            : searchQuery
                            ? '<h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>'
                            : allChats.length === 0
                            ? '<h3>–ß–∞—Ç–æ–≤ –Ω–µ—Ç</h3><p>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —á–∞—Ç—ã –∏–∑ Avito API</p><button class="retry-button" onclick="window.syncChats && window.syncChats()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>'
                            : '<h3>–ß–∞—Ç–æ–≤ –Ω–µ—Ç</h3><p>–ù–µ—Ç —á–∞—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ</p>';
                        
                        const icon = currentSort === 'completed' ? 'üì¶' : currentSort === 'blocked' ? 'üö´' : currentSort === 'my' ? 'üë§' : currentSort === 'all' ? 'üìÅ' : searchQuery ? 'üîç' : allChats.length === 0 ? 'üîÑ' : 'üò¥';
                        
                        container.innerHTML = `
                            <div class="empty-list">
                                <div class="empty-list-icon">${icon}</div>
                                ${emptyMessage}
                            </div>
                        `;
                        isRendering = false;
                        return;
                    }
                    
                        debugLog('[RENDER] –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º', filteredChats.length, '—á–∞—Ç–æ–≤');

                        const html = filteredChats.map((chat, index) => {
                            const isCompleted = chat.status === 'completed';
                            const isBlocked = chat.status === 'blocked';
                            const isInPool = !chat.assigned_manager_id && !isCompleted && !isBlocked;
                            const isMyChat = chat.assigned_manager_id && 
                                (chat.assigned_manager_id === currentUserId || 
                                 chat.assigned_manager_name === currentUsername ||
                                 (chat.assigned_manager_name && currentUsername && 
                                  chat.assigned_manager_name.includes(currentUsername)));
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ response_timer - —ç—Ç–æ —á–∏—Å–ª–æ
                            const responseTimer = typeof chat.response_timer === 'number' ? chat.response_timer : (parseInt(chat.response_timer) || 0);
                            const timerClass = getTimerClass(responseTimer);
                            const timerText = formatTimer(responseTimer);
                            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å blink-red –µ—Å–ª–∏ —á–∞—Ç –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ –±–æ–ª–µ–µ 20 –º–∏–Ω—É—Ç
                            const blinkClass = (!isCompleted && !isBlocked && responseTimer >= 20) ? 'blink-red' : '';
                            const cardClass = `chat-card ${currentChatId === chat.id ? 'active' : ''} ${isInPool ? 'pool' : ''} ${blinkClass}`;
                            const avitoOk = chat.avito_credentials_status === 'ok' || chat.has_avito_creds;
                            const webhookOk = !!chat.webhook_registered;
                            const safeClientName = highlightText(chat.client_name || '', searchQuery);
                            const safeShopName = highlightText(chat.shop_name || '', searchQuery);
                            const safeLastMessage = highlightText(chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π', searchQuery);
                            
                            return `
                    <div class="${cardClass}" onclick="selectChat(Number(${chat.id}))" data-chat-id="${chat.id}" data-shop-id="${chat.shop_id || ''}" data-manager-id="${chat.assigned_manager_id || ''}" data-response-timer="${responseTimer}">
                        <div class="chat-card-header" style="display: flex; align-items: start; gap: 0.5rem;">
                            <input type="checkbox" class="chat-select-checkbox" onclick="event.stopPropagation(); toggleChatSelection(${chat.id})" style="margin-top: 0.25rem; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;" data-chat-id="${chat.id}">
                            <div style="flex: 1; min-width: 0;">
                            <div class="chat-card-title">
                                <div class="chat-client-name">${safeClientName}</div>
                                <div class="chat-shop-name">${safeShopName}</div>
                            </div>
                            </div>
                            </div>
                            <div class="chat-badges" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                ${isInPool ? '<span class="pool-badge">üåä –ü–£–õ</span>' : ''}
                                ${chat.unread_count > 0 ? `<span class="unread-count">${chat.unread_count}</span>` : ''}
                                ${isAdmin ? (avitoOk ? '<span class="pool-badge" style="background: #10b981;">üîë Avito</span>' : '<span class="pool-badge" style="background: #ef4444;">üîë –ù–µ—Ç –∫–ª—é—á–µ–π</span>') : ''}
                                ${isAdmin && webhookOk ? '<span class="pool-badge" style="background: #6b7280;">üîî Webhook</span>' : ''}
                                ${isInPool ? `
                                    <button class="quick-take-btn" onclick="event.stopPropagation(); takeChatFromPool(${chat.id})" title="–í–∑—è—Ç—å —á–∞—Ç –∏–∑ –ø—É–ª–∞">
                                        üì• –í–∑—è—Ç—å
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="chat-preview">${safeLastMessage}</div>
                        <div class="chat-footer">
                            ${isCompleted ? 
                                '<span class="priority-tag priority-completed">üì¶ –ó–ê–í–ï–†–®–ï–ù</span>' :
                                isBlocked ?
                                '<span class="priority-tag" style="background: #ef4444; color: white;">üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù</span>' :
                                ''
                            }
                            ${!isCompleted && !isBlocked && responseTimer > 0 ? `<span class="response-time ${timerClass} ${responseTimer >= 20 ? 'blink' : ''}" style="${responseTimer >= 20 ? 'color: #ef4444; font-weight: 700;' : ''}" title="–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞">‚è±Ô∏è ${timerText}</span>` : ''}
                        </div>
                        ${isMyChat ? `
                            <div class="chat-card-actions">
                                <button class="quick-action-btn return" onclick="event.stopPropagation(); returnChatToPool(${chat.id})" title="–í–µ—Ä–Ω—É—Ç—å –≤ –ø—É–ª">
                                    üì§ –í–µ—Ä–Ω—É—Ç—å
                            </button>
                                <button class="quick-action-btn" onclick="event.stopPropagation(); markAsCompleted(${chat.id})" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç">
                                    ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                                <button class="quick-action-btn" onclick="event.stopPropagation(); blockChat(${chat.id})" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç">
                                    üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        ` : ''}
                            </div>
                            `;
                        }).join('');
                        
                        debugLog('[RENDER] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ HTML, –¥–ª–∏–Ω–∞:', html.length);
                        
                        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º DocumentFragment –¥–ª—è batch DOM –æ–ø–µ—Ä–∞—Ü–∏–π
                        const fragment = document.createDocumentFragment();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ fragment
                        while (tempDiv.firstChild) {
                            fragment.appendChild(tempDiv.firstChild);
                        }
                        
                        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –º–æ—Ä–≥–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                        const originalDisplay = container.style.display;
                        container.style.display = 'none';
                        container.innerHTML = '';
                        container.appendChild(fragment);
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º display —Å—Ä–∞–∑—É (–±–µ–∑ requestAnimationFrame –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
                        container.style.display = originalDisplay;
                        isRendering = false;
                } catch (error) {
                    debugError('[RENDER] ‚ùå –û–®–ò–ë–ö–ê –≤ renderChatsList:', error);
                    if (DEBUG_MODE) console.error('[RENDER] Stack:', error.stack);
                } finally {
                    isRendering = false;
                }
            });
        }

        /**
         * –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ, —É–¥–∞–ª—è–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ
         */
        function updateChatsListSmart() {
            const container = domCache.chatsList;
            if (!container) {
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
                debugLog('[SMART UPDATE] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É');
                renderChatsList();
                return;
            }
            
            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
            if (filteredChats.length === 0) {
                debugLog('[SMART UPDATE] –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É');
                renderChatsList();
                return;
            }
            
            debugLog('[SMART UPDATE] –ù–∞—á–∏–Ω–∞–µ–º —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –í—Å–µ–≥–æ —á–∞—Ç–æ–≤:', filteredChats.length);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–æ–≤ –∏–∑ DOM
            const existingChats = new Map();
            container.querySelectorAll('.chat-card').forEach(card => {
                const chatId = card.getAttribute('data-chat-id');
                if (chatId) {
                    existingChats.set(Number(chatId), card);
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º Map –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
            const newChatsMap = new Map();
            filteredChats.forEach(chat => {
                newChatsMap.set(chat.id, chat);
            });
            
            // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
            const chatsToUpdate = [];
            const chatsToAdd = [];
            const chatsToRemove = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–∞—Ç—ã
            existingChats.forEach((card, chatId) => {
                if (newChatsMap.has(chatId)) {
                    // –ß–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å
                    chatsToUpdate.push(chatId);
                } else {
                    // –ß–∞—Ç —É–¥–∞–ª–µ–Ω
                    chatsToRemove.push(card);
                }
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ —á–∞—Ç—ã (—Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞)
            filteredChats.forEach(chat => {
                if (!existingChats.has(chat.id)) {
                    chatsToAdd.push(chat);
                }
            });
            
            debugLog('[SMART UPDATE] –ù–∞–π–¥–µ–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', chatsToUpdate.length, '–¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', chatsToAdd.length, '–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', chatsToRemove.length);
            
            // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Batch updates –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ DOM –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∏—Ö –≤ –æ–¥–Ω–æ–º batch —á–µ—Ä–µ–∑ requestAnimationFrame
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ reflow/repaint –æ–ø–µ—Ä–∞—Ü–∏–∏
            const updateBatch = [];
            
            chatsToUpdate.forEach(chatId => {
                const chat = newChatsMap.get(chatId);
                const existingCard = existingChats.get(chatId);
                if (!chat || !existingCard) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
                const isActive = currentChatId === chatId;
                const responseTimer = typeof chat.response_timer === 'number' ? chat.response_timer : (parseInt(chat.response_timer) || 0);
                const isCompleted = chat.status === 'completed';
                const isBlocked = chat.status === 'blocked';
                const blinkClass = (!isCompleted && !isBlocked && responseTimer >= 20) ? 'blink-red' : '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ batch
                updateBatch.push(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã
                    existingCard.className = `chat-card ${isActive ? 'active' : ''} ${!chat.assigned_manager_id && !isCompleted && !isBlocked ? 'pool' : ''} ${blinkClass}`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
                    const unreadBadge = existingCard.querySelector('.unread-count');
                    if (chat.unread_count > 0) {
                        if (!unreadBadge) {
                            const badges = existingCard.querySelector('.chat-badges');
                            if (badges) {
                                const badge = document.createElement('span');
                                badge.className = 'unread-count';
                                badge.textContent = chat.unread_count;
                                try {
                                    if (badges.firstChild) {
                                        badges.insertBefore(badge, badges.firstChild);
                                    } else {
                                        badges.appendChild(badge);
                                    }
                                } catch (error) {
                                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ firstChild, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                                    badges.appendChild(badge);
                                }
                            }
                        } else {
                            unreadBadge.textContent = chat.unread_count;
                        }
                    } else if (unreadBadge) {
                        unreadBadge.remove();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –æ—Ç–≤–µ—Ç–∞
                    const timerElement = existingCard.querySelector('.response-time');
                    if (responseTimer > 0 && !isCompleted && !isBlocked) {
                        const timerText = formatTimer(responseTimer);
                        const timerClass = getTimerClass(responseTimer);
                        if (timerElement) {
                            timerElement.textContent = `‚è±Ô∏è ${timerText}`;
                            timerElement.className = `response-time ${timerClass} ${responseTimer >= 20 ? 'blink' : ''}`;
                            timerElement.style.color = responseTimer >= 20 ? '#ef4444' : '';
                            timerElement.style.fontWeight = responseTimer >= 20 ? '700' : '';
                        } else {
                            const footer = existingCard.querySelector('.chat-footer');
                            if (footer) {
                                const timer = document.createElement('span');
                                timer.className = `response-time ${timerClass} ${responseTimer >= 20 ? 'blink' : ''}`;
                                timer.style.color = responseTimer >= 20 ? '#ef4444' : '';
                                timer.style.fontWeight = responseTimer >= 20 ? '700' : '';
                                timer.textContent = `‚è±Ô∏è ${timerText}`;
                                timer.title = '–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞';
                                footer.appendChild(timer);
                            }
                        }
                    } else if (timerElement) {
                        timerElement.remove();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const preview = existingCard.querySelector('.chat-preview');
                    if (preview) {
                        const safeLastMessage = highlightText(chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π', searchQuery);
                        preview.innerHTML = safeLastMessage;
                    }
                });
            });
            
            // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º batch —á–µ—Ä–µ–∑ requestAnimationFrame
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ reflow/repaint –æ–ø–µ—Ä–∞—Ü–∏–∏
            if (updateBatch.length > 0) {
                requestAnimationFrame(() => {
                    updateBatch.forEach(updateFn => updateFn());
                });
            }
            
            // –£–¥–∞–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —á–∞—Ç—ã –≤ batch
            if (chatsToRemove.length > 0) {
                requestAnimationFrame(() => {
                    chatsToRemove.forEach(card => card.remove());
                });
            }
            
            // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: Batch updates –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º DocumentFragment –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π DOM
            if (chatsToAdd.length > 0) {
                debugLog('[SMART UPDATE] –î–æ–±–∞–≤–ª—è–µ–º', chatsToAdd.length, '–Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ (batch mode)');
                
                // –°–æ–∑–¥–∞–µ–º DocumentFragment –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π
                const fragment = document.createDocumentFragment();
                const insertions = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π –≤—Å—Ç–∞–≤–∫–∏
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ fragment
                chatsToAdd.forEach(chat => {
                    const chatHtml = renderSingleChat(chat);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = chatHtml;
                    const newCard = tempDiv.firstChild;
                    if (!newCard) {
                        debugLog('[SMART UPDATE] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —á–∞—Ç–∞', chat.id);
                        return;
                    }
                    
                    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
                    let insertBefore = null;
                    for (let i = 0; i < filteredChats.length; i++) {
                        if (filteredChats[i].id === chat.id) {
                            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞
                            for (let j = i + 1; j < filteredChats.length; j++) {
                                const nextChat = filteredChats[j];
                                const nextCard = container.querySelector(`[data-chat-id="${nextChat.id}"]`);
                                if (nextCard) {
                                    insertBefore = nextCard;
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    
                    insertions.push({ card: newCard, insertBefore: insertBefore, chatId: chat.id });
                });
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –≤—Å—Ç–∞–≤–∫–∏ –≤ –æ–¥–Ω–æ–º batch —á–µ—Ä–µ–∑ requestAnimationFrame
                requestAnimationFrame(() => {
                    insertions.forEach(({ card, insertBefore, chatId }) => {
                        try {
                            if (insertBefore && container.contains(insertBefore)) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ insertBefore –≤—Å–µ –µ—â–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º container
                                container.insertBefore(card, insertBefore);
                                debugLog('[SMART UPDATE] –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —á–∞—Ç', chatId, '–ø–µ—Ä–µ–¥', insertBefore.getAttribute('data-chat-id'));
                            } else {
                                // –ï—Å–ª–∏ insertBefore –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –±–æ–ª—å—à–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                                container.appendChild(card);
                                debugLog('[SMART UPDATE] –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —á–∞—Ç', chatId, '–≤ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ (insertBefore –Ω–µ–≤–∞–ª–∏–¥–µ–Ω)');
                            }
                        } catch (error) {
                            // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                            console.warn('[SMART UPDATE] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —á–∞—Ç–∞', chatId, error);
                            try {
                                container.appendChild(card);
                                debugLog('[SMART UPDATE] –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —á–∞—Ç', chatId, '–≤ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ (–ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏)');
                            } catch (appendError) {
                                console.error('[SMART UPDATE] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞', chatId, appendError);
                            }
                        }
                    });
                });
            }
            
            // –ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ —á–∞—Ç–æ–≤ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–∑-–∑–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è
            // –ù–æ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ
            // (–±–æ–ª–µ–µ —á–µ–º –Ω–∞ 3 –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —á–∞—Ç–æ–≤)
            if (chatsToAdd.length === 0 && chatsToRemove.length === 0 && filteredChats.length > 0) {
                const currentCards = Array.from(container.querySelectorAll('.chat-card'));
                if (currentCards.length === filteredChats.length) {
                    let reorderCount = 0;
                    for (let i = 0; i < Math.min(filteredChats.length, 10); i++) {
                        const expectedChatId = filteredChats[i].id;
                        const actualCard = currentCards[i];
                        if (!actualCard) break;
                        const actualChatId = Number(actualCard.getAttribute('data-chat-id'));
                        if (expectedChatId !== actualChatId) {
                            reorderCount++;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥–ª—è –±–æ–ª–µ–µ —á–µ–º 30% –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                    // –≠—Ç–æ —Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏), –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
                    if (reorderCount > 3) {
                        renderChatsList();
                        return;
                    }
                }
            }
        }
        
        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç HTML –¥–ª—è –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞
         */
        function renderSingleChat(chat) {
            const isCompleted = chat.status === 'completed';
            const isBlocked = chat.status === 'blocked';
            const isInPool = !chat.assigned_manager_id && !isCompleted && !isBlocked;
            const isMyChat = chat.assigned_manager_id && chat.assigned_manager_name === currentUsername;
            const responseTimer = typeof chat.response_timer === 'number' ? chat.response_timer : (parseInt(chat.response_timer) || 0);
            const timerClass = getTimerClass(responseTimer);
            const timerText = formatTimer(responseTimer);
            const blinkClass = (!isCompleted && !isBlocked && responseTimer >= 20) ? 'blink-red' : '';
            const cardClass = `chat-card ${currentChatId === chat.id ? 'active' : ''} ${isInPool ? 'pool' : ''} ${blinkClass}`;
            const avitoOk = chat.avito_credentials_status === 'ok' || chat.has_avito_creds;
            const webhookOk = !!chat.webhook_registered;
            const safeClientName = highlightText(chat.client_name || '', searchQuery);
            const safeShopName = highlightText(chat.shop_name || '', searchQuery);
            const safeLastMessage = highlightText(chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π', searchQuery);
            
                            return `
                    <div class="${cardClass}" onclick="selectChat(Number(${chat.id}))" data-chat-id="${chat.id}" data-shop-id="${chat.shop_id || ''}" data-manager-id="${chat.assigned_manager_id || ''}" data-response-timer="${responseTimer}">
                        <div class="chat-card-header" style="display: flex; align-items: start; gap: 0.5rem;">
                            <input type="checkbox" class="chat-select-checkbox" onclick="event.stopPropagation(); toggleChatSelection(${chat.id})" style="margin-top: 0.25rem; cursor: pointer;" data-chat-id="${chat.id}">
                        <div class="chat-card-header">
                        <div class="chat-card-title">
                            <div class="chat-client-name">${safeClientName}</div>
                            <div class="chat-shop-name">${safeShopName}</div>
                        </div>
                        <div class="chat-badges" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            ${isInPool ? '<span class="pool-badge">üåä –ü–£–õ</span>' : ''}
                            ${chat.unread_count > 0 ? `<span class="unread-count">${chat.unread_count}</span>` : ''}
                            ${isAdmin ? (avitoOk ? '<span class="pool-badge" style="background: #10b981;">üîë Avito</span>' : '<span class="pool-badge" style="background: #ef4444;">üîë –ù–µ—Ç –∫–ª—é—á–µ–π</span>') : ''}
                            ${isAdmin && webhookOk ? '<span class="pool-badge" style="background: #6b7280;">üîî Webhook</span>' : ''}
                            ${isInPool ? `
                                <button class="quick-take-btn" onclick="event.stopPropagation(); takeChatFromPool(${chat.id})" title="–í–∑—è—Ç—å —á–∞—Ç –∏–∑ –ø—É–ª–∞">
                                    üì• –í–∑—è—Ç—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="chat-preview">${safeLastMessage}</div>
                    <div class="chat-footer">
                        ${isCompleted ? 
                            '<span class="priority-tag priority-completed">üì¶ –ó–ê–í–ï–†–®–ï–ù</span>' :
                            isBlocked ?
                            '<span class="priority-tag" style="background: #ef4444; color: white;">üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù</span>' :
                            ''
                        }
                        ${!isCompleted && !isBlocked && responseTimer > 0 ? `<span class="response-time ${timerClass} ${responseTimer >= 20 ? 'blink' : ''}" style="${responseTimer >= 20 ? 'color: #ef4444; font-weight: 700;' : ''}" title="–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞">‚è±Ô∏è ${timerText}</span>` : ''}
                    </div>
                    ${isMyChat ? `
                        <div class="chat-card-actions">
                            <button class="quick-action-btn return" onclick="event.stopPropagation(); returnChatToPool(${chat.id})" title="–í–µ—Ä–Ω—É—Ç—å –≤ –ø—É–ª">
                                üì§ –í–µ—Ä–Ω—É—Ç—å
                        </button>
                            <button class="quick-action-btn" onclick="event.stopPropagation(); markAsCompleted(${chat.id})" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                            <button class="quick-action-btn" onclick="event.stopPropagation(); blockChat(${chat.id})" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç">
                                üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // –í—ã–±–æ—Ä —á–∞—Ç–∞
        // –í–ï–†–°–ò–Ø: 2025-01-15 - –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ chatId === allChats.length
        function selectChat(chatId) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
            chatId = Number(chatId);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
            if (!chatId || isNaN(chatId) || chatId <= 0) {
                console.error('[SELECT CHAT] ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —á–∞—Ç–∞:', chatId, '—Ç–∏–ø:', typeof chatId);
                return;
            }
            
            currentChatId = chatId;
            const chat = allChats.find(c => Number(c.id) === chatId);
            if (!chat) {
                // –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –±—ã–ª —É–¥–∞–ª–µ–Ω
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                debugLog('[SELECT CHAT] –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤. ID:', chatId, 'allChats.length:', allChats.length);
                if (typeof window.loadChats === 'function') {
                    window.loadChats(false, true).then(() => {
                        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–æ–≤–∞ –Ω–∞–π—Ç–∏ —á–∞—Ç
                        const retryChat = allChats.find(c => Number(c.id) === chatId);
                        if (retryChat) {
                            selectChat(chatId); // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                        } else {
                            console.error('[SELECT CHAT] ‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏. ID:', chatId);
                            showNotification('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        }
                    }).catch(() => {
                        console.error('[SELECT CHAT] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤');
                        showNotification('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    });
                } else {
                    console.error('[SELECT CHAT] ‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ allChats. ID:', chatId, 'allChats.length:', allChats.length);
                    showNotification('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
                return;
            }
            const params = new URLSearchParams(window.location.search);
            params.set('chat_id', chatId);
            window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
            const isCompleted = chat && chat.status === 'completed';
            currentChatHasAvito = (chat.avito_credentials_status === 'ok') || !!chat.has_avito_creds;
            messagesState[chatId] = {
                offset: 0,
                limit: MESSAGE_PAGE,
                messages: [],
                has_more: true,
                loading: false
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ —É–º–Ω–æ, –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            updateChatsListSmart();
            
            const emptyChat = document.getElementById('empty-chat');
            const chatContent = document.getElementById('chat-content');
            if (emptyChat) emptyChat.style.display = 'none';
            if (chatContent) {
                chatContent.style.display = 'flex';
                chatContent.style.width = '100%';
                chatContent.style.height = '100%';
            }
            
            document.getElementById('chat-client-name').textContent = chat.client_name || '';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —á–∞—Ç–∞ - —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
            let headerDetails = `
                <span>üìû ${escapeHtml(chat.client_phone || '')}</span>
                <span>‚Ä¢</span>
                <span>üè™ ${escapeHtml(chat.shop_name || '')}</span>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Avito –∫–ª—é—á–∏ –∏ webhooks —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            if (isAdmin) {
                headerDetails += `
                <span>‚Ä¢</span>
                <span style="color: ${currentChatHasAvito ? '#10b981' : '#ef4444'}; font-weight: 700;">
                    ${currentChatHasAvito ? 'Avito –∫–ª—é—á–∏: OK' : '–ö–ª—é—á–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã'}
                </span>
                <span>‚Ä¢</span>
                <span style="color: ${chat.webhook_registered ? '#10b981' : '#f59e0b'};">
                    ${chat.webhook_registered ? 'Webhook: OK' : 'Webhook: –Ω–µ—Ç'}
                </span>
            `;
            }
            
            document.getElementById('chat-header-details').innerHTML = headerDetails;

            const actionsDiv = document.getElementById('chat-header-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = `
                    <button class="btn-outline" onclick="addToBlacklist()" title="–î–æ–±–∞–≤–∏—Ç—å –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">
                        <span>üö´</span> Blacklist
                    </button>
                `;
            }
            if (!actionsDiv) {
                console.error('[SELECT CHAT] chat-header-actions –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            if (isCompleted) {
                actionsDiv.innerHTML = `
                    <button class="header-action-btn" onclick="restoreChat(${chatId})" style="background: var(--success); color: white; border-color: transparent;">
                        üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                `;
            } else if (chat.status === 'blocked') {
                actionsDiv.innerHTML = `
                    <button class="header-action-btn" onclick="unblockChat(${chatId})" style="background: var(--success); color: white; border-color: transparent;">
                        üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                `;
            } else {
                const isInPool = !chat.assigned_manager_id;
                const isMyChat = chat.assigned_manager_id && 
                    (chat.assigned_manager_id === currentUserId || 
                     chat.assigned_manager_name === currentUsername ||
                     (chat.assigned_manager_name && currentUsername && 
                      chat.assigned_manager_name.includes(currentUsername)));
                actionsDiv.innerHTML = `
                    ${isInPool ? `
                        <button class="header-action-btn" onclick="takeChatFromPool(${chatId})" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border-color: transparent;">
                            üì• –í–∑—è—Ç—å –∏–∑ –ø—É–ª–∞
                        </button>
                    ` : isMyChat ? `
                        <button class="header-action-btn" onclick="returnChatToPool(${chatId})" style="background: var(--warning); color: white; border-color: transparent;">
                            üì§ –í–µ—Ä–Ω—É—Ç—å –≤ –ø—É–ª
                        </button>
                    ` : ''}
                    <button class="header-action-btn" onclick="markAsDelivery()">üöö –í –¥–æ—Å—Ç–∞–≤–∫—É</button>
                    <button class="header-action-btn" onclick="markAsCompleted()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    <button class="header-action-btn" onclick="blockChat(${chatId})" style="background: #ef4444; color: white; border-color: transparent;">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="header-action-btn" onclick="addToBlacklist()" style="background: #7c3aed; color: white; border-color: transparent;">üö´ Blacklist</button>
                `;
            }

            if (!isCompleted) {
                document.getElementById('message-text').focus();
            }

            updateSendAvailability();
            const container = document.getElementById('messages-container');
            if (container) {
                container.addEventListener('scroll', () => toggleScrollBottomButton(container));
            }
            loadChatMessages(chatId);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å
            loadListingToSidebar(chatId);
            startMessagesAutoRefresh();
        }

        function setMessagesLoadingState(isLoading) {
            messagesLoading = isLoading;
            const quickActionButtons = document.querySelectorAll('.quick-action');
            quickActionButtons.forEach(btn => btn.classList.toggle('is-disabled', isLoading));
            updateSendAvailability();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
        async function loadChatMessages(chatId, mode = 'replace') {
            if (!chatId) return;
            const state = messagesState[chatId] || {offset: 0, limit: MESSAGE_PAGE, messages: [], has_more: true, loading: false};
            if (state.loading) return;
            state.loading = true;
            messagesState[chatId] = state;
            const shouldDisableUi = mode !== 'refresh';
            if (shouldDisableUi) {
                setMessagesLoadingState(true);
            }

            const fetchOffset = mode === 'prepend' ? state.offset : 0;
            const params = new URLSearchParams({
                limit: state.limit,
                offset: fetchOffset
            });
            const prevIds = new Set((state.messages || []).map(m => m.id || `${m.timestamp}-${m.message_text}`));
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Avito –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á–∏
            const chat = allChats.find(c => c.id === chatId);
            if (chat && (chat.has_avito_creds || chat.avito_credentials_status === 'ok')) {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ (replace) –∏–ª–∏ –ø—Ä–∏ refresh
                if (mode === 'replace') {
                    params.set('sync', 'true');
                } else if (mode === 'refresh') {
                    // –ü—Ä–∏ refresh —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —á–∞—â–µ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 10) –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    const now = Date.now();
                    const lastSync = lastSyncTime.get(chatId) || 0;
                    const timeSinceLastSync = (now - lastSync) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                    
                    if (timeSinceLastSync >= 5) { // –ú–∏–Ω–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è–º–∏ (–±—ã–ª–æ 10)
                        params.set('sync', 'true');
                        lastSyncTime.set(chatId, now);
                    } else {
                        // –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î
                        params.set('sync', 'false');
                    }
                }
            } else {
            }

            const container = document.getElementById('messages-container');
            const previousHeight = container ? container.scrollHeight : 0;
            const previousScrollTop = container ? container.scrollTop : 0;

            if (state.messages.length === 0 && mode === 'replace' && container) {
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º loading, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
                container.innerHTML = '';
            } else if (mode === 'prepend') {
                const btn = document.getElementById('load-more-btn');
                if (btn) btn.disabled = true;
            }

            try {
                const response = await fetch(`/api/chats/${chatId}/messages?${params.toString()}`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const payload = await response.json();
                
                // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥: –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º messages
                let messages = [];
                if (Array.isArray(payload)) {
                    messages = payload;
                } else if (payload && typeof payload === 'object') {
                    if (Array.isArray(payload.messages)) {
                        messages = payload.messages;
                    } else if (Array.isArray(payload.items)) {
                        messages = payload.items;
                    } else if (payload.messages && typeof payload.messages === 'object') {
                        // –ï—Å–ª–∏ messages - –æ–±—ä–µ–∫—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –º–∞—Å—Å–∏–≤
                        messages = [];
                        console.warn('[LOAD MESSAGES] payload.messages –Ω–µ –º–∞—Å—Å–∏–≤:', payload.messages);
                    }
                }
                
                const hasMore = payload.has_more ?? (messages.length === state.limit);

                if (mode === 'prepend') {
                    state.messages = [...messages, ...state.messages];
                    state.offset += messages.length;
                } else {
                    state.messages = messages;
                    state.offset = messages.length;
                }

                state.has_more = hasMore;
                renderMessages(
                    chatId,
                    mode === 'prepend' ? previousHeight : null,
                    mode === 'refresh' ? previousScrollTop : null,
                    mode
                );
                if (mode === 'refresh') {
                    const container = document.getElementById('messages-container');
                    if (container) {
                        const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
                        const newlyLoaded = messages.filter(msg => {
                            const key = msg.id || `${msg.timestamp}-${msg.message_text}`;
                            return !prevIds.has(key);
                        });
                        if (distanceFromBottom > 200 && newlyLoaded.length > 0) {
                            unreadFromRefresh += newlyLoaded.length;
                            updateUnreadIndicator(container, state.messages);
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            } finally {
                state.loading = false;
                messagesState[chatId] = state;
                const btn = document.getElementById('load-more-btn');
                if (btn) btn.disabled = false;
                if (shouldDisableUi) {
                    setMessagesLoadingState(false);
                }
            }
        }

        function renderMessages(chatId, previousHeight = null, previousScrollTop = null, mode = 'replace') {
            const state = messagesState[chatId] || {messages: [], has_more: false};
            const container = document.getElementById('messages-container');
            if (!container) {
                console.error('[RENDER MESSAGES] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #messages-container –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω
            const chatContent = document.getElementById('chat-content');
            if (chatContent && chatContent.style.display === 'none') {
                console.warn('[RENDER MESSAGES] chat-content —Å–∫—Ä—ã—Ç, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å');
                chatContent.style.display = 'flex';
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                console.warn('[RENDER MESSAGES] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã!', {
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    display: window.getComputedStyle(container).display
                });
            }
            
            if (!state.messages || state.messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon">üí¨</div>
                            <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                        </div>
                    `;
                    return;
                }

            const loadMoreBtn = state.has_more ? `
                <button id="load-more-btn" class="load-more-btn" ${state.loading ? 'disabled' : ''} onclick="loadOlderMessages()">
                    ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                </button>
            ` : '';

            const messagesHtml = state.messages.map(messageTemplate).join('');
            container.innerHTML = `${loadMoreBtn}${messagesHtml}`;
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º layout –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            container.offsetHeight; // Trigger reflow

            if (mode === 'refresh' && previousScrollTop !== null) {
                container.scrollTop = previousScrollTop;
            } else if (previousHeight !== null) {
                const newHeight = container.scrollHeight;
                container.scrollTop = newHeight - previousHeight;
            } else {
                container.scrollTop = container.scrollHeight;
            }

            toggleScrollBottomButton(container);
            updateUnreadIndicator(container, state.messages);
        }

        function messageTemplate(msg) {
                    const messageClass = msg.message_type === 'incoming' ? 'incoming' : 'outgoing';
                    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                    let time = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    try {
                        const msgDate = new Date(msg.timestamp);
                        if (!isNaN(msgDate.getTime())) {
                            time = msgDate.toLocaleString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit',
                        day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                    });
                        }
                    } catch (e) {
                        console.error('[RENDER MESSAGES] –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e, 'timestamp:', msg.timestamp);
                    }
            // –î–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –∑–∞–º–µ–Ω—è—è "–°–∏—Å—Ç–µ–º–∞" –Ω–∞ username —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let displayManager = msg.manager_name || currentUsername || '–°–∏—Å—Ç–µ–º–∞';
            if (messageClass === 'outgoing' && displayManager === '–°–∏—Å—Ç–µ–º–∞' && currentUsername) {
                displayManager = currentUsername;
            }
            const safeManager = escapeHtml(displayManager);
            const safeText = escapeHtml(msg.message_text || '');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const managerName = (messageClass === 'outgoing') ? `<div class="message-author">${safeManager}</div>` : '';

                    return `
                        <div class="message-row ${messageClass}">
                            ${managerName}
                            <div class="message-wrapper">
                        <div class="message-bubble">${safeText}</div>
                                <div class="message-time">${time}</div>
                            </div>
                        </div>
                    `;
        }

        async function loadOlderMessages() {
            if (!currentChatId) return;
            const container = document.getElementById('messages-container');
            const previousHeight = container ? container.scrollHeight : null;
            await loadChatMessages(currentChatId, 'prepend');
            if (previousHeight !== null) {
                // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –±–µ–∑ requestAnimationFrame
                    container.scrollTop = container.scrollHeight - previousHeight;
            }
        }

        function scrollMessagesBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTo({top: container.scrollHeight, behavior: 'smooth'});
                unreadFromRefresh = 0;
                updateUnreadIndicator(container, messagesState[currentChatId]?.messages || []);
            }
        }

        function toggleScrollBottomButton(container) {
            const btn = document.getElementById('scroll-bottom-btn');
            if (!container || !btn) return;
            const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
            btn.classList.toggle('show', distanceFromBottom > 200);
        }

        function updateUnreadIndicator(container, messages) {
            const btn = document.getElementById('scroll-bottom-btn');
            if (!btn) return;
            const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
            if (distanceFromBottom <= 200) {
                unreadFromRefresh = 0;
            }
            const badge = btn.querySelector('.unread-indicator');
            if (!badge && unreadFromRefresh > 0) {
                btn.insertAdjacentHTML('beforeend', `<span class="unread-indicator">${unreadFromRefresh}</span>`);
            } else if (badge) {
                badge.textContent = unreadFromRefresh;
                badge.style.display = unreadFromRefresh > 0 ? 'flex' : 'none';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            if (!currentChatId) return;
            if (messagesLoading) return;
            if (!currentChatHasAvito) {
                showNotification('–î–ª—è —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã OAuth –∫–ª—é—á–∏ Avito', 'error');
                return;
            }

            const messageInput = document.getElementById('message-text');
            let messageText = messageInput.value.trim();

            if (!messageText) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                return;
            }

            const quickReply = await getQuickReplyByText(messageText);
            if (quickReply) {
                messageText = quickReply;
            }

            const messageTextToShow = messageText;
            messageInput.value = '';
            messageInput.style.height = 'auto';

            const container = document.getElementById('messages-container');
            if (container.querySelector('.empty-chat')) {
                container.innerHTML = '';
            }
            
            const now = new Date();
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const timeStr = now.toLocaleString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const tempId = 'temp-' + Date.now();
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            const senderName = currentUsername || '–ú–∞–≥–∞–∑–∏–Ω';
            const managerNameHtml = `<div class="message-author">${escapeHtml(senderName)}</div>`;
            container.insertAdjacentHTML('beforeend', `
                <div class="message-row outgoing" id="${tempId}">
                    ${managerNameHtml}
                    <div class="message-wrapper">
                        <div class="message-bubble">${escapeHtml(messageTextToShow)}</div>
                        <div class="message-time">${timeStr}</div>
                    </div>
                </div>
            `);
            container.scrollTop = container.scrollHeight;

            const sendButton = document.querySelector('.send-button');
            if (sendButton) sendButton.disabled = true;

            fetch(`/api/chats/${currentChatId}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({message: messageText})
            }).then(response => {
                if (response.ok) return response.json();
                return response.json().catch(() => ({})).then(err => {
                    const msg = err.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';
                    throw new Error(msg);
                });
            }).then(data => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                if (data.warning) {
                    showNotification(`‚ö†Ô∏è ${data.warning}`, 'warning');
                }
                
                // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–Ω–æ–≤–∏–º –≤ —Ñ–æ–Ω–µ
                loadChatMessages(currentChatId).then(() => {
                    const temp = document.getElementById(tempId);
                    if (temp) temp.remove();
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤ —Ñ–æ–Ω–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
                loadChats(false, true).catch(() => {});
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'}`, 'error');
                messageInput.value = messageTextToShow;
                const temp = document.getElementById(tempId);
                if (temp) temp.remove();
            }).finally(() => {
                if (sendButton) sendButton.disabled = false;
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (24 –ú–ë –º–∞–∫—Å–∏–º—É–º)
            const maxSize = 24 * 1024 * 1024; // 24 –ú–ë
            if (file.size > maxSize) {
                showNotification('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 24 –ú–ë)', 'error');
                return;
            }

            if (!currentChatId) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            showNotification('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'info');

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('/api/upload/image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }

                const uploadData = await uploadResponse.json();
                const imageId = uploadData.image_id;

                if (!imageId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å image_id');
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç
                const sendResponse = await fetch(`/api/chats/${currentChatId}/messages/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({image_id: imageId})
                });

                if (!sendResponse.ok) {
                    const error = await sendResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await loadChatMessages(currentChatId);
                loadChats(false, true).catch(() => {});

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'}`, 'error');
            } finally {
                // –û—á–∏—â–∞–µ–º input
                event.target.value = '';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞—É–¥–∏–æ
        async function handleVoiceUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            const isAudio = file.type.startsWith('audio/');
            const isVideo = file.type === 'video/mp4'; // Avito –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç opus –≤ mp4 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            
            if (!isAudio && !isVideo) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª –∏–ª–∏ –≤–∏–¥–µ–æ (mp4)', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–¥–ª—è –∞—É–¥–∏–æ –æ–±—ã—á–Ω–æ –º–µ–Ω—å—à–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º)
            const maxSize = 50 * 1024 * 1024; // 50 –ú–ë –¥–ª—è –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ
            if (file.size > maxSize) {
                showNotification('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 50 –ú–ë)', 'error');
                return;
            }

            if (!currentChatId) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            showNotification('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞...', 'info');

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
                const formData = new FormData();
                formData.append('file', file);
                formData.append('file_type', isAudio ? 'audio' : 'video');

                const uploadResponse = await fetch('/api/upload/media', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞');
                }

                const uploadData = await uploadResponse.json();
                const attachmentId = uploadData.attachment_id || uploadData.id;

                if (!attachmentId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å attachment_id');
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ —á–∞—Ç –∫–∞–∫ –≤–ª–æ–∂–µ–Ω–∏–µ
                const messageText = document.getElementById('message-text').value || '';
                const sendResponse = await fetch(`/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: messageText,
                        attachments: [{'id': attachmentId}]
                    })
                });

                if (!sendResponse.ok) {
                    const error = await sendResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞');
                }

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                document.getElementById('message-text').value = '';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await loadChatMessages(currentChatId);
                loadChats(false, true).catch(() => {});

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞'}`, 'error');
            } finally {
                // –û—á–∏—â–∞–µ–º input
                event.target.value = '';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∏—Ö –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤
        async function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
            const maxSize = 50 * 1024 * 1024; // 50 –ú–ë
            if (file.size > maxSize) {
                showNotification('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 50 –ú–ë)', 'error');
                return;
            }

            if (!currentChatId) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            showNotification('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'info');

            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                let fileType = 'document';
                if (file.type.startsWith('video/')) {
                    fileType = 'video';
                } else if (file.type.startsWith('audio/')) {
                    fileType = 'audio';
                } else if (file.type.startsWith('image/')) {
                    fileType = 'photo';
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
                const formData = new FormData();
                formData.append('file', file);
                formData.append('file_type', fileType);

                const uploadResponse = await fetch('/api/upload/media', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                }

                const uploadData = await uploadResponse.json();
                const attachmentId = uploadData.attachment_id || uploadData.id;

                if (!attachmentId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å attachment_id');
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ —á–∞—Ç –∫–∞–∫ –≤–ª–æ–∂–µ–Ω–∏–µ
                const messageText = document.getElementById('message-text').value || '';
                const sendResponse = await fetch(`/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: messageText,
                        attachments: [{'id': attachmentId}]
                    })
                });

                if (!sendResponse.ok) {
                    const error = await sendResponse.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
                }

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                document.getElementById('message-text').value = '';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await loadChatMessages(currentChatId);
                loadChats(false, true).catch(() => {});

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞'}`, 'error');
            } finally {
                // –û—á–∏—â–∞–µ–º input
                event.target.value = '';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ blacklist
        async function addToBlacklist() {
            if (!currentChatId) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
                const chatResponse = await fetch(`/api/chats/${currentChatId}`, {
                    credentials: 'include'
                });

                if (!chatResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ');
                }

                const chatData = await chatResponse.json();
                const chat = chatData.chat;

                if (!chat) {
                    throw new Error('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
                const reason = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ blacklist (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
                if (reason === null) {
                    return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
                }

                showNotification('üì§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ blacklist...', 'info');

                // –ü–æ–ª—É—á–∞–µ–º user_id –º–∞–≥–∞–∑–∏–Ω–∞ –∏–∑ —á–∞—Ç–∞
                const shopResponse = await fetch(`/api/chats/${currentChatId}`, {
                    credentials: 'include'
                });
                const shopData = await shopResponse.json();
                const shopUserId = shopData.chat?.shop_user_id;

                if (!shopUserId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id –º–∞–≥–∞–∑–∏–Ω–∞');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ blacklist
                const blacklistData = {
                    user_id: shopUserId,
                    phone: chat.client_phone || null,
                    user_id_to_block: chat.client_user_id || null,
                    reason: reason || null
                };

                const response = await fetch('/api/blacklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(blacklistData)
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ blacklist');
                }

                showNotification('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ blacklist', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ blacklist:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ blacklist'}`, 'error');
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
        async function getQuickReplyByText(text) {
            try {
                const now = Date.now();
                if (!quickRepliesCache || (now - quickRepliesCacheTime) > CACHE_DURATION) {
                    const response = await fetch('/api/quick-replies', {
                        credentials: 'include'
                    });
                    quickRepliesCache = await response.json();
                    quickRepliesCacheTime = now;
                }

                const normalizedText = text.toLowerCase().trim();
                const reply = quickRepliesCache.find(r => {
                    const shortcutRaw = r.shortcut || '';
                    const shortcut = shortcutRaw.toLowerCase().replace(/^\//, '');
                    return shortcut === normalizedText || shortcutRaw.toLowerCase() === normalizedText;
                });
                return reply ? reply.message : null;
            } catch (error) {
                return null;
            }
        }

        async function showQuickRepliesMenu() {
            const menu = document.getElementById('quick-replies-menu');
            menu.classList.toggle('active');

            if (menu.classList.contains('active')) {
                try {
                    const now = Date.now();
                    if (!quickRepliesCache || (now - quickRepliesCacheTime) > CACHE_DURATION) {
                        const response = await fetch('/api/quick-replies', {
                            credentials: 'include'
                        });
                        quickRepliesCache = await response.json();
                        quickRepliesCacheTime = now;
                    }

                    const replies = quickRepliesCache || [];
                    document.getElementById('quick-replies-total').textContent = replies.length;
                    document.getElementById('quick-replies-count').textContent = replies.length > 0 ? `(${replies.length})` : '';

                    if (replies.length === 0) {
                        document.getElementById('quick-replies-list').innerHTML = `
                            <div class="quick-replies-empty">
                                <div class="quick-replies-empty-icon">‚ö°</div>
                                <div class="quick-replies-empty-title">–ù–µ—Ç –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
                                <div style="font-size: 0.875rem; opacity: 0.8;">–°–æ–∑–¥–∞–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã</div>
                                <a href="/quick-replies" class="quick-replies-empty-link">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π</a>
                            </div>
                        `;
                    } else {
                        document.getElementById('quick-replies-list').innerHTML = replies.map(reply => {
                            const shortcut = reply.shortcut.replace(/^\//, '');
                            const previewRaw = reply.message || '';
                            const preview = previewRaw.length > 80 ? previewRaw.substring(0, 80) + '...' : previewRaw;
                            const safePreview = escapeHtml(preview);
                            const safeMessageAttr = reply.message.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const charCount = reply.message.length;
                            return `
                                <div class="quick-reply-item" onclick="useQuickReply('${safeMessageAttr}')">
                                    <span class="quick-reply-shortcut">${shortcut}</span>
                                    <div class="quick-reply-content">
                                        <div class="quick-reply-text">${safePreview}</div>
                                        <div class="quick-reply-meta">
                                            <span>üìù ${charCount} —Å–∏–º–≤–æ–ª–æ–≤</span>
                                        </div>
                                    </div>
                                    <button class="quick-reply-send" onclick="event.stopPropagation(); sendQuickReply('${safeMessageAttr}').catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:', err))">
                                        <span>üì§</span>
                                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                                    </button>
                                </div>
                            `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:', error);
                }
            }
        }


        function useQuickReply(message) {
            document.getElementById('message-text').value = message;
            document.getElementById('quick-replies-menu').classList.remove('active');
        }

        async function sendQuickReply(message) {
            document.getElementById('message-text').value = message;
            document.getElementById('quick-replies-menu').classList.remove('active');
            await sendMessage();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ã—Å—Ç—Ä—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        async function showQuickRepliesManagementModal() {
            const modal = document.getElementById('quick-replies-management-modal');
            modal.style.display = 'flex';
            await loadQuickRepliesManagementList();
        }

        function closeQuickRepliesManagementModal() {
            const modal = document.getElementById('quick-replies-management-modal');
            modal.style.display = 'none';
        }

        async function loadQuickRepliesManagementList() {
            try {
                const response = await fetch('/api/quick-replies/all', {
                    credentials: 'include'
                });
                const replies = await response.json();
                const container = document.getElementById('quick-replies-management-list');

                if (replies.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö°</div>
                            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">–ù–µ—Ç –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
                            <div style="font-size: 0.875rem; opacity: 0.8;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = replies.map(reply => {
                    const shortcut = reply.shortcut?.replace(/^\//, '') || '';
                    const preview = (reply.message || '').length > 100 
                        ? (reply.message || '').substring(0, 100) + '...' 
                        : (reply.message || '');
                    const isActive = reply.is_active !== 0;
                    return `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="font-weight: 700; color: var(--primary);">${shortcut}</span>
                                        ${!isActive ? '<span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 4px;">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>' : ''}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.875rem; line-height: 1.5;">${escapeHtml(preview)}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                                <button onclick="editQuickReply(${reply.id})" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.875rem;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="deleteQuickReply(${reply.id})" style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.875rem;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤', 'error');
            }
        }

        function showQuickReplyEditModal(replyId = null) {
            const modal = document.getElementById('quick-reply-edit-modal');
            const title = document.getElementById('quick-reply-edit-title');
            const form = document.getElementById('quick-reply-edit-form');
            const idInput = document.getElementById('quick-reply-edit-id');
            const shortcutInput = document.getElementById('quick-reply-edit-shortcut');
            const messageInput = document.getElementById('quick-reply-edit-message');

            if (replyId) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
                title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç';
                idInput.value = replyId;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                fetch('/api/quick-replies/all', { credentials: 'include' })
                    .then(res => res.json())
                    .then(replies => {
                        const reply = replies.find(r => r.id === replyId);
                        if (reply) {
                            shortcutInput.value = reply.shortcut?.replace(/^\//, '') || '';
                            messageInput.value = reply.message || '';
                        }
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:', err);
                        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                    });
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
                title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç';
                idInput.value = '';
                shortcutInput.value = '';
                messageInput.value = '';
            }

            modal.style.display = 'flex';
        }

        function closeQuickReplyEditModal() {
            const modal = document.getElementById('quick-reply-edit-modal');
            modal.style.display = 'none';
        }

        async function saveQuickReply(event) {
            event.preventDefault();
            
            const idInput = document.getElementById('quick-reply-edit-id');
            const shortcutInput = document.getElementById('quick-reply-edit-shortcut');
            const messageInput = document.getElementById('quick-reply-edit-message');

            const replyId = idInput.value;
            let shortcut = shortcutInput.value.trim();
            const message = messageInput.value.trim();

            if (!shortcut || !message) {
                showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            // –£–±–∏—Ä–∞–µ–º "/" –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ
            if (shortcut.startsWith('/')) {
                shortcut = shortcut.substring(1);
            }

            try {
                let response;
                if (replyId) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    response = await fetch(`/api/quick-replies/${replyId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            shortcut: shortcut,
                            message: message
                        })
                    });
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ
                    response = await fetch('/api/quick-replies', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            shortcut: shortcut,
                            message: message
                        })
                    });
                }

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

                showNotification(replyId ? '‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç —Å–æ–∑–¥–∞–Ω', 'success');
                closeQuickReplyEditModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                await loadQuickRepliesManagementList();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –º–µ–Ω—é –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                quickRepliesCache = null;
                quickRepliesCacheTime = 0;
                if (document.getElementById('quick-replies-menu').classList.contains('active')) {
                    showQuickRepliesMenu();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'}`, 'error');
            }
        }

        async function deleteQuickReply(replyId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç?')) {
                return;
            }

            try {
                const response = await fetch(`/api/quick-replies/${replyId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }

                showNotification('‚úÖ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç —É–¥–∞–ª–µ–Ω', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                await loadQuickRepliesManagementList();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –º–µ–Ω—é –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                quickRepliesCache = null;
                quickRepliesCacheTime = 0;
                if (document.getElementById('quick-replies-menu').classList.contains('active')) {
                    showQuickRepliesMenu();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:', error);
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'}`, 'error');
            }
        }

        function editQuickReply(replyId) {
            showQuickReplyEditModal(replyId);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ backdrop
        document.addEventListener('click', (e) => {
            const managementModal = document.getElementById('quick-replies-management-modal');
            const editModal = document.getElementById('quick-reply-edit-modal');
            
            if (e.target === managementModal) {
                closeQuickRepliesManagementModal();
            }
            if (e.target === editModal) {
                closeQuickReplyEditModal();
            }
        });

        // –î–µ–π—Å—Ç–≤–∏—è —Å —á–∞—Ç–æ–º
        async function apiAction(url, options, successMessage, onSuccess, onError) {
            try {
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ credentials –≤–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (!options.credentials) {
                    options.credentials = 'include';
                }
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errJson = await response.json().catch(() => ({}));
                    const msg = errJson.error || `HTTP ${response.status}`;
                    throw new Error(msg);
                }
                if (onSuccess) await onSuccess();
                if (successMessage) showNotification(successMessage, 'success');
            } catch (error) {
                if (onError) {
                    onError(error);
                } else {
                showNotification(`‚ùå ${error.message || '–û—à–∏–±–∫–∞'}`, 'error');
                }
            }
        }

        function markAsDelivery() {
            if (!currentChatId) return;
            apiAction('/api/deliveries', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({chat_id: currentChatId, status: 'processing'})
            }, '‚úÖ –ß–∞—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ –¥–æ—Å—Ç–∞–≤–∫—É', () => loadChats());
        }

        function markAsCompleted(chatId) {
            // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –≤—ã–∑–æ–≤ –∫–∞–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º, —Ç–∞–∫ –∏ –±–µ–∑ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞)
            const targetChatId = chatId || currentChatId;
            if (!targetChatId) return;
            apiAction(`/api/chats/${targetChatId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({status: 'completed'})
            }, '‚úÖ –ß–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', async () => {
                await loadChats();
                if (currentSort === 'completed') {
                    applySort('all');
                }
                // –ï—Å–ª–∏ —á–∞—Ç –±—ã–ª –æ—Ç–∫—Ä—ã—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                if (targetChatId === currentChatId) {
                    currentChatId = null;
                    document.getElementById('empty-chat').style.display = 'flex';
                    document.getElementById('chat-content').style.display = 'none';
                }
            });
        }

        // –û—á–µ—Ä–µ–¥—å –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —á–∞—Ç–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
        let batchTakeQueue = [];
        let batchTakeTimer = null;
        let batchTakeInProgress = false; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
        const BATCH_TAKE_DELAY = 300; // 300–º—Å –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
        const BATCH_TAKE_SIZE = 50; // –ú–∞–∫—Å–∏–º—É–º —á–∞—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∞—Ç—á–∞ —á–∞—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function flushBatchTakeQueue() {
            if (batchTakeQueue.length === 0) return;
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            if (batchTakeInProgress) {
                console.warn('[BATCH TAKE] –£–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                return;
            }
            
            batchTakeInProgress = true;
            const chatIds = [...batchTakeQueue];
            batchTakeQueue = [];
            
            if (chatIds.length === 0) {
                batchTakeInProgress = false;
                return;
            }
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é fetch —Å retry
                const response = await fetchWithRetry('/api/chats/batch-take', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ chat_ids: chatIds })
                }, 3);
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                    const taken = data.taken || [];
                    const errors = data.errors || [];
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —á–∞—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    taken.forEach(chatId => {
                        const chatIndex = allChats.findIndex(c => c.id === chatId);
                        if (chatIndex !== -1) {
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ assigned_manager_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                            if (!allChats[chatIndex].assigned_manager_id || allChats[chatIndex].assigned_manager_id === true) {
                                allChats[chatIndex].assigned_manager_id = currentUserId;
                            }
                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ assigned_manager_name —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                            if (!allChats[chatIndex].assigned_manager_name || allChats[chatIndex].assigned_manager_name !== currentUsername) {
                                allChats[chatIndex].assigned_manager_name = currentUsername;
                            }
                        }
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ–≥–æ –±–∞—Ç—á–∞
                    updateCounters();
                    
                    if (errors.length > 0) {
                        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏
                        errors.forEach(err => {
                            const chatId = err.chat_id;
                            locallyTakenChats.delete(chatId);
                            locallyTakenChatsTimestamps.delete(chatId);
                            const chatIndex = allChats.findIndex(c => c.id === chatId);
                            if (chatIndex !== -1) {
                                allChats[chatIndex].assigned_manager_id = null;
                                allChats[chatIndex].assigned_manager_name = null;
                            }
                        });
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Ç—ã –≤ DOM –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if (currentSort === 'all' && errors.length > 0) {
                            applySort('all');
                            renderChatsList();
                        }
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —á–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
                    if (taken.length > 0) {
                        // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∑—è—Ç—ã—Ö —á–∞—Ç–∞—Ö –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                        // —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∏—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                        const takenChatsData = taken.map(chatId => {
                            const chatIndex = allChats.findIndex(c => c.id === chatId);
                            if (chatIndex !== -1) {
                                return {
                                    id: chatId,
                                    assigned_manager_id: allChats[chatIndex].assigned_manager_id,
                                    assigned_manager_name: allChats[chatIndex].assigned_manager_name
                                };
                            }
                            return null;
                        }).filter(Boolean);
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        if (typeof window.loadChats === 'function') {
                            window.loadChats(false, true).then(() => {
                                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∑—è—Ç—ã—Ö —á–∞—Ç–æ–≤, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Ö –Ω–µ –æ–±–Ω–æ–≤–∏–ª
                                takenChatsData.forEach(takenChat => {
                                    const chatIndex = allChats.findIndex(c => c.id === takenChat.id);
                                    if (chatIndex !== -1) {
                                        const chat = allChats[chatIndex];
                                        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ–±–Ω–æ–≤–∏–ª assigned_manager_id, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                                        if (!chat.assigned_manager_id || chat.assigned_manager_id === null) {
                                            chat.assigned_manager_id = takenChat.assigned_manager_id || currentUserId;
                                            chat.assigned_manager_name = takenChat.assigned_manager_name || currentUsername;
                                            debugLog('[BATCH TAKE] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —á–∞—Ç–∞', takenChat.id);
                                        } else if (chat.assigned_manager_id !== currentUserId) {
                                            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥–æ–π ID, –ø—Ä–æ–≤–µ—Ä—è–µ–º - –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –æ—à–∏–±–∫–∞
                                            if (DEBUG_MODE) {
                                                console.warn('[BATCH TAKE] –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥–æ–π assigned_manager_id –¥–ª—è —á–∞—Ç–∞', takenChat.id, 
                                                           '–æ–∂–∏–¥–∞–ª–∏:', currentUserId, '–ø–æ–ª—É—á–∏–ª–∏:', chat.assigned_manager_id);
                                            }
                                        }
                                    }
                                });
                                
                                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
                                applySort(currentSort);
                                renderChatsList();
                                
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤—Å–µ –≤–∑—è—Ç—ã–µ —á–∞—Ç—ã –≤–∏–¥–Ω—ã –≤ "–ú–æ–∏ —á–∞—Ç—ã"
                                if (currentSort === 'my') {
                                    let missingChats = [];
                                    taken.forEach(chatId => {
                                        const chatIndex = allChats.findIndex(c => c.id === chatId);
                                        if (chatIndex !== -1) {
                                            const chat = allChats[chatIndex];
                                            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ assigned_manager_id —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                                            if (!chat.assigned_manager_id || chat.assigned_manager_id !== currentUserId) {
                                                chat.assigned_manager_id = currentUserId;
                                                chat.assigned_manager_name = currentUsername;
                                                missingChats.push(chatId);
                                            }
                                        } else {
                                            missingChats.push(chatId);
                                        }
                                    });
                                    if (missingChats.length > 0) {
                                        debugLog('[BATCH TAKE] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è —á–∞—Ç–æ–≤:', missingChats);
                                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –µ—â–µ —Ä–∞–∑
                                        applySort(currentSort);
                                        renderChatsList();
                                    }
                                }
                            }).catch(() => {
                                // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                applySort(currentSort);
                                renderChatsList();
                            });
                        } else {
                            // –ï—Å–ª–∏ loadChats –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                            applySort(currentSort);
                            renderChatsList();
                        }
                        
                        // –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º locallyTakenChats –¥–ª—è —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                        // –≠—Ç–æ –¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
                        setTimeout(() => {
                            taken.forEach(chatId => {
                                const chatIndex = allChats.findIndex(c => c.id === chatId);
                                if (chatIndex !== -1) {
                                    const chat = allChats[chatIndex];
                                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, —É–¥–∞–ª—è–µ–º –∏–∑ Set
                                    if (chat.assigned_manager_id && chat.assigned_manager_id === currentUserId) {
                                        locallyTakenChats.delete(chatId);
                                        locallyTakenChatsTimestamps.delete(chatId);
                                        debugLog('[BATCH TAKE] –£–¥–∞–ª–µ–Ω —á–∞—Ç', chatId, '–∏–∑ locallyTakenChats –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞');
                                    }
                                }
                            });
                        }, DELAYS.BATCH_TAKE_CLEANUP); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    }
                } else {
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    chatIds.forEach(chatId => {
                        locallyTakenChats.delete(chatId);
                        locallyTakenChatsTimestamps.delete(chatId);
                        const chatIndex = allChats.findIndex(c => c.id === chatId);
                        if (chatIndex !== -1) {
                            allChats[chatIndex].assigned_manager_id = null;
                            allChats[chatIndex].assigned_manager_name = null;
                        }
                    });
                    
                    if (currentSort === 'all') {
                        applySort('all');
                        renderChatsList();
                    }
                    
                    showNotification(`‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —á–∞—Ç–æ–≤`, 'error');
                }
            } catch (error) {
                debugError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —á–∞—Ç–æ–≤:', error);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                chatIds.forEach(chatId => {
                    locallyTakenChats.delete(chatId);
                    locallyTakenChatsTimestamps.delete(chatId);
                    const chatIndex = allChats.findIndex(c => c.id === chatId);
                    if (chatIndex !== -1) {
                        allChats[chatIndex].assigned_manager_id = null;
                        allChats[chatIndex].assigned_manager_name = null;
                    }
                });
                showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ —á–∞—Ç–æ–≤`, 'error');
            } finally {
                batchTakeInProgress = false;
                
                if (currentSort === 'all') {
                    applySort('all');
                    renderChatsList();
                }
            }
        }
        
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        function updateCounters() {
            initDOMCache();
            const myChatsCountEl = domCache.myChatsCount;
            const poolCountEl = domCache.poolChatsCount;
            if (!myChatsCountEl && !poolCountEl) return;
            
            let myCount = 0, poolCount = 0;
            for (let i = 0; i < allChats.length; i++) {
                const c = allChats[i];
                if (c.status === 'completed' || c.status === 'blocked') continue;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ) –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏
                const isMyChat = c.assigned_manager_id && c.assigned_manager_id !== null && c.assigned_manager_id !== undefined && 
                    (c.assigned_manager_id === currentUserId || c.assigned_manager_name === currentUsername);
                if (isMyChat) {
                    myCount++;
                } else if (!c.assigned_manager_id || c.assigned_manager_id === null || c.assigned_manager_id === undefined || c.assigned_manager_id === false) {
                    poolCount++;
                }
            }
            if (myChatsCountEl) myChatsCountEl.textContent = `(${myCount})`;
            if (poolCountEl) poolCountEl.textContent = `(${poolCount})`;
        }
        
        function takeChatFromPool(chatId) {
            chatId = Number(chatId);
            if (!chatId || isNaN(chatId)) return;
            
            // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç –≤ –º–∞—Å—Å–∏–≤–µ allChats –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const chatIndex = allChats.findIndex(c => c.id === chatId);
            if (chatIndex === -1) return;
            
            const chat = allChats[chatIndex];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤–∑—è—Ç –ª–∏ —É–∂–µ —á–∞—Ç
            if (chat.assigned_manager_id) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ Set –ª–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã—Ö —á–∞—Ç–æ–≤
            locallyTakenChats.add(chatId);
            
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ currentUserId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏–Ω–∞—á–µ –Ω–µ –º–æ–∂–µ–º –≤–∑—è—Ç—å —á–∞—Ç
            if (currentUserId === null || currentUserId === undefined) {
                debugError('[TAKE CHAT] currentUserId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–∑—è—Ç—å —á–∞—Ç');
                locallyTakenChats.delete(chatId);
                locallyTakenChatsTimestamps.delete(chatId);
                showNotification('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            chat.assigned_manager_id = currentUserId;
            chat.assigned_manager_name = currentUsername;
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º —á–∞—Ç –∏–∑ filteredChats –∏ DOM —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–û–±—â–∏–π –ø—É–ª"
            if (currentSort === 'all') {
                const filteredIndex = filteredChats.findIndex(c => c.id === chatId);
                if (filteredIndex !== -1) {
                    filteredChats.splice(filteredIndex, 1);
                }
                
                // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —á–∞—Ç–∞ –∏–∑ DOM —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤ "–û–±—â–∏–π –ø—É–ª"
                const chatCard = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (chatCard) {
                    chatCard.remove();
                }
            } else if (currentSort === 'my') {
                // –ï—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–ú–æ–∏ —á–∞—Ç—ã", –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ filteredChats –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –µ—â–µ –Ω–µ—Ç
                const filteredIndex = filteredChats.findIndex(c => c.id === chatId);
                if (filteredIndex === -1) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä "–ú–æ–∏ —á–∞—Ç—ã" (–ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏)
                    const isMyChat = chat.assigned_manager_id && 
                        (chat.assigned_manager_id === currentUserId || 
                         chat.assigned_manager_name === currentUsername ||
                         (chat.assigned_manager_name && currentUsername && 
                          chat.assigned_manager_name.includes(currentUsername)));
                    if (isMyChat &&
                        chat.status !== 'completed' &&
                        chat.status !== 'blocked') {
                        filteredChats.push(chat);
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                        applySort(currentSort);
                        renderChatsList();
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –±–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (!batchTakeQueue.includes(chatId)) {
                batchTakeQueue.push(chatId);
            }
            
            // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –¥–æ—Å—Ç–∏–≥–ª–∞ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É
            if (batchTakeQueue.length >= BATCH_TAKE_SIZE) {
                if (batchTakeTimer) {
                    clearTimeout(batchTakeTimer);
                    batchTakeTimer = null;
                }
                flushBatchTakeQueue();
            } else {
                // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
                if (batchTakeTimer) {
                    clearTimeout(batchTakeTimer);
                }
                batchTakeTimer = setTimeout(flushBatchTakeQueue, BATCH_TAKE_DELAY);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ä–∞–∑—É (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ)
            updateCounters();
        }

        function returnChatToPool(chatId) {
            chatId = Number(chatId);
            if (!chatId || isNaN(chatId)) return;
            
            // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç –≤ –º–∞—Å—Å–∏–≤–µ allChats –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const chatIndex = allChats.findIndex(c => c.id === chatId);
            if (chatIndex === -1) return;
            
            const chat = allChats[chatIndex];
            // –£–ë–†–ê–õ–ò –ü–†–û–í–ï–†–ö–£ - –¥–µ–ª–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            // if (!chat || !chat.assigned_manager_id) return; // –£–∂–µ –≤ –ø—É–ª–µ –∏–ª–∏ –Ω–µ –º–æ–π —á–∞—Ç
            
            // –ù–û–í–´–ô –ü–û–î–•–û–î: –£–¥–∞–ª—è–µ–º –∏–∑ Set –ª–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã—Ö —á–∞—Ç–æ–≤
            locallyTakenChats.delete(chatId);
            locallyTakenChatsTimestamps.delete(chatId);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
            const originalManagerId = chat.assigned_manager_id;
            const originalManagerName = chat.assigned_manager_name;
            
            // –ú–ì–ù–û–í–ï–ù–ù–û —É–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —á–∞—Ç–∞ –∏–∑ DOM –µ—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–ú–æ–∏ —á–∞—Ç—ã"
            if (currentSort === 'my') {
                const chatCard = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (chatCard) chatCard.remove();
            }
            
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞
            chat.assigned_manager_id = null;
            chat.assigned_manager_name = null;
            
            // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞)
            const myChatsCountEl = document.getElementById('my-chats-count');
            const poolCountEl = document.getElementById('pool-chats-count');
            if (myChatsCountEl || poolCountEl) {
                let myCount = 0, poolCount = 0;
                for (let i = 0; i < allChats.length; i++) {
                    const c = allChats[i];
                    if (c.status === 'completed' || c.status === 'blocked') continue;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ) –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏
                    const isMyChat = c.assigned_manager_id && 
                        (c.assigned_manager_id === currentUserId || c.assigned_manager_name === currentUsername);
                    if (isMyChat) myCount++;
                    else if (!c.assigned_manager_id) poolCount++;
                }
                if (myChatsCountEl) myChatsCountEl.textContent = `(${myCount})`;
                if (poolCountEl) poolCountEl.textContent = `(${poolCount})`;
            }
            
            // –ï—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–û–±—â–∏–π –ø—É–ª", –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ —Å–ø–∏—Å–æ–∫
            if (currentSort === 'all' && chat.status !== 'completed' && chat.status !== 'blocked') {
                applySort('all');
                renderChatsList();
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ (–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            fetch(`/api/chats/${chatId}/return`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include'
            }).then(response => {
                return response.json().then(data => ({ response, data })).catch(() => ({ response, data: {} }));
            }).then(({ response, data }) => {
                
                if (!response.ok) {
                    const errorMessage = data.error || `HTTP ${response.status}`;
                    const errorCode = data.code || 'UNKNOWN';
                    
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    if (chatIndex !== -1 && allChats[chatIndex]) {
                        allChats[chatIndex].assigned_manager_id = originalManagerId;
                        allChats[chatIndex].assigned_manager_name = originalManagerName;
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Ç –≤ DOM –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if (currentSort === 'my') {
                        applySort('my');
                        renderChatsList();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    let userMessage = '–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —á–∞—Ç–∞';
                    if (errorCode === 'NOT_ASSIGNED_TO_YOU') userMessage = '–≠—Ç–æ—Ç —á–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –¥—Ä—É–≥–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É';
                    else if (errorCode === 'ALREADY_IN_POOL') userMessage = '–ß–∞—Ç —É–∂–µ –≤ –ø—É–ª–µ';
                    else if (errorCode === 'NOT_FOUND') userMessage = '–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    else userMessage = errorMessage || '–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —á–∞—Ç–∞';
                    
                    showNotification(`‚ùå ${userMessage}`, 'error');
                    return;
                }
                
                // –£—Å–ø–µ—Ö - –ù–ï –≤—ã–∑—ã–≤–∞–µ–º loadChats, —á—Ç–æ–±—ã —á–∞—Ç –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è –æ–±—Ä–∞—Ç–Ω–æ
                // –î–∞–Ω–Ω—ã–µ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ
                // –û–±–Ω–æ–≤–ª—è–µ–º filteredChats, —á—Ç–æ–±—ã —á–∞—Ç –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
                if (currentSort === 'my') {
                    // –£–¥–∞–ª—è–µ–º —á–∞—Ç –∏–∑ filteredChats, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
                    const filteredIndex = filteredChats.findIndex(c => c.id === chatId);
                    if (filteredIndex !== -1) {
                        filteredChats.splice(filteredIndex, 1);
                    }
                } else if (currentSort === 'all') {
                    // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ filteredChats, –µ—Å–ª–∏ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø—É–ª–µ
                    if (chat.status !== 'completed' && chat.status !== 'blocked') {
                        const exists = filteredChats.find(c => c.id === chatId);
                        if (!exists) {
                            filteredChats.push(chat);
                            applySort('all');
                            renderChatsList();
                        }
                    }
                }
            }).catch(error => {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —á–∞—Ç–∞ –≤ –ø—É–ª:', error);
                
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (chatIndex !== -1 && allChats[chatIndex]) {
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                    loadChats(false, true).catch(() => {});
                }
                
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.', 'error');
                loadChats(false, true).catch(() => {});
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ product_url –¥–ª—è —á–∞—Ç–æ–≤ –±–µ–∑ –Ω–µ–≥–æ (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
        async function autoExtractProductUrls() {
            const chatsWithoutUrl = allChats.filter(chat => !chat.product_url || chat.product_url === null).length;
            
            if (chatsWithoutUrl === 0) {
                return; // –í—Å–µ —á–∞—Ç—ã —É–∂–µ –∏–º–µ—é—Ç product_url
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å API)
            const MAX_AUTO_EXTRACT = 20; // –ú–∞–∫—Å–∏–º—É–º 20 —á–∞—Ç–æ–≤ –∑–∞ —Ä–∞–∑
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ product_url –æ—Ç–∫–ª—é—á–µ–Ω–æ
            // –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã /api/chats/extract-all-product-urls –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å product_url –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            debugLog('[AUTO-EXTRACT] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ product_url –æ—Ç–∫–ª—é—á–µ–Ω–æ');
        }
        
        // –†—É—á–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –µ—â–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
        async function extractAllProductUrls() {
            // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
            await autoExtractProductUrls();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –≤ –ø—É–ª
        function returnAllChatsToPool() {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –º–æ–∏ —á–∞—Ç—ã
            const myChats = allChats.filter(chat => {
                const isMyChat = chat.assigned_manager_id && 
                    (chat.assigned_manager_id === currentUserId || 
                     chat.assigned_manager_name === currentUsername ||
                     (chat.assigned_manager_name && currentUsername && 
                      chat.assigned_manager_name.includes(currentUsername)));
                return isMyChat &&
                    chat.status !== 'completed' &&
                    chat.status !== 'blocked';
            });
            
            if (myChats.length === 0) {
                showNotification('‚ÑπÔ∏è –ù–µ—Ç —á–∞—Ç–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—É–ª', 'info');
                return;
            }
            
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            if (!confirm(`–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ ${myChats.length} —á–∞—Ç–æ–≤ –≤ –ø—É–ª?`)) {
                return;
            }
            
            // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —á–∞—Ç—ã –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ
            const chatIds = [];
            myChats.forEach(chat => {
                chatIds.push(chat.id);
                locallyTakenChats.delete(chat.id);
                locallyTakenChatsTimestamps.delete(chat.id);
                chat.assigned_manager_id = null;
                chat.assigned_manager_name = null;
            });
            
            // –ú–ì–ù–û–í–ï–ù–ù–û —É–¥–∞–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ DOM –µ—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–ú–æ–∏ —á–∞—Ç—ã"
            if (currentSort === 'my') {
                chatIds.forEach(chatId => {
                    const chatCard = document.querySelector(`[data-chat-id="${chatId}"]`);
                    if (chatCard) chatCard.remove();
                });
            }
            
            // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            initDOMCache();
            const myChatsCountEl = domCache.myChatsCount;
            const poolCountEl = domCache.poolChatsCount;
            if (myChatsCountEl || poolCountEl) {
                let myCount = 0, poolCount = 0;
                for (let i = 0; i < allChats.length; i++) {
                    const c = allChats[i];
                    if (c.status === 'completed' || c.status === 'blocked') continue;
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ) –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏
                    const isMyChat = c.assigned_manager_id && 
                        (c.assigned_manager_id === currentUserId || c.assigned_manager_name === currentUsername);
                    if (isMyChat) myCount++;
                    else if (!c.assigned_manager_id) poolCount++;
                }
                if (myChatsCountEl) myChatsCountEl.textContent = `(${myCount})`;
                if (poolCountEl) poolCountEl.textContent = `(${poolCount})`;
            }
            
            // –ï—Å–ª–∏ –º—ã –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–û–±—â–∏–π –ø—É–ª", –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç—ã –≤ —Å–ø–∏—Å–æ–∫
            if (currentSort === 'all') {
                applySort('all');
                renderChatsList();
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
            fetch('/api/chats/return-all', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include'
            }).then(response => {
                return response.json().then(data => ({ response, data })).catch(() => ({ response, data: {} }));
            }).then(({ response, data }) => {
                if (!response.ok) {
                    const errorMessage = data.error || `HTTP ${response.status}`;
                    
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    myChats.forEach(chat => {
                        const chatIndex = allChats.findIndex(c => c.id === chat.id);
                        if (chatIndex !== -1) {
                            allChats[chatIndex].assigned_manager_id = currentUserId;
                            allChats[chatIndex].assigned_manager_name = currentUsername;
                        }
                    });
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Ç—ã –≤ DOM
                    if (currentSort === 'my') {
                        applySort('my');
                        renderChatsList();
                    }
                    
                    showNotification(`‚ùå ${errorMessage}`, 'error');
                    return;
                }
                
                // –£—Å–ø–µ—Ö
                showNotification(`‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${data.count || myChats.length} —á–∞—Ç–æ–≤ –≤ –ø—É–ª`, 'success');
            }).catch(error => {
                debugError('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤—Å–µ—Ö —á–∞—Ç–æ–≤:', error);
                
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                myChats.forEach(chat => {
                    const chatIndex = allChats.findIndex(c => c.id === chat.id);
                    if (chatIndex !== -1) {
                        allChats[chatIndex].assigned_manager_id = currentUserId;
                        allChats[chatIndex].assigned_manager_name = currentUsername;
                    }
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Ç—ã –≤ DOM
                if (currentSort === 'my') {
                    applySort('my');
                    renderChatsList();
                }
                
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.', 'error');
            });
        }

        function restoreChat(chatId) {
            chatId = Number(chatId);
            if (!chatId || isNaN(chatId)) return;
            apiAction(`/api/chats/${chatId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({status: 'active'})
            }, '‚úÖ –ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', async () => {
                await loadChats();
                applySort('all');
                selectChat(chatId);
            });
        }

        function blockChat(chatId) {
            chatId = Number(chatId);
            if (!chatId || isNaN(chatId)) return;
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
            apiAction(`/api/chats/${chatId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({status: 'blocked'})
            }, 'üö´ –ß–∞—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', async () => {
                await loadChats();
                if (currentSort === 'blocked') {
                    applySort('all');
                }
            });
        }

        function unblockChat(chatId) {
            chatId = Number(chatId);
            if (!chatId || isNaN(chatId)) return;
            apiAction(`/api/chats/${chatId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({status: 'active'})
            }, 'üîì –ß–∞—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', async () => {
                await loadChats();
                applySort('all');
                selectChat(chatId);
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getPriorityIcon(priority) {
            const icons = {'urgent': 'üî•', 'new': 'üÜï', 'active': 'üí¨', 'delivery': 'üöö'};
            return icons[priority] || 'üí¨';
        }

        function getPriorityText(priority) {
            const texts = {'urgent': '–°–†–û–ß–ù–û', 'new': '–ù–û–í–´–ô', 'active': '–ê–ö–¢–ò–í', 'delivery': '–î–û–°–¢–ê–í–ö–ê'};
            return texts[priority] || '–ß–ê–¢';
        }

        /**
         * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
         * 
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞—Å—Å CSS –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞:
         * - urgent: >= 20 –º–∏–Ω—É—Ç (–∫—Ä–∞—Å–Ω—ã–π, –º–∏–≥–∞–µ—Ç)
         * - warning: >= 10 –º–∏–Ω—É—Ç (–∂–µ–ª—Ç—ã–π)
         * - normal: < 10 –º–∏–Ω—É—Ç (–∑–µ–ª–µ–Ω—ã–π)
         * 
         * @function getTimerClass
         * @param {number} timer - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
         * @returns {string} CSS –∫–ª–∞—Å—Å
         */
        function getTimerClass(timer) {
            if (timer >= 20) return 'urgent';
            if (timer >= 10) return 'warning';
            return 'normal';
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
         * 
         * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∏–Ω—É—Ç—ã –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
         * - –ú–µ–Ω—å—à–µ 60 –º–∏–Ω—É—Ç: "X –º–∏–Ω"
         * - –ë–æ–ª—å—à–µ 60 –º–∏–Ω—É—Ç: "X—á Y–º"
         * 
         * @function formatTimer
         * @param {number} minutes - –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö
         * @returns {string} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
         */
        function formatTimer(minutes) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ minutes - —ç—Ç–æ —á–∏—Å–ª–æ
            const mins = typeof minutes === 'number' ? minutes : (parseInt(minutes) || 0);
            
            if (mins === 0) return '0 –º–∏–Ω';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç –¥–ª—è –ø–µ—Ä–≤—ã—Ö 60 –º–∏–Ω—É—Ç
            if (mins < 60) {
                return `${Math.floor(mins)} –º–∏–Ω`;
            }
            
            // –î–ª—è –±–æ–ª–µ–µ —á–∞—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
            const hours = Math.floor(mins / 60);
            const remainingMins = Math.floor(mins % 60);
            
            // –ï—Å–ª–∏ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–Ω–∏
            if (hours >= 24) {
                const days = Math.floor(hours / 24);
                const remainingHours = hours % 24;
                if (remainingHours === 0 && remainingMins === 0) {
                    return `${days}–¥`;
                } else if (remainingHours === 0) {
                    return `${days}–¥ ${remainingMins}–º`;
                } else if (remainingMins === 0) {
                    return `${days}–¥ ${remainingHours}—á`;
                }
                return `${days}–¥ ${remainingHours}—á ${remainingMins}–º`;
            }
            
            // –ú–µ–Ω—å—à–µ 24 —á–∞—Å–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
            if (remainingMins === 0) {
                return `${hours}—á`;
            }
            return `${hours}—á ${remainingMins}–º`;
        }

        // –ö—ç—à –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        const lastSyncTime = new Map();
        const SYNC_COOLDOWN = 5000; // –ú–∏–Ω–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è–º–∏ –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞
        
        function startMessagesAutoRefresh() {
            if (messagesAutoRefreshInterval) clearInterval(messagesAutoRefreshInterval);
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ê–≤–∏—Ç–æ
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å debounce –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
            let lastMessageUpdate = 0;
            const MESSAGE_UPDATE_INTERVAL = 10000; // 10 —Å–µ–∫—É–Ω–¥ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            let consecutiveErrors = 0;
            const MAX_CONSECUTIVE_ERRORS = 3;
            
            messagesAutoRefreshInterval = setInterval(() => {
                if (currentChatId && document.visibilityState === 'visible') {
                    const now = Date.now();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∏–º–∞
                    if (now - lastMessageUpdate >= MESSAGE_UPDATE_INTERVAL) {
                        lastMessageUpdate = now;
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                        loadChatMessages(currentChatId, 'refresh').then(() => {
                            consecutiveErrors = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                        }).catch((error) => {
                            consecutiveErrors++;
                            if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
                                debugLog('[AUTO REFRESH] –ú–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª');
                                // –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 30 —Å–µ–∫—É–Ω–¥
                                clearInterval(messagesAutoRefreshInterval);
                                messagesAutoRefreshInterval = setInterval(() => {
                                    if (currentChatId && document.visibilityState === 'visible') {
                                        loadChatMessages(currentChatId, 'refresh').then(() => {
                                            consecutiveErrors = 0;
                                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
                                            clearInterval(messagesAutoRefreshInterval);
                                            startMessagesAutoRefresh();
                                        });
                                    }
                                }, 30000);
                            }
                        });
                    }
                }
            }, MESSAGE_UPDATE_INTERVAL);
        }

        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ response_timer –¥–ª—è –≤—Å–µ—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
         * –í—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –∏ –±–∞–∑–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
         * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É –¥–∞—Ç—ã
         */
        // –ö–µ—à –¥–ª—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–π–º–µ—Ä–æ–≤ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ)
        let chatCardsCache = null;
        let cacheTimestamp = 0;
        const CACHE_REFRESH_INTERVAL = 5000; // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        
        function updateResponseTimers() {
            if (!allChats || allChats.length === 0) return;
            
            const now = Date.now();
            const nowDate = new Date(now);
            const today = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate()).getTime();
            
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
            if (!chatCardsCache || (now - cacheTimestamp) > CACHE_REFRESH_INTERVAL) {
                const container = document.querySelector('.chats-list');
                if (!container) return;
                
                chatCardsCache = new Map();
                container.querySelectorAll('.chat-card').forEach(card => {
                    const chatId = card.getAttribute('data-chat-id');
                    if (chatId) {
                        chatCardsCache.set(Number(chatId), {
                            card: card,
                            timerElement: card.querySelector('.response-time')
                        });
                    }
                });
                cacheTimestamp = now;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —á–∞—Ç—ã (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Ç–æ–≤)
            const visibleChats = allChats.filter(chat => {
                if (chat.status === 'completed' || chat.status === 'blocked') return false;
                const cached = chatCardsCache?.get(chat.id);
                return cached && cached.card.offsetParent !== null; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–π–º–µ—Ä–æ–≤
            visibleChats.forEach(chat => {
                // –ï—Å–ª–∏ —É —á–∞—Ç–∞ –Ω–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ
                if (!chat._timerBaseTime) {
                    chat._timerBaseTime = now;
                    chat._timerBaseValue = chat.response_timer || 0;
                    chat._timerBaseDate = today;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –¥–∞—Ç–∞ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const baseDate = chat._timerBaseDate || today;
                const dateChanged = baseDate !== today;
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (dateChanged) {
                    chat._timerBaseTime = now;
                    chat._timerBaseValue = chat.response_timer || 0;
                    chat._timerBaseDate = today;
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–æ—à–ª–æ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                const timeDiff = now - chat._timerBaseTime;
                const minutesPassed = Math.floor(timeDiff / 60000);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º response_timer –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è + –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                let newTimer = (chat._timerBaseValue || 0) + minutesPassed;
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –Ω–µ—Ä–µ–∞–ª—å–Ω–æ –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                if (newTimer < 0 || newTimer > 10000) {
                    chat._timerBaseTime = now;
                    chat._timerBaseValue = chat.response_timer || 0;
                    chat._timerBaseDate = today;
                    newTimer = chat._timerBaseValue || 0;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ —Ü–µ–ª—É—é –º–∏–Ω—É—Ç—É –∏–ª–∏ –±–æ–ª—å—à–µ
                const currentTimer = chat.response_timer || 0;
                if (Math.abs(newTimer - currentTimer) >= 1 || dateChanged) {
                    chat.response_timer = Math.max(0, newTimer);
                    chat._timerBaseTime = now;
                    chat._timerBaseValue = chat.response_timer;
                    chat._timerBaseDate = today;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const cached = chatCardsCache?.get(chat.id);
                    if (cached) {
                        const chatCard = cached.card;
                        const timerElement = cached.timerElement;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –º–∏–≥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                        if (chat.response_timer >= 20) {
                            chatCard.classList.add('blink-red');
                        } else {
                            chatCard.classList.remove('blink-red');
                        }
                        
                        if (timerElement && chat.response_timer > 0) {
                            const timerClass = getTimerClass(chat.response_timer);
                            const timerText = formatTimer(chat.response_timer);
                            const isUrgent = chat.response_timer >= 20;
                            timerElement.className = `response-time ${timerClass} ${isUrgent ? 'blink' : ''}`;
                            timerElement.textContent = `‚è±Ô∏è ${timerText}`;
                            timerElement.style.color = isUrgent ? '#ef4444' : '';
                            timerElement.style.fontWeight = isUrgent ? '700' : '';
                            timerElement.style.display = '';
                        } else if (timerElement && chat.response_timer === 0) {
                            timerElement.style.display = 'none';
                        }
                    }
                }
            });
        }

        /**
         * –°–±—Ä–æ—Å –±–∞–∑–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
         * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–º–µ–Ω—ã –¥–∞—Ç—ã
         */
        function resetTimerBaseTimes() {
            const now = Date.now();
            const nowDate = new Date(now);
            const today = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate()).getTime();
            
            allChats.forEach(chat => {
                chat._timerBaseTime = now;
                chat._timerBaseValue = chat.response_timer || 0;
                chat._timerBaseDate = today;
            });
        }

        window.showNotification = function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const normalizedType = ['success', 'error'].includes(type) ? type : 'info';
            const icons = {success: '‚úÖ', error: '‚ö†Ô∏è', info: '‚ÑπÔ∏è'};
            const safeMessage = escapeHtml(message);
            const toast = document.createElement('div');
            toast.className = `toast toast-${normalizedType}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[normalizedType]}</span>
                <span>${safeMessage}</span>
                <button class="toast-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">√ó</button>
            `;
            const removeToast = () => toast.remove();
            toast.querySelector('.toast-close').addEventListener('click', removeToast);
            container.appendChild(toast);
            setTimeout(removeToast, 3500);
        }

        function updateSendAvailability() {
            const sendButton = document.querySelector('.send-button');
            const textarea = document.getElementById('message-text');
            const warning = document.getElementById('avito-warning');
            const disabled = !currentChatHasAvito || !currentChatId || messagesLoading;
            if (sendButton) sendButton.disabled = disabled;
            if (textarea) textarea.disabled = disabled;
            if (warning) warning.style.display = disabled ? 'block' : 'none';
            document.querySelectorAll('.quick-action').forEach(btn => {
                btn.classList.toggle('is-disabled', messagesLoading);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // –Ø–í–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('message-text');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 140) + 'px';
                });

                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            const searchInput = document.getElementById('chat-search');
            if (searchInput) {
                searchInput.addEventListener('input', (event) => handleSearchInput(event.target.value));
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
            document.querySelectorAll('.filter-chip[data-sort]').forEach(chip => {
                chip.addEventListener('click', () => {
                    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤)
                    applySort(chip.dataset.sort);
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–æ–≤—ã–µ/—Å—Ç–∞—Ä—ã–µ)
            document.querySelectorAll('.sort-chip[data-sort-order]').forEach(chip => {
                chip.addEventListener('click', () => {
                    currentSortOrder = chip.dataset.sortOrder;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
                    document.querySelectorAll('.sort-chip[data-sort-order]').forEach(c => {
                        c.classList.toggle('active', c.dataset.sortOrder === currentSortOrder);
                    });
                    applySort(currentSort); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä —Å –Ω–æ–≤—ã–º –ø–æ—Ä—è–¥–∫–æ–º
                });
            });

            document.addEventListener('click', function(event) {
                if (!event.target.closest('#quick-replies-menu') && !event.target.closest('.quick-action')) {
                    document.getElementById('quick-replies-menu').classList.remove('active');
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            const urlChatId = urlParams.get('chat_id');
            if (urlChatId) {
                const parsedId = Number(urlChatId);
                if (!Number.isNaN(parsedId)) {
                    initialChatIdFromUrl = parsedId;
                }
            }

            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–µ—à –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const cachedChats = loadChatsFromCache();
            if (cachedChats && cachedChats.length > 0) {
                allChats = cachedChats;
                resetTimerBaseTimes();
                applySort(currentSort);
                renderChatsList();
            }
            
            // ========== –£–ú–ù–´–ï –§–ò–õ–¨–¢–†–´ ==========
            function initializeSmartFilters() {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –º–∞–≥–∞–∑–∏–Ω–∞–º–∏ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏
                const shopSelect = document.getElementById('filter-shop');
                const managerSelect = document.getElementById('filter-manager');
                
                if (shopSelect) {
                    const shops = [...new Map(allChats.map(c => [c.shop_id, { id: c.shop_id, name: c.shop_name }]).filter(s => s[1].id && s[1].name))].values();
                    shops.forEach(shop => {
                        const option = document.createElement('option');
                        option.value = shop.id;
                        option.textContent = shop.name;
                        shopSelect.appendChild(option);
                    });
                }
                
                if (managerSelect) {
                    const managers = [...new Map(allChats.map(c => [c.assigned_manager_id, { id: c.assigned_manager_id, name: c.assigned_manager_name }]).filter(m => m[1].id && m[1].name))].values();
                    managers.forEach(manager => {
                        const option = document.createElement('option');
                        option.value = manager.id;
                        option.textContent = manager.name;
                        managerSelect.appendChild(option);
                    });
                }
            }
            
            function applySmartFilters() {
                applySort(currentSort);
            }
            
            // ========== –ú–ê–°–°–û–í–´–ï –î–ï–ô–°–¢–í–ò–Ø ==========
            const selectedChats = new Set();
            
            function toggleChatSelection(chatId) {
                const checkbox = document.querySelector(`.chat-select-checkbox[data-chat-id="${chatId}"]`);
                if (!checkbox) return;
                
                if (checkbox.checked) {
                    selectedChats.add(chatId);
                } else {
                    selectedChats.delete(chatId);
                }
                
                updateBulkActionsButton();
            }
            
            function updateBulkActionsButton() {
                const btn = document.getElementById('bulk-actions-btn');
                const countSpan = document.getElementById('selected-count');
                
                if (selectedChats.size > 0) {
                    if (btn) btn.style.display = 'inline-flex';
                    if (countSpan) countSpan.textContent = selectedChats.size;
                } else {
                    if (btn) btn.style.display = 'none';
                }
            }
            
            function showBulkActionsMenu() {
                if (selectedChats.size === 0) return;
                
                const action = prompt(`–í—ã–±—Ä–∞–Ω–æ —á–∞—Ç–æ–≤: ${selectedChats.size}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n1 - –í–∑—è—Ç—å –∏–∑ –ø—É–ª–∞\n2 - –í–µ—Ä–Ω—É—Ç—å –≤ –ø—É–ª\n3 - –ó–∞–≤–µ—Ä—à–∏—Ç—å\n4 - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å\n5 - –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä`);
                if (!action) return;
                
                switch(action) {
                    case '1': bulkTakeChats(); break;
                    case '2': bulkReturnChats(); break;
                    case '3': bulkCompleteChats(); break;
                    case '4': bulkBlockChats(); break;
                    case '5': clearSelection(); break;
                }
            }
            
            function bulkTakeChats() {
                const chatIds = Array.from(selectedChats);
                chatIds.forEach(id => takeChatFromPool(id));
                clearSelection();
            }
            
            function bulkReturnChats() {
                const chatIds = Array.from(selectedChats);
                chatIds.forEach(id => returnChatToPool(id));
                clearSelection();
            }
            
            function bulkCompleteChats() {
                const chatIds = Array.from(selectedChats);
                chatIds.forEach(id => markAsCompleted(id));
                clearSelection();
            }
            
            function bulkBlockChats() {
                const chatIds = Array.from(selectedChats);
                chatIds.forEach(id => blockChat(id));
                clearSelection();
            }
            
            function clearSelection() {
                selectedChats.clear();
                document.querySelectorAll('.chat-select-checkbox').forEach(cb => cb.checked = false);
                updateBulkActionsButton();
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ locallyTakenChats
            // –û—á–∏—â–∞–µ–º —á–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤–∑—è—Ç—ã –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
            // (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è, –≤–µ—Ä–æ—è—Ç–Ω–æ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)
            setInterval(() => {
                const now = Date.now();
                const MAX_LOCAL_AGE = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç
                
                locallyTakenChatsTimestamps.forEach((timestamp, chatId) => {
                    if (now - timestamp > MAX_LOCAL_AGE) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
                        const chat = allChats.find(c => c.id === chatId);
                        if (!chat || !chat.assigned_manager_id || chat.assigned_manager_id !== currentUserId) {
                            // –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª - —É–¥–∞–ª—è–µ–º –∏–∑ Set
                            locallyTakenChats.delete(chatId);
                            locallyTakenChatsTimestamps.delete(chatId);
                            debugLog(`[CLEANUP] –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–π —á–∞—Ç ${chatId} (—Å—Ç–∞—Ä—à–µ ${MAX_LOCAL_AGE}–º—Å)`);
                        } else {
                            // –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª - —É–¥–∞–ª—è–µ–º timestamp, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ Set –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
                            locallyTakenChatsTimestamps.delete(chatId);
                        }
                    }
                });
            }, 60000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (online/offline)
            let isOnline = navigator.onLine;
            const connectionIndicator = document.createElement('div');
            connectionIndicator.id = 'connection-indicator';
            connectionIndicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.875rem;
                z-index: 10000;
                display: none;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
            document.body.appendChild(connectionIndicator);
            
            function updateConnectionIndicator() {
                if (isOnline) {
                    connectionIndicator.style.display = 'none';
                } else {
                    connectionIndicator.style.display = 'block';
                    connectionIndicator.style.background = '#ef4444';
                    connectionIndicator.style.color = 'white';
                    connectionIndicator.textContent = '‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                }
            }
            
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionIndicator();
                showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                if (typeof window.loadChats === 'function') {
                    window.loadChats(false, true);
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionIndicator();
                showNotification('‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', 'warning');
            });
            
            updateConnectionIndicator();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            initializeSmartFilters();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ –≤ –ø—É–ª"
            const returnAllBtn = document.getElementById('return-all-btn');
            if (returnAllBtn) {
                if (currentSort === 'my') {
                    returnAllBtn.classList.remove('hidden');
                } else {
                    returnAllBtn.classList.add('hidden');
                }
            }
            
            debugLog('[INIT] –í—ã–∑—ã–≤–∞–µ–º loadChats(true) –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏...');
            try {
                loadChats(true, cachedChats && cachedChats.length > 0); // –¢–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–µ—à
            } catch (error) {
                debugError('[INIT] –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–∑–æ–≤–µ loadChats:', error);
            }
            
            // ========== –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô ==========
            // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            
            let lastFullSync = Date.now();
            
            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            const CHATS_SYNC_INTERVAL = 30000; // 30 —Å–µ–∫—É–Ω–¥ - –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            const TIMER_UPDATE_INTERVAL = 30000; // 30 —Å–µ–∫—É–Ω–¥ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏)
            
            // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            let isSyncing = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
            async function performFullSync() {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (isSyncing) {
                    debugLog('[AUTO SYNC] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                    return;
                }
                
                // –í–ê–ñ–ù–û: –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —á–∞—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
                if (batchTakeQueue.length > 0 || locallyTakenChats.size > 0) {
                    debugLog('[AUTO SYNC] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é: –µ—Å—Ç—å —á–∞—Ç—ã –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –≤–∑—è—Ç—ã–µ —á–∞—Ç—ã');
                    return;
                }
                
                isSyncing = true;
                debugLog('[AUTO SYNC] –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–∞—Ç–æ–≤...');
                
                try {
                    const syncResponse = await fetch('/api/chats/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({}),
                        signal: AbortSignal.timeout(30000) // –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
                    });
                    
                    if (syncResponse.ok) {
                        const syncData = await syncResponse.json();
                        debugLog('[AUTO SYNC] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', syncData);
                        
                        // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                        const savedLocalChanges = new Map();
                        locallyTakenChats.forEach(chatId => {
                            const chatIndex = allChats.findIndex(c => c.id === chatId);
                            if (chatIndex !== -1) {
                                savedLocalChanges.set(chatId, {
                                    assigned_manager_id: allChats[chatIndex].assigned_manager_id,
                                    assigned_manager_name: allChats[chatIndex].assigned_manager_name
                                });
                            }
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        if (typeof window.loadChats === 'function') {
                            await window.loadChats(false, true);
                            
                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Ö –Ω–µ –æ–±–Ω–æ–≤–∏–ª
                            savedLocalChanges.forEach((data, chatId) => {
                                const chatIndex = allChats.findIndex(c => c.id === chatId);
                                if (chatIndex !== -1) {
                                    const chat = allChats[chatIndex];
                                    if (!chat.assigned_manager_id || chat.assigned_manager_id === null) {
                                        chat.assigned_manager_id = data.assigned_manager_id || currentUserId;
                                        chat.assigned_manager_name = data.assigned_manager_name || currentUsername;
                                        debugLog('[AUTO SYNC] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞', chatId);
                                    }
                                }
                            });
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            if (typeof applySort === 'function') {
                                applySort(currentSort, true);
                            } else {
                                // –ï—Å–ª–∏ applySort –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                                if (typeof renderChatsList === 'function') {
                                    renderChatsList();
                                }
                            }
                        }
                    } else {
                        debugLog('[AUTO SYNC] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:', syncResponse.status);
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        debugLog('[AUTO SYNC] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    }
                } finally {
                    isSyncing = false;
                }
            }
            
            // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            // –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            const FULL_SYNC_INTERVAL = 30000; // 30 —Å–µ–∫—É–Ω–¥
            const autoUpdateInterval = setInterval(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∏–º–∞
                if (document.visibilityState !== 'visible') {
                    return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –≤–∏–¥–Ω–∞
                }
                
                // –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                performFullSync();
            }, FULL_SYNC_INTERVAL);
            
            // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ä–∞–∑—É –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    performFullSync();
                } else if (document.visibilityState === 'hidden') {
                    // –ü—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
                    if (batchTakeQueue.length > 0) {
                        flushBatchTakeQueue();
                    }
                }
            });
            
            // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
            window.addEventListener('beforeunload', () => {
                if (batchTakeQueue.length > 0) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º navigator.sendBeacon –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                    navigator.sendBeacon('/api/chats/batch-take', JSON.stringify({ chat_ids: batchTakeQueue }));
                }
            });
            
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            let lastTimerUpdate = 0;
            let timerUpdateScheduled = false;
            
            function scheduleTimerUpdate() {
                if (timerUpdateScheduled) return;
                timerUpdateScheduled = true;
                
                requestAnimationFrame(() => {
                    const now = Date.now();
                    if (now - lastTimerUpdate >= TIMER_UPDATE_INTERVAL) {
                        lastTimerUpdate = now;
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Ç–∞–π–º–µ—Ä—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                        updateResponseTimers();
                    }
                    timerUpdateScheduled = false;
                });
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
            setInterval(scheduleTimerUpdate, TIMER_UPDATE_INTERVAL);
            
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–µ—à–∞)
            if (!cachedChats || cachedChats.length === 0) {
                setTimeout(() => {
                    if (allChats.length === 0 && typeof window.loadChats === 'function') {
                        window.loadChats(true);
                    }
                }, 2000);
            }
        });
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('[GLOBAL ERROR]', e.error, e.message, e.filename, e.lineno);
        });
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', function(e) {
            console.error('[UNHANDLED PROMISE REJECTION]', e.reason);
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å
        async function loadListingToSidebar(chatId) {
            console.log('[LISTING SIDEBAR] –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞:', chatId);
            const sidebarContent = document.getElementById('listing-sidebar-content');
            if (!sidebarContent) {
                console.error('[LISTING SIDEBAR] –≠–ª–µ–º–µ–Ω—Ç listing-sidebar-content –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (!chatId) {
                console.log('[LISTING SIDEBAR] chatId –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                sidebarContent.innerHTML = `
                    <div class="listing-sidebar-empty">
                        <div class="listing-sidebar-empty-icon">üì¶</div>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p>
                    </div>
                `;
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —á–∞—Ç–∞ product_url
            const chat = allChats.find(c => Number(c.id) === chatId);
            if (!chat || !chat.product_url) {
                console.log('[LISTING SIDEBAR] –£ —á–∞—Ç–∞ –Ω–µ—Ç product_url, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π...');
                sidebarContent.innerHTML = `
                    <div class="listing-sidebar-empty">
                        <div class="listing-sidebar-empty-icon">‚è≥</div>
                        <p>–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö...</p>
                    </div>
                `;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å product_url –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
                try {
                    const extractResponse = await fetch(`/api/chats/${chatId}/extract-product-url`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ (200 –∏–ª–∏ 404)
                    let extractData = null;
                    try {
                        extractData = await extractResponse.json();
                    } catch (jsonError) {
                        console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç–≤–µ—Ç–∞:', jsonError);
                        extractData = { success: false, error: 'Invalid response format' };
                    }
                    
                    if (extractResponse.ok || extractResponse.status === 200) {
                        if (extractData && extractData.success && extractData.product_url) {
                            console.log('[LISTING SIDEBAR] product_url —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω:', extractData.product_url);
                            // –û–±–Ω–æ–≤–ª—è–µ–º chat –≤ allChats
                            if (chat) {
                                chat.product_url = extractData.product_url;
                            }
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            await loadChats(false, true);
                            // –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º loadListingToSidebar —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                            setTimeout(() => loadListingToSidebar(chatId), 500);
                            return;
                        } else {
                            // product_url –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
                            console.log('[LISTING SIDEBAR] product_url –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:', extractData?.message || extractData?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞');
                            sidebarContent.innerHTML = `
                                <div class="listing-sidebar-empty">
                                    <div class="listing-sidebar-empty-icon">üì¶</div>
                                    <p>–£ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                                    <p style="font-size: 0.875rem; opacity: 0.7; margin-top: 0.5rem;">–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</p>
                                </div>
                            `;
                            return;
                        }
                    } else if (extractResponse.status === 404) {
                        // –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        console.log('[LISTING SIDEBAR] Endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —á–∞—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', extractResponse.status);
                        sidebarContent.innerHTML = `
                            <div class="listing-sidebar-empty">
                                <div class="listing-sidebar-empty-icon">üì¶</div>
                                <p>–£ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                            </div>
                        `;
                        return;
                    } else {
                        // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
                        console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ product_url:', extractResponse.status, extractData);
                        sidebarContent.innerHTML = `
                            <div class="listing-sidebar-empty">
                                <div class="listing-sidebar-empty-icon">üì¶</div>
                                <p>–£ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                                <p style="font-size: 0.875rem; opacity: 0.7; margin-top: 0.5rem;">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                            </div>
                        `;
                        return;
                    }
                } catch (extractError) {
                    console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–∑–≤–ª–µ—á—å product_url:', extractError);
                    sidebarContent.innerHTML = `
                        <div class="listing-sidebar-empty">
                            <div class="listing-sidebar-empty-icon">üì¶</div>
                            <p>–£ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</p>
                        </div>
                    `;
                    return;
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            sidebarContent.innerHTML = `
                <div class="listing-sidebar-empty">
                    <div class="listing-sidebar-empty-icon">‚è≥</div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è...</p>
                </div>
            `;
            
            try {
                console.log('[LISTING SIDEBAR] –ó–∞–ø—Ä–æ—Å –∫ API:', `/api/chats/${chatId}/listing`);
                const response = await fetch(`/api/chats/${chatId}/listing`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('[LISTING SIDEBAR] –û—Ç–≤–µ—Ç –æ—Ç API:', response.status, response.statusText);
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', jsonError);
                    data = {};
                }
                
                console.log('[LISTING SIDEBAR] –û—Ç–≤–µ—Ç –æ—Ç API:', response.status, data);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞, –Ω–æ –µ—Å—Ç—å product_url, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (!response.ok || data.error) {
                    const errorMessage = data.error || `HTTP ${response.status}`;
                    console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ API:', errorMessage);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å product_url, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã —Å—Å—ã–ª–∫—É
                    if (data.product_url) {
                        const urlToShow = data.product_url;
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ URL
                        let title = '–û–±—ä—è–≤–ª–µ–Ω–∏–µ';
                        try {
                            const urlParts = urlToShow.split('/').filter(p => p);
                            if (urlParts.length > 0) {
                                const lastPart = urlParts[urlParts.length - 1];
                                let extractedTitle = lastPart.replace(/_\d+$/, '');
                                extractedTitle = extractedTitle.replace(/_/g, ' ').replace(/-/g, ' ');
                                extractedTitle = extractedTitle.replace(/\s+/g, ' ').trim();
                                if (extractedTitle.length > 0) {
                                    extractedTitle = extractedTitle.split(' ')
                                        .map(word => {
                                            if (/^\d+/.test(word) || word.length <= 2) {
                                                return word;
                                            }
                                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                                        })
                                        .join(' ');
                                    title = extractedTitle.length > 80 ? extractedTitle.substring(0, 80) + '...' : extractedTitle;
                                }
                            }
                        } catch (e) {
                            console.warn('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ URL:', e);
                        }
                        
                        sidebarContent.innerHTML = `
                            <div class="listing-card">
                                <h3 class="listing-card-title">${escapeHtml(title)}</h3>
                                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); margin-bottom: 1rem; font-size: 0.875rem; color: #ef4444;">
                                    ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                                </div>
                                <div class="listing-card-actions">
                                    <a href="${escapeHtml(urlToShow)}" target="_blank" rel="noopener noreferrer" class="listing-card-link">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Avito ‚Üí</a>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ—Ç product_url, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    sidebarContent.innerHTML = `
                        <div class="listing-sidebar-empty">
                            <div class="listing-sidebar-empty-icon">‚ö†Ô∏è</div>
                            <p>${escapeHtml(errorMessage)}</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('[LISTING SIDEBAR] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                console.log('[LISTING SIDEBAR] listing –æ–±—ä–µ–∫—Ç:', data.listing);
                console.log('[LISTING SIDEBAR] –ö–ª—é—á–∏ –≤ listing:', data.listing ? Object.keys(data.listing) : '–Ω–µ—Ç listing');
                
                const listing = data.listing || {};
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                let images = listing.images || listing.photos || listing.pictures || [];
                // –ï—Å–ª–∏ images - –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤, –∏–∑–≤–ª–µ–∫–∞–µ–º URL
                if (images.length > 0 && typeof images[0] === 'object') {
                    images = images.map(img => 
                        img.url || 
                        img.urls?.large || 
                        img.urls?.medium || 
                        img.urls?.small ||
                        img.full ||
                        img.original ||
                        img.src ||
                        img
                    ).filter(url => url);
                }
                // –ï—Å–ª–∏ images - –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ URL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                let title = listing.title || listing.name;
                
                // –ï—Å–ª–∏ title –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ URL
                if (!title) {
                    const urlToParse = listing.url || data.product_url;
                    if (urlToParse) {
                        try {
                            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ URL (–ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª—ç—à–∞)
                            const urlParts = urlToParse.split('/').filter(p => p);
                            if (urlParts.length > 0) {
                                const lastPart = urlParts[urlParts.length - 1];
                                
                                // –£–±–∏—Ä–∞–µ–º ID –∏–∑ –∫–æ–Ω—Ü–∞, –µ—Å–ª–∏ –µ—Å—Ç—å (—Ñ–æ—Ä–º–∞—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ_1234567890)
                                let extractedTitle = lastPart.replace(/_\d+$/, '');
                                
                                // –ó–∞–º–µ–Ω—è–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –∏ –¥–µ—Ñ–∏—Å—ã –Ω–∞ –ø—Ä–æ–±–µ–ª—ã (–í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —ç—Ç–æ –î–û –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
                                extractedTitle = extractedTitle.replace(/_/g, ' ').replace(/-/g, ' ');
                                
                                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                                extractedTitle = extractedTitle.replace(/\s+/g, ' ').trim();
                                
                                // –£–ª—É—á—à–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¥–µ–ª–∞–µ–º –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–≤—ã–µ –±—É–∫–≤—ã —Å–ª–æ–≤
                                if (extractedTitle.length > 0) {
                                    extractedTitle = extractedTitle.split(' ')
                                        .map(word => {
                                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —á–∏—Å–ª–∞ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞ (–Ω–æ –Ω–µ –º–µ–Ω—è–µ–º –∏—Ö)
                                            if (/^\d+/.test(word) || word.length <= 2) {
                                                return word;
                                            }
                                            // –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∑–∞–≥–ª–∞–≤–Ω–æ–π, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ—á–Ω—ã–º–∏
                                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                                        })
                                        .join(' ');
                                    
                                    title = extractedTitle;
                                    if (title.length > 80) {
                                        title = title.substring(0, 80) + '...';
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ URL:', e);
                        }
                    }
                }
                title = title || '–û–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
                let price = listing.price;
                if (price === null || price === undefined || price === '') {
                    // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ price_info
                    if (listing.price_info) {
                        if (typeof listing.price_info === 'object') {
                            price = listing.price_info.value || listing.price_info.price;
                        } else {
                            price = listing.price_info;
                        }
                    }
                }
                if (price === null || price === undefined || price === '') {
                    // –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                    price = listing.priceValue || listing.price_value || listing.price_string || 0;
                }
                
                // –ï—Å–ª–∏ price_string –µ—Å—Ç—å, –Ω–æ price –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
                if ((price === 0 || price === null || price === undefined) && listing.price_string) {
                    const priceMatch = listing.price_string.toString().match(/(\d[\d\s]*)/);
                    if (priceMatch) {
                        try {
                            price = parseFloat(priceMatch[1].replace(/\s/g, ''));
                        } catch (e) {
                            console.warn('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ price_string:', e);
                        }
                    }
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
                price = typeof price === 'string' ? parseFloat(price.replace(/\s/g, '')) || 0 : (Number(price) || 0);
                
                const description = listing.description || listing.text || listing.content || '';
                const address = listing.address || listing.location?.name || listing.location?.address || listing.location?.fullName || listing.location?.full_name || '';
                const category = listing.category || {};
                const categoryName = (typeof category === 'object' ? (category.name || category.title || category.label) : category) || '';
                const status = listing.status || listing.state || '';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –±–æ–ª—å—à–µ 0
                let formattedPrice = '';
                if (price > 0) {
                    formattedPrice = new Intl.NumberFormat('ru-RU', {
                        style: 'currency',
                        currency: 'RUB',
                        minimumFractionDigits: 0
                    }).format(price);
                }
                
                console.log('[LISTING SIDEBAR] –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', { 
                    title, 
                    price, 
                    formattedPrice,
                    price_string: listing.price_string,
                    price_info: listing.price_info,
                    status, 
                    imagesCount: images.length,
                    hasDescription: !!description,
                    address,
                    categoryName
                });
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML - —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: –æ–¥–Ω–æ —Ñ–æ—Ç–æ, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, —Å—Å—ã–ª–∫–∞
                const mainImage = images.length > 0 ? images[0] : null;
                const urlToShow = listing.url || data.product_url;
                
                sidebarContent.innerHTML = `
                    <div class="listing-card">
                        ${mainImage ? `<img src="${escapeHtml(mainImage)}" alt="${escapeHtml(title)}" class="listing-card-image" loading="lazy" onerror="this.style.display='none'">` : ''}
                        <h3 class="listing-card-title">${escapeHtml(title)}</h3>
                        ${formattedPrice ? `<div class="listing-card-price">${formattedPrice}</div>` : ''}
                        <div class="listing-card-actions">
                            ${urlToShow ? `<a href="${escapeHtml(urlToShow)}" target="_blank" rel="noopener noreferrer" class="listing-card-link">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Avito ‚Üí</a>` : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[LISTING SIDEBAR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                sidebarContent.innerHTML = `
                    <div class="listing-sidebar-empty">
                        <div class="listing-sidebar-empty-icon">‚ö†Ô∏è</div>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">${escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}</p>
                    </div>
                `;
            }
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.loadListingToSidebar = loadListingToSidebar;
        
    </script>
{% endblock %}

#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Passenger –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

# –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞ (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è passenger_wsgi.py)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Passenger –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $SCRIPT_DIR"
echo ""

# –ú–µ—Ç–æ–¥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tmp/restart.txt
echo "1Ô∏è‚É£ –ú–µ—Ç–æ–¥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tmp/restart.txt"
mkdir -p tmp

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
rm -f tmp/restart.txt
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
cat > tmp/restart.txt << EOF
# Passenger restart trigger
# Touch this file to restart the application
# Last restarted: $TIMESTAMP
EOF

echo "   ‚úÖ –§–∞–π–ª tmp/restart.txt —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω"
ls -lh tmp/restart.txt
echo ""

# –ú–µ—Ç–æ–¥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ passenger_wsgi.py
echo "2Ô∏è‚É£ –ú–µ—Ç–æ–¥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ passenger_wsgi.py"
if [ -f "passenger_wsgi.py" ]; then
    touch passenger_wsgi.py
    echo "   ‚úÖ passenger_wsgi.py –æ–±–Ω–æ–≤–ª–µ–Ω"
    ls -lh passenger_wsgi.py
else
    echo "   ‚ö†Ô∏è  passenger_wsgi.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ú–µ—Ç–æ–¥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ backend/app.py (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ)
echo "3Ô∏è‚É£ –ú–µ—Ç–æ–¥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ backend/app.py"
if [ -f "backend/app.py" ]; then
    touch backend/app.py
    echo "   ‚úÖ backend/app.py –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    echo "   ‚ö†Ô∏è  backend/app.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ú–µ—Ç–æ–¥ 4: –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å passenger-config (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
echo "4Ô∏è‚É£ –ú–µ—Ç–æ–¥ 4: –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å passenger-config"
if command -v passenger-config &> /dev/null; then
    echo "   –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ passenger-config..."
    passenger-config restart-app "$SCRIPT_DIR" 2>&1 || echo "   ‚ö†Ô∏è  passenger-config –Ω–µ —Å–º–æ–≥ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
else
    echo "   ‚ÑπÔ∏è  passenger-config –Ω–µ –Ω–∞–π–¥–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ö–æ—Å—Ç–∏–Ω–≥–∞—Ö)"
fi
echo ""

echo "============================================================"
echo "‚úÖ –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê –ò–ù–ò–¶–ò–ò–†–û–í–ê–ù–ê"
echo "============================================================"
echo ""
echo "‚è≥ Passenger –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º HTTP –∑–∞–ø—Ä–æ—Å–µ"
echo ""
echo "üí° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:"
echo "   1. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10-30 —Å–µ–∫—É–Ω–¥"
echo "   2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f backend/logs/app.log"
echo ""
echo "üìù –ï—Å–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: chmod 644 tmp/restart.txt"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞"
echo "   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–æ—Å—Ç–∏–Ω–≥–æ–º"
echo ""
